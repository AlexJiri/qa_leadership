<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QA Leadership Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .feedback-result-card {
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .feedback-result-card:hover {
      transform: translateY(-2px);
    }
    
    .feedback-result-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    @keyframes starGlow {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    /* Toggle styles for meetings */
    .year-toggle, .quarter-toggle{ 
      display:inline-block; 
      margin-right:8px; 
      font-size:16px; 
      transition:transform 0.3s ease;
      user-select:none;
      cursor: pointer;
    }
    .year-toggle:hover, .quarter-toggle:hover{ 
      transform: scale(1.1);
    }
    h2:hover .year-toggle, .quarter-title:hover .quarter-toggle{ 
      transform: scale(1.15);
    }
    
    /* Year content styling */
    .year-content {
      margin-left: 20px;
      border-left: 2px solid #e0e0e0;
      padding-left: 16px;
      margin-top: 12px;
    }
    
    /* Year block styling */
    .year-block {
      margin-bottom: 24px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
    }
    
    .year-block h2 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 20px;
    }

    /* Rewards Section Styles */
    .leaderboard {
      display: grid;
      gap: 12px;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .leaderboard-item.rank-1 {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      border-color: #f59e0b;
    }

    .leaderboard-item.rank-2 {
      background: linear-gradient(135deg, #c0c0c0 0%, #e5e7eb 100%);
      border-color: #9ca3af;
    }

    .leaderboard-item.rank-3 {
      background: linear-gradient(135deg, #cd7f32 0%, #d97706 100%);
      border-color: #b45309;
      color: white;
    }

    .rank {
      font-size: 24px;
      font-weight: bold;
      margin-right: 16px;
      min-width: 40px;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-weight: 600;
      font-size: 16px;
    }

    .member-email {
      color: #6b7280;
      font-size: 14px;
    }

    .points {
      font-size: 20px;
      font-weight: bold;
      color: #059669;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .criteria-list {
      margin-top: 16px;
    }

    .criteria-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .criteria-name {
      font-weight: 600;
    }

    .criteria-points {
      color: #059669;
      font-weight: bold;
    }

    .recent-entries {
      max-height: 300px;
      overflow-y: auto;
    }

    .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .entry-info {
      flex: 1;
    }

    .entry-member {
      font-weight: 600;
    }

    .entry-reason {
      color: #6b7280;
      font-size: 14px;
    }

    .entry-points {
      color: #059669;
      font-weight: bold;
    }

    .success {
      color: #059669;
      background: #f0fdf4;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #bbf7d0;
    }

    .error {
      color: #dc2626;
      background: #fef2f2;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #fecaca;
    }

    .loading {
      text-align: center;
      color: #6b7280;
      padding: 20px;
    }

    /* Tab Navigation Styles */
    .tab-nav {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 24px;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
      padding: 4px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .tab-btn.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .leaderboard-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .leaderboard-item {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .rank-1 .rank::after {
      content: " üëë";
      font-size: 16px;
    }

    .rank-2 .rank::after {
      content: " ü•à";
      font-size: 16px;
    }

    .rank-3 .rank::after {
      content: " ü•â";
      font-size: 16px;
    }

    /* Badge Styles */
    .member-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: #f0f9ff;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }

    .badge.monthly {
      background: #fef3c7;
      color: #92400e;
      border-color: #fcd34d;
    }

    .badge.quarterly {
      background: #f3e8ff;
      color: #7c3aed;
      border-color: #c4b5fd;
    }

    .badge.top-member {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #92400e;
      border-color: #f59e0b;
      font-weight: 700;
    }

    .leaderboard-item {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Member Details Modal */
    .member-details {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .member-details-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .member-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .member-details-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
    }

    .close-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .points-breakdown {
      margin-bottom: 24px;
    }

    .points-category {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .points-category-name {
      font-weight: 600;
      color: #374151;
    }

    .points-category-value {
      font-weight: 700;
      color: #059669;
    }

    .badges-section {
      margin-top: 24px;
    }

    .badges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .badge-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .badge-item.earned {
      background: #f0fdf4;
      border-color: #bbf7d0;
    }

    .badge-icon {
      font-size: 24px;
      margin-right: 12px;
    }

    .badge-info {
      flex: 1;
    }

    .badge-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .badge-description {
      font-size: 12px;
      color: #6b7280;
    }

    .recent-activity {
      margin-top: 24px;
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .activity-item small {
      color: #6b7280;
      font-size: 12px;
    }

    /* Badge Legend Styles */
    .badge-legend {
      max-height: 70vh;
      overflow-y: auto;
    }

    .legend-section {
      margin-bottom: 24px;
    }

    .legend-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .legend-badges {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .legend-badge-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }

    .legend-badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      min-width: 120px;
      flex-shrink: 0;
    }

    .legend-description {
      font-size: 12px;
      color: #6b7280;
      flex: 1;
    }

    .legend-badge.monthly {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }

    .legend-badge.quarterly {
      background: #f3e8ff;
      color: #7c3aed;
      border: 1px solid #c4b5fd;
    }

    .legend-badge.top-member {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #92400e;
      border: 1px solid #f59e0b;
      font-weight: 700;
    }

    /* Responsive design for smaller screens */
    @media (max-width: 1200px) {
      .leaderboard-tab-grid {
        grid-template-columns: 1fr;
      }
      
      .badge-legend {
        max-height: 50vh;
      }
    }

    /* Member Edit Modal Styles */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px 16px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8f9fa;
      border-radius: 12px 12px 0 0;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .checkbox-label {
      display: flex !important;
      align-items: center;
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 0 !important;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-text {
      color: #374151;
      font-size: 14px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.hidden {
      display: none;
    }

    .modal:not(.hidden) {
      display: block;
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    /* Emoji Picker Styles */
    .emoji-picker-container {
      position: relative;
      margin-bottom: 0;
    }

    .emoji-picker-container > input,
    .emoji-picker-container > button {
      margin-bottom: 8px;
    }

    .emoji-grid {
      position: absolute;
      top: auto;
      bottom: 100%;
      left: 0;
      z-index: 1000;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: auto;
      min-width: 350px;
      max-width: 500px;
      max-height: 400px;
      overflow-y: auto;
    }

    .emoji-category {
      margin-bottom: 16px;
    }

    .emoji-category:last-child {
      margin-bottom: 0;
    }

    .emoji-category h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .emoji-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .emoji-options span {
      cursor: pointer;
      font-size: 24px;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s, transform 0.2s;
      user-select: none;
    }

    .emoji-options span:hover {
      background-color: #f3f4f6;
      transform: scale(1.1);
    }

    .emoji-options span:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <nav class="topnav">
    <button class="navbtn" onclick="show('members')">Members</button>
    <button class="navbtn" onclick="show('kpi')">KPI</button>
    <button class="navbtn" onclick="show('templates')">Templates</button>
    <button class="navbtn" onclick="show('meetings')">Meetings</button>
    <button class="navbtn" onclick="show('feedback')">Feedback</button>
    <a class="navbtn" href="/quizz">Quizz</a>
    <button class="navbtn" onclick="show('rewards')">üèÜ Rewards</button>
    <a class="navbtn" href="/debate">Debate</a>
  </nav>

  <!-- Membri -->
  <section id="members" class="page active">
    <h1>Members</h1>
    <div class="row gap">
      <input id="memberName" class="inp" placeholder="Member name" />
      <input id="memberEmail" class="inp" placeholder="Email" />
      <select id="memberStudio" class="sel"><option>CC</option><option>WSOP</option></select>
      <select id="memberStatus" class="sel"><option value="active">Active</option><option value="inactive">Inactive/Maternity</option></select>
      <label class="row gap align-center" style="white-space: nowrap;">
        <input type="checkbox" id="memberClanLead" />
        <span>Clan Lead</span>
      </label>
      <label class="row gap align-center" style="white-space: nowrap;">
        <input type="checkbox" id="memberExternal" />
        <span>External</span>
      </label>
      <button class="btn primary" onclick="addMember()">Add</button>
    </div>

    <div class="row gap mt">
      <select id="filterStudio" class="sel" onchange="onMemberFilterChange()">
        <option value="">(All studios)</option><option>CC</option><option>WSOP</option>
      </select>
      <select id="filterStatus" class="sel" onchange="onMemberFilterChange()">
        <option value="">(All statuses)</option><option value="active">Active</option><option value="inactive">Inactive/Maternity</option>
      </select>
      <input id="memberSearch" class="inp" placeholder="Search name or email‚Ä¶" oninput="onMemberSearchChange()" />
      <select id="memberPageSize" class="sel" onchange="onMemberPageSizeChange()">
        <option>10</option><option>20</option><option>50</option><option>100</option>
      </select>
      <div class="pager">
        <button class="btn subtle" onclick="memberPrevPage()">¬´ Previous</button>
        <span id="memberPageInfo" class="muted"></span>
        <button class="btn subtle" onclick="memberNextPage()">Next ¬ª</button>
      </div>
    </div>
    <div id="memberList" class="list mt"></div>
  </section>

  <!-- KPI -->
  <section id="kpi" class="page">
    <h1>General KPIs</h1>
    
    <!-- Add Category -->
    <div class="card">
      <h2>Add New Category</h2>
      <div class="row gap">
        <input id="categoryNameInput" class="inp wide" placeholder="Category name (e.g., Knowledge Share)" />
        <button class="btn primary" onclick="addCategory()">Add Category</button>
      </div>
    </div>

    <!-- Categories Display -->
    <div id="categoriesContainer" class="mt"></div>

    <!-- Add KPI Modal -->
    <div id="kpiModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h2>Add KPI</h2>
        <div class="form-group">
          <label>KPI Name:</label>
          <input id="kpiNameInput" class="inp" placeholder="Name of KPI" />
        </div>
        <div class="form-group">
          <label>How to Measure:</label>
          <textarea id="kpiMeasureInput" class="inp" rows="3" placeholder="How to measure this KPI"></textarea>
        </div>
        <div class="row gap">
          <button class="btn primary" onclick="saveKpi()">Save</button>
          <button class="btn subtle" onclick="closeKpiModal()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h2>Edit Category</h2>
        <div class="form-group">
          <label>Category Name:</label>
          <input id="editCategoryNameInput" class="inp" placeholder="Category name" />
        </div>
        <div class="row gap">
          <button class="btn primary" onclick="saveCategoryEdit()">Save</button>
          <button class="btn subtle" onclick="closeCategoryModal()">Cancel</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Templates: background + imagini + TEXT -->
  <section id="templates" class="page">
    <h1>Templates (Newsletter)</h1>
    
    <!-- Template Selector -->
    <div class="card">
      <h2>Template Selection</h2>
      <div class="row gap align-center">
        <select id="templateSelector" class="sel wide" onchange="TPL_selectTemplate(this.value)">
          <option value="">Select a template...</option>
        </select>
        <button class="btn primary" onclick="TPL_save()">Save template</button>
        <button class="btn subtle" onclick="TPL_new()">New</button>
        <button class="btn danger" onclick="TPL_deleteCurrent()" id="deleteBtn" style="display:none">Delete</button>
      </div>
      </div>

    <!-- Template Editor -->
    <div class="card mt">
      <h2>Template Editor</h2>
      <div class="row gap align-center">
        <input id="tplName" class="inp" placeholder="Template name" />
        <span class="chip">Canvas 9:16 (1080√ó1920)</span>
      </div>
      

      <!-- Layer Controls -->
      <div class="mt">
        <div class="row gap">
          <button class="btn" onclick="TPL_addImageLayer()">+ Add image layer</button>
          <button class="btn" onclick="TPL_addTextLayer()">+ Add TEXT layer</button>
        </div>
        <div id="tplLayers" class="list mt"></div>
      </div>

      <!-- 3-Zone Template System -->
      <div class="template-zones mt">
        <!-- Zone Uploads -->
        <div class="zone-uploads">
          <h3>Zone Background Images</h3>
          <div class="zone-upload-grid">
            <!-- Top Zone -->
            <div class="zone-upload-item top-zone">
              <h4>Top Zone (200√ó426px)</h4>
              <div class="row gap align-center">
                <input id="topZoneFile" type="file" accept="image/*" class="inp" onchange="TPL_loadZoneImage('top', this)" />
                <button class="btn subtle" onclick="TPL_clearZone('top')">Clear</button>
        </div>
              <div id="topZonePreview" class="zone-preview-small"></div>
    </div>

            <!-- Body Zone -->
            <div class="zone-upload-item body-zone">
              <h4>Body Zone (1080√ó1280px) - AI Text Overlay</h4>
              <div class="row gap align-center">
                <input id="bodyZoneFile" type="file" accept="image/*" class="inp" onchange="TPL_loadZoneImage('body', this)" />
                <button class="btn subtle" onclick="TPL_clearZone('body')">Clear</button>
              </div>
              <div id="bodyZonePreview" class="zone-preview-small"></div>
              <div class="ai-zones-info">
                <h5>AI Text Zones Configuration:</h5>
                <div class="ai-zones-config">
                  <div class="ai-zone-config-item">
                    <label>üì∞ Headline Zone:</label>
                    <div class="row gap">
                      <input type="number" id="headlineX" value="10" min="0" max="100" class="inp small" placeholder="X %">
                      <input type="number" id="headlineY" value="1.5" min="0" max="100" class="inp small" placeholder="Y %">
                      <input type="number" id="headlineW" value="80" min="10" max="100" class="inp small" placeholder="Width %">
                      <input type="number" id="headlineH" value="8" min="1" max="20" class="inp small" placeholder="Height %">
                    </div>
                  </div>
                  <div class="ai-zone-config-item">
                    <label>üìù Subheadline Zone:</label>
                    <div class="row gap">
                      <input type="number" id="subX" value="1.8" min="0" max="100" class="inp small" placeholder="X %">
                      <input type="number" id="subY" value="6.25" min="0" max="100" class="inp small" placeholder="Y %">
                      <input type="number" id="subW" value="35" min="10" max="100" class="inp small" placeholder="Width %">
                      <input type="number" id="subH" value="10" min="1" max="20" class="inp small" placeholder="Height %">
                    </div>
                  </div>
                  <div class="ai-zone-config-item">
                    <label>üìã Bullets Zones:</label>
                    <div id="bulletsZonesConfig">
                      <!-- Dynamic bullets zones will be added here -->
                    </div>
                  </div>
                </div>
                <button class="btn small" onclick="TPL_updateAIZones()">Update Zones</button>
                <button class="btn small" onclick="TPL_addBulletsZone()">+ Add Bullets Zone</button>
                <button class="btn small" onclick="TPL_removeBulletsZone()">- Remove Bullets Zone</button>
                <button class="btn small" onclick="console.log('Current AI zones:', TPL_AI_ZONES)">Debug Zones</button>
                <small class="muted">Add your layers in the free areas between these zones</small>
              </div>
    </div>

            <!-- Bottom Zone -->
            <div class="zone-upload-item bottom-zone">
              <h4>Bottom Zone (150√ó214px)</h4>
      <div class="row gap align-center">
                <input id="bottomZoneFile" type="file" accept="image/*" class="inp" onchange="TPL_loadZoneImage('bottom', this)" />
                <button class="btn subtle" onclick="TPL_clearZone('bottom')">Clear</button>
      </div>
              <div id="bottomZonePreview" class="zone-preview-small"></div>
    </div>
          </div>
        </div>
      </div>

      <!-- Template Preview Canvas -->
      <div class="mt" id="tplStageWrap">
        <div id="tplStage"
          style="position:relative; background:#fafafa; border:1px solid #eaedf4; border-radius:10px; overflow:hidden; width:min(100%,320px); aspect-ratio:9/16; background-size:cover; background-position:center; margin: 0 auto;">
        </div>
        <div class="muted" style="margin-top:6px; text-align: center;">Coordinates are relative to editor and scale to 1080√ó1920.</div>
      </div>
    </div>

  </section>

  <!-- Meetings -->
  <section id="meetings" class="page">
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px; align-items: start;">
      <div>
    <h1>Meetings</h1>

    <div class="card">
      <h2>Create Meeting</h2>
      <div class="row gap mt">
        <input id="meetingTitle" class="inp wide" placeholder="Meeting title" />
        <input id="meetingDate" class="inp" type="date" />
        <input id="meetingTopic" class="inp wide" placeholder="Main topic" />
      </div>

        <h3 class="mt">Meeting Features</h3>
        <div class="row gap mt">
          <label class="chkline">
            <input type="checkbox" id="meetingTypeDebate" />
            <span>Include Debate</span>
          </label>
          <label class="chkline">
            <input type="checkbox" id="meetingTypeQuiz" />
            <span>Include Quiz</span>
          </label>
        </div>
        <div class="muted" style="margin-top: 6px; font-size: 12px;">
          Select additional features for your meeting. All meetings include standard agenda and feedback. 
          Debate adds interactive discussion features. Quiz adds knowledge testing capabilities.
      </div>

      <h3 class="mt">Participants</h3>
      <div class="row gap align-center">
        <label class="chkline"><input type="checkbox" id="selectAllParticipants" onchange="toggleSelectAll()" /><span>Select all (current page)</span></label>
        <input id="ptSearch" class="inp" placeholder="Search‚Ä¶" oninput="onPtSearchChange()" />
        <select id="ptStudioFilter" class="sel" onchange="onPtStudioChange()"><option value="all">All</option><option>CC</option><option>WSOP</option></select>
        <label class="chkline"><input type="checkbox" id="includeInactive" onchange="onPtIncludeInactiveChange()" /><span>Include inactive</span></label>
        <select id="ptPageSize" class="sel" onchange="onPtPageSizeChange()"><option>10</option><option>20</option><option>50</option></select>
      </div>

      <div id="participantList" class="list mt"></div>

      <div class="row gap align-center mt">
        <button class="btn subtle" onclick="ptPrevPage()">¬´ Previous</button>
        <span id="ptPageInfo" class="muted"></span>
        <button class="btn subtle" onclick="ptNextPage()">Next ¬ª</button>
      </div>

      <h3 class="mt">Agenda</h3>
      <div class="row gap">
        <input class="inp" placeholder="15:00" id="agendaStart" />
        <input class="inp" placeholder="15:20" id="agendaEnd" />
        <input class="inp wide" placeholder="Activity" id="agendaTitle" />
        <select id="agendaOwner" class="sel" style="min-width:220px"></select>
        <button class="btn" onclick="addAgenda()">Add to agenda</button>
      </div>
      <ul id="agendaList" class="bullets mt"></ul>

      <div class="row gap mt">
        <button class="btn primary" onclick="saveMeeting()">üíæ Save meeting</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </div>

    <div id="meetingsContainer" class="mt"></div>
      </div>
      
      <!-- Meetings Sidebar -->
      <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; position: sticky; top: 20px;">
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1f2937;">AI Report Settings</h3>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 14px;">Custom Prompt</label>
          <textarea id="customPrompt" placeholder="Add additional instructions for the AI report..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; min-height: 120px; resize: vertical; font-family: inherit;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#d1d5db'"></textarea>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 14px;">Report Focus</label>
          <select id="reportFocus" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
            <option value="general">General Overview</option>
            <option value="performance">Performance Metrics</option>
            <option value="challenges">Challenges & Issues</option>
            <option value="improvements">Process Improvements</option>
            <option value="team">Team Dynamics</option>
          </select>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 14px;">Report Length</label>
          <select id="reportLength" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
            <option value="brief">Brief (1-2 pages)</option>
            <option value="standard" selected>Standard (3-5 pages)</option>
            <option value="detailed">Detailed (5+ pages)</option>
          </select>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
            <input type="checkbox" id="includeCharts" checked style="width: 16px; height: 16px; accent-color: #3b82f6;">
            <span>Include Charts & Graphs</span>
          </label>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
            <input type="checkbox" id="includeRecommendations" checked style="width: 16px; height: 16px; accent-color: #3b82f6;">
            <span>Include Recommendations</span>
          </label>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
            <input type="checkbox" id="includeActionItems" checked style="width: 16px; height: 16px; accent-color: #3b82f6;">
            <span>Include Action Items</span>
          </label>
        </div>
        
        <div style="padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; margin-bottom: 16px;">
          <div style="font-size: 12px; color: #1e40af; font-weight: 500; margin-bottom: 4px;">üí° Tip</div>
          <div style="font-size: 12px; color: #1e40af;">Use the custom prompt to specify particular aspects you want the AI to focus on, such as specific KPIs, team performance, or process improvements.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Feedback -->
  <section id="feedback" class="page">
      <div style="margin-bottom: 32px;">
        <h1 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 700; color: #1f2937;">Feedback</h1>
        <p style="margin: 0; color: #6b7280; font-size: 16px;">Create and manage feedback forms for your meetings</p>
      </div>
      
      <!-- Form Details Card -->
      <div style="background: white; border-radius: 16px; padding: 32px; margin-bottom: 32px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
          <div>
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Meeting</label>
            <select id="fbMeeting" class="sel" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'"></select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Form Title</label>
            <input id="fbTitle" class="inp" placeholder="QA Q3 Feedback" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'" />
          </div>
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;">Description</label>
          <textarea id="fbDesc" class="inp" placeholder="Short description of this feedback form" style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; min-height: 100px; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
        </div>
      </div>

      <!-- Questions Section -->
      <div style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="margin: 0; font-size: 24px; font-weight: 700; color: #1f2937;">Questions</h2>
          <button id="fbDeleteForm" style="padding: 10px 16px; font-size: 14px; font-weight: 600; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
            <span style="font-size: 16px;">üóëÔ∏è</span> Delete Form
          </button>
        </div>
        
      <div id="fbQList"></div>
        
        <!-- Add Question Button -->
        <div style="margin-top: 24px; text-align: center;">
          <button id="fbAddQuestion" style="padding: 16px 32px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
            <span style="font-size: 18px; margin-right: 8px;">+</span> Add New Question
          </button>
          
          <!-- Question Type Selector (visible by default when no questions) -->
          <div id="fbQuestionTypes" style="display: block; margin-top: 20px; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 2px solid #e5e7eb;">
            <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #1f2937; text-align: center;">Choose Question Type</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <button class="fb-question-type-btn" data-type="single" style="
                padding: 20px;
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
              " onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                <span style="font-size: 32px;">üìã</span>
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Single Choice</div>
                  <div style="font-size: 12px; color: #6b7280;">One answer from multiple options</div>
                </div>
              </button>
              
              <button class="fb-question-type-btn" data-type="multi" style="
                padding: 20px;
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
              " onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='#faf5ff'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                <span style="font-size: 32px;">‚òëÔ∏è</span>
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Multiple Choice</div>
                  <div style="font-size: 12px; color: #6b7280;">Multiple answers allowed</div>
                </div>
              </button>
              
              <button class="fb-question-type-btn" data-type="rating" style="
                padding: 20px;
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
              " onmouseover="this.style.borderColor='#f59e0b'; this.style.background='#fffbeb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                <span style="font-size: 32px;">‚≠ê</span>
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Rating Scale</div>
                  <div style="font-size: 12px; color: #6b7280;">1-5 star rating system</div>
                </div>
              </button>
              
              <button class="fb-question-type-btn" data-type="rating_presenter" style="
                padding: 20px;
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
              " onmouseover="this.style.borderColor='#8b5cf6'; this.style.background='#faf5ff'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                <span style="font-size: 32px;">üé§</span>
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Rating Presenter</div>
                  <div style="font-size: 12px; color: #6b7280;">Rate meeting presenters (1-5)</div>
                </div>
              </button>
              
              <button class="fb-question-type-btn" data-type="text" style="
                padding: 20px;
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
              " onmouseover="this.style.borderColor='#10b981'; this.style.background='#f0fdf4'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                <span style="font-size: 32px;">üìù</span>
                <div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Text Response</div>
                  <div style="font-size: 12px; color: #6b7280;">Free text input</div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row gap mt">
        <button class="btn primary" id="fbSave">üíæ Save form + QR</button>
        <span id="fbMsg" class="muted"></span>
      </div>

      <div id="fbShare" class="mt" style="display:none">
        <h3>Share</h3>
        <div class="row gap" style="align-items:flex-start">
          <img id="fbQR" class="qrimg" style="max-width:160px" />
          <div style="flex:1">
            <div><a id="fbLink" href="#" target="_blank"></a></div>
            <div class="row gap mt">
              <button class="btn" id="fbCopy">Copy link</button>
              <button class="btn" id="fbTeams">AI message for Teams (EN)</button>
              <button class="btn" id="fbTeamsCopy" style="display:none">Copy message</button>
              <button class="btn" id="fbTeamsCopyHtml" style="display:none">Copy HTML+QR</button>
            </div>
            
            <div class="mt">
              <h4>Extra suggestions for AI (optional):</h4>
              <textarea id="fbExtraSuggestions" class="inp" placeholder="Add any extra context or suggestions for the AI message..." style="width:100%;height:60px;margin-bottom:10px;"></textarea>
            </div>
            
            <div id="fbTeamsSection" class="mt" style="display:none">
              <h4>Generated message (editable):</h4>
              <textarea id="fbTeamsTxt" class="inp" style="width:100%;height:120px;white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:10px;font-family:monospace;"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div id="fbResults" class="mt" style="display:none">
        <div style="
          background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
          color: white;
          padding: 24px;
          border-radius: 12px;
          margin-bottom: 24px;
          box-shadow: 0 4px 12px rgba(0,120,212,0.3);
        ">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
              <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">üìä Feedback Results</h3>
              <p style="margin: 0; opacity: 0.9; font-size: 16px;">Real-time analytics and insights from your team</p>
            </div>
            <div style="
              background: rgba(255,255,255,0.2);
              padding: 12px 16px;
              border-radius: 8px;
              text-align: center;
            ">
              <div id="fbTotalResponses" style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">0</div>
              <div style="font-size: 12px; opacity: 0.8;">Total Responses</div>
            </div>
          </div>
        </div>
        <div id="fbResBody"></div>
      </div>
    </div>
  </section>
  <!-- Rewards Section -->
  <section id="rewards" class="page">
    <h1>üèÜ Rewards & Leaderboard</h1>
    
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchRewardTab('leaderboard')">üèÜ Leaderboard</button>
      <button class="tab-btn" onclick="switchRewardTab('criteria')">üìã Criteria</button>
      <button class="tab-btn" onclick="switchRewardTab('points')">‚ûï Add/Delete Points</button>
    </div>

    <!-- Admin Actions -->
    <div style="margin: 16px 0; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb;">
      <div style="display: flex; align-items: center; gap: 12px; justify-content: space-between;">
        <div>
          <strong style="color: #374151;">Recalculate Points</strong>
          <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Reset and recalculate all automatic points (meeting attendance, presentations, debates) based on current rules</div>
        </div>
        <button class="btn" onclick="recalculateAllPoints()" id="recalculatePointsBtn" style="white-space: nowrap;">üîÑ Recalculate Points</button>
      </div>
      <div id="recalculatePointsMsg" style="margin-top: 8px; font-size: 12px;"></div>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboardTab" class="tab-content active">
      <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
        <!-- Leaderboard -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Top Performers</h2>
            <div class="leaderboard-controls">
              <button class="btn secondary" onclick="toggleLeaderboardView()" id="toggleViewBtn">
                <span id="toggleText">Show All</span>
              </button>
              <div class="pager" id="leaderboardPager" style="display: none;">
                <button class="btn subtle" onclick="leaderboardPrevPage()">¬´ Previous</button>
                <span id="leaderboardPageInfo" class="muted"></span>
                <button class="btn subtle" onclick="leaderboardNextPage()">Next ¬ª</button>
              </div>
            </div>
          </div>
          <div id="leaderboard" class="leaderboard">
            <div class="loading">Loading leaderboard...</div>
          </div>
        </div>

        <!-- Badge Legend -->
        <div class="card">
          <h2>üèÜ Badge Legend</h2>
          <div class="badge-legend">
            <div class="legend-section">
              <h3>Monthly Badges</h3>
              <div class="legend-badges">
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üìç QA Attendee</div>
                  <div class="legend-description">Attended the meeting (5p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üì¢ QA Speaker</div>
                  <div class="legend-description">Gave a presentation (15p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üÜï First-Time Speaker</div>
                  <div class="legend-description">Gave their first-ever presentation (15p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üß† Quiz Addict</div>
                  <div class="legend-description">Participated in the quiz (10p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üèÜ Quiz Champion</div>
                  <div class="legend-description">Won the quiz (20p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üöÄ QA Initiator</div>
                  <div class="legend-description">Launched or proposed an initiative (10p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">‚úçÔ∏è Knowledge Dropper</div>
                  <div class="legend-description">Contributed valuable resources (5p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üõ†Ô∏è Extra Mile</div>
                  <div class="legend-description">Other valuable contributions (5p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üí¨ Debate Participation</div>
                  <div class="legend-description">Participated in debate (5p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">ü§º‚Äç‚ôÇÔ∏è Debate Winner</div>
                  <div class="legend-description">Won the debate (15p)</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge monthly">üßë‚Äçüè´ QA Mentor</div>
                  <div class="legend-description">Mentor for other member (10p)</div>
                </div>
              </div>
            </div>

            <div class="legend-section">
              <h3>Quarterly Badges</h3>
              <div class="legend-badges">
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">‚úÖ QA Regular</div>
                  <div class="legend-description">Attended all meetings in the quarter</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üéôÔ∏è Quarter Speaker</div>
                  <div class="legend-description">Presented in all quarter meetings</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üß† Quarter Quizzer</div>
                  <div class="legend-description">Participated in all quizzes during the quarter</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">ü•á Quarter Quiz Champ</div>
                  <div class="legend-description">Won the most quizzes during the quarter</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üöÄ Quarter Initiator</div>
                  <div class="legend-description">Proposed at least 1 initiative per month</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üìö Content Crafter</div>
                  <div class="legend-description">Contributed resources every month</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üëë The Complete QA</div>
                  <div class="legend-description">Completed all activities every month</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge quarterly">üìò QA Mentor Pillar</div>
                  <div class="legend-description">Provided mentorship in every meeting</div>
                </div>
              </div>
            </div>

            <div class="legend-section">
              <h3>Top Members Badges</h3>
              <div class="legend-badges">
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üëë QA Legend</div>
                  <div class="legend-description">Top 1 all-time by points</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üíé QA Platinum</div>
                  <div class="legend-description">2nd place all-time</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">ü•á QA Gold</div>
                  <div class="legend-description">3rd place all-time</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">ü•à QA Silver</div>
                  <div class="legend-description">4th place all-time</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">ü•â QA Bronze</div>
                  <div class="legend-description">5th place all-time</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üß≠ QA Consistent</div>
                  <div class="legend-description">Participated in all meetings during the year</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üõ°Ô∏è QA Pillar</div>
                  <div class="legend-description">Active in all quarters during the year</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üß† QA Knowledge Hero</div>
                  <div class="legend-description">Contributed the most presentations</div>
                </div>
                <div class="legend-badge-item">
                  <div class="legend-badge top-member">üéØ QA Completionist</div>
                  <div class="legend-description">Earned at least 1 different badge every month</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Criteria Tab -->
    <div id="criteriaTab" class="tab-content">
      <div class="card">
        <h2>Manage Criteria</h2>
        <div class="form-row">
          <div>
            <label>Criteria Name</label>
            <input type="text" id="newCriteriaName" class="inp" placeholder="e.g., Special Achievement" />
          </div>
          <div>
            <label>Criteria Points</label>
            <input type="number" id="newCriteriaPoints" class="inp" placeholder="Points" />
          </div>
          <div>
            <button class="btn primary" onclick="addCriteria()">Save Criteria</button>
          </div>
        </div>
        
        <div id="criteriaList" class="criteria-list">
          <div class="loading">Loading criteria...</div>
        </div>
      </div>

      <!-- Badge Creation -->
      <div class="card mt">
        <h2>üèÜ Create New Badge</h2>
        <p class="muted">Create custom badges with icons and points</p>
        
        <div class="form-row">
          <div>
            <label>Badge Icon</label>
            <div class="emoji-picker-container">
              <input type="text" id="newBadgeIcon" class="inp" placeholder="Click to select emoji" readonly />
              <button type="button" class="btn secondary" onclick="openEmojiPicker()">Choose Emoji</button>
              <div class="emoji-grid" id="emojiGrid" style="display: none;">
              <div class="emoji-category">
                <h4>üèÜ Awards & Achievements</h4>
                <div class="emoji-options">
                  <span onclick="selectEmoji('üèÜ')">üèÜ</span>
                  <span onclick="selectEmoji('ü•á')">ü•á</span>
                  <span onclick="selectEmoji('ü•à')">ü•à</span>
                  <span onclick="selectEmoji('ü•â')">ü•â</span>
                  <span onclick="selectEmoji('üëë')">üëë</span>
                  <span onclick="selectEmoji('üíé')">üíé</span>
                  <span onclick="selectEmoji('üéñÔ∏è')">üéñÔ∏è</span>
                  <span onclick="selectEmoji('üèÖ')">üèÖ</span>
                </div>
              </div>
              <div class="emoji-category">
                <h4>üìö Learning & Knowledge</h4>
                <div class="emoji-options">
                  <span onclick="selectEmoji('üìö')">üìö</span>
                  <span onclick="selectEmoji('üß†')">üß†</span>
                  <span onclick="selectEmoji('üí°')">üí°</span>
                  <span onclick="selectEmoji('üéì')">üéì</span>
                  <span onclick="selectEmoji('üìñ')">üìñ</span>
                  <span onclick="selectEmoji('‚úçÔ∏è')">‚úçÔ∏è</span>
                  <span onclick="selectEmoji('üìù')">üìù</span>
                  <span onclick="selectEmoji('üî¨')">üî¨</span>
                </div>
              </div>
              <div class="emoji-category">
                <h4>üöÄ Action & Performance</h4>
                <div class="emoji-options">
                  <span onclick="selectEmoji('üöÄ')">üöÄ</span>
                  <span onclick="selectEmoji('‚ö°')">‚ö°</span>
                  <span onclick="selectEmoji('üî•')">üî•</span>
                  <span onclick="selectEmoji('üí™')">üí™</span>
                  <span onclick="selectEmoji('üéØ')">üéØ</span>
                  <span onclick="selectEmoji('‚≠ê')">‚≠ê</span>
                  <span onclick="selectEmoji('üåü')">üåü</span>
                  <span onclick="selectEmoji('üí´')">üí´</span>
                </div>
              </div>
              <div class="emoji-category">
                <h4>üë• Team & Communication</h4>
                <div class="emoji-options">
                  <span onclick="selectEmoji('üë•')">üë•</span>
                  <span onclick="selectEmoji('ü§ù')">ü§ù</span>
                  <span onclick="selectEmoji('üí¨')">üí¨</span>
                  <span onclick="selectEmoji('üì¢')">üì¢</span>
                  <span onclick="selectEmoji('üéôÔ∏è')">üéôÔ∏è</span>
                  <span onclick="selectEmoji('üßë‚Äçüè´')">üßë‚Äçüè´</span>
                  <span onclick="selectEmoji('üë®‚Äçüíº')">üë®‚Äçüíº</span>
                  <span onclick="selectEmoji('üë©‚Äçüíº')">üë©‚Äçüíº</span>
                </div>
              </div>
              <div class="emoji-category">
                <h4>‚úÖ Status & Progress</h4>
                <div class="emoji-options">
                  <span onclick="selectEmoji('‚úÖ')">‚úÖ</span>
                  <span onclick="selectEmoji('üéâ')">üéâ</span>
                  <span onclick="selectEmoji('üéä')">üéä</span>
                  <span onclick="selectEmoji('üÜï')">üÜï</span>
                  <span onclick="selectEmoji('üìç')">üìç</span>
                  <span onclick="selectEmoji('üõ°Ô∏è')">üõ°Ô∏è</span>
                  <span onclick="selectEmoji('üß≠')">üß≠</span>
                  <span onclick="selectEmoji('üéñÔ∏è')">üéñÔ∏è</span>
                </div>
              </div>
            </div>
            </div>
          </div>
          <div>
            <label>Badge Name</label>
            <input type="text" id="newBadgeName" class="inp" placeholder="e.g., QA Champion" />
          </div>
          <div>
            <label>Badge Points</label>
            <input type="number" id="newBadgePoints" class="inp" placeholder="Points" value="0" />
          </div>
          <div>
            <label>Badge Category</label>
            <select id="newBadgeCategory" class="inp">
              <option value="monthly">Monthly Badge</option>
              <option value="quarterly">Quarterly Badge</option>
              <option value="top-member">Top Member Badge</option>
            </select>
          </div>
          <div>
            <button class="btn primary" onclick="addNewBadge()">Create Badge</button>
          </div>
        </div>
        
        <div id="customBadgesList" class="criteria-list">
          <div class="loading">Loading custom badges...</div>
        </div>
      </div>
    </div>

    <!-- Add/Delete Points Tab -->
    <div id="pointsTab" class="tab-content">
      <div class="card">
        <h2>Add/Delete Points</h2>
        <div class="form-row">
          <div>
            <label>Member Name</label>
            <select id="memberSelect" class="inp">
              <option value="">Select member...</option>
            </select>
          </div>
          <div>
            <label>Criteria</label>
            <select id="criteriaSelect" class="inp">
              <option value="">Select criteria...</option>
            </select>
          </div>
          <div class="button-group">
            <button class="btn primary" onclick="addPoints()">Add Points</button>
            <button class="btn danger" onclick="deletePoints()">Delete Points</button>
          </div>
        </div>
      </div>

      <!-- Badge Management -->
      <div class="card mt">
        <h2>üèÜ Badge Management</h2>
        <p class="muted">Add or remove badges from members</p>
        
        <div class="form-row">
          <div>
            <label>Select Member</label>
            <select id="badgeMemberSelect" class="inp">
              <option value="">Select member...</option>
            </select>
          </div>
          <div>
            <label>Select Badge</label>
            <select id="badgeSelect" class="inp">
              <option value="">Select badge...</option>
              <optgroup label="Monthly Badges">
                <option value="üìç QA Attendee">üìç QA Attendee (5p)</option>
                <option value="üì¢ QA Speaker">üì¢ QA Speaker (15p)</option>
                <option value="üÜï First-Time Speaker">üÜï First-Time Speaker (15p)</option>
                <option value="üß† Quiz Addict">üß† Quiz Addict (10p)</option>
                <option value="üèÜ Quiz Champion">üèÜ Quiz Champion (20p)</option>
                <option value="üöÄ QA Initiator">üöÄ QA Initiator (10p)</option>
                <option value="‚úçÔ∏è Knowledge Dropper">‚úçÔ∏è Knowledge Dropper (5p)</option>
                <option value="üõ†Ô∏è Extra Mile">üõ†Ô∏è Extra Mile (5p)</option>
                <option value="üí¨ Debate Participation">üí¨ Debate Participation (5p)</option>
                <option value="ü§º‚Äç‚ôÇÔ∏è Debate Winner">ü§º‚Äç‚ôÇÔ∏è Debate Winner (15p)</option>
                <option value="üßë‚Äçüè´ QA Mentor">üßë‚Äçüè´ QA Mentor (10p)</option>
              </optgroup>
              <optgroup label="Quarterly Badges">
                <option value="‚úÖ Q1 Regular">‚úÖ Q1 Regular</option>
                <option value="‚úÖ Q2 Regular">‚úÖ Q2 Regular</option>
                <option value="‚úÖ Q3 Regular">‚úÖ Q3 Regular</option>
                <option value="‚úÖ Q4 Regular">‚úÖ Q4 Regular</option>
                <option value="üéôÔ∏è Q1 Speaker">üéôÔ∏è Q1 Speaker</option>
                <option value="üéôÔ∏è Q2 Speaker">üéôÔ∏è Q2 Speaker</option>
                <option value="üéôÔ∏è Q3 Speaker">üéôÔ∏è Q3 Speaker</option>
                <option value="üéôÔ∏è Q4 Speaker">üéôÔ∏è Q4 Speaker</option>
                <option value="üß† Quarter Quizzer">üß† Quarter Quizzer</option>
                <option value="ü•á Quarter Quiz Champ">ü•á Quarter Quiz Champ</option>
                <option value="üöÄ Quarter Initiator">üöÄ Quarter Initiator</option>
                <option value="üìö Content Crafter">üìö Content Crafter</option>
                <option value="üëë The Complete QA">üëë The Complete QA</option>
                <option value="üìò QA Mentor Pillar">üìò QA Mentor Pillar</option>
              </optgroup>
              <optgroup label="Top Members Badges">
                <option value="üëë QA Legend">üëë QA Legend</option>
                <option value="üíé QA Platinum">üíé QA Platinum</option>
                <option value="ü•á QA Gold">ü•á QA Gold</option>
                <option value="ü•à QA Silver">ü•à QA Silver</option>
                <option value="ü•â QA Bronze">ü•â QA Bronze</option>
                <option value="üß≠ QA Consistent">üß≠ QA Consistent</option>
                <option value="üõ°Ô∏è QA Pillar">üõ°Ô∏è QA Pillar</option>
                <option value="üß† QA Knowledge Hero">üß† QA Knowledge Hero</option>
                <option value="üéØ QA Completionist">üéØ QA Completionist</option>
              </optgroup>
            </select>
          </div>
          <div class="button-group">
            <button class="btn primary" onclick="addBadgeToMember()">Add Badge</button>
            <button class="btn danger" onclick="removeBadgeFromMember()">Remove Badge</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <button class="btn close" onclick="closeModal()">‚úï</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Member Edit Modal -->
  <div id="memberEditModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Edit Member</h2>
        <button class="btn close" onclick="closeMemberEditModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="memberEditForm">
          <div class="form-group">
            <label for="editMemberName">Name *</label>
            <input type="text" id="editMemberName" class="inp" required>
          </div>
          <div class="form-group">
            <label for="editMemberEmail">Email *</label>
            <input type="email" id="editMemberEmail" class="inp" required>
          </div>
          <div class="form-group">
            <label for="editMemberStudio">Studio</label>
            <select id="editMemberStudio" class="sel">
              <option value="CC">CC</option>
              <option value="WSOP">WSOP</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editMemberStatus">Status</label>
            <select id="editMemberStatus" class="sel">
              <option value="active">Active</option>
              <option value="inactive">Inactive/Maternity</option>
            </select>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="editMemberClanLead">
              <span class="checkmark"></span>
              <span class="checkbox-text">üëë Clan Lead (excluded from rewards leaderboard)</span>
            </label>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="editMemberExternal">
              <span class="checkmark"></span>
              <span class="checkbox-text">üåê External (excluded from leaderboard and points, can be presenter)</span>
            </label>
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary" onclick="closeMemberEditModal()">Cancel</button>
            <button type="submit" class="btn primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script>
    /* ---------- Constante newsletter ---------- */
    const NL_W = 360, NL_H = 640;

    /* ---------- Helpers UI ---------- */
    function escapeHtml(s){
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    
    function show(id){
      document.querySelectorAll(".page").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id === "members") renderMembers();
      if (id === "kpi") loadKpis();
      if (id === "meetings") { loadParticipants(true); refreshAgendaOwnerOptions(); loadMeetings(); }
      if (id === "templates") TPL_init();
      if (id === "feedback") fbInit();
      if (id === "rewards") initRewards();
      if (id === "quizz") {/* Placeholder for Quizz logic, e.g., loadQuizzes() */}
    }
    
    async function apiGet(url){ 
      const r = await fetch(url); 
      if(!r.ok) throw new Error(await r.text()); 
      return r.json(); 
    }
    
    async function apiSend(url, method, body){
      const r = await fetch(url,{ method, headers:{'Content-Type':'application/json'}, body: body?JSON.stringify(body):undefined });
      if(!r.ok) throw new Error(await r.text()); 
      return r.status===204 ? {} : r.json();
    }

    /* ---------- Membri ---------- */
    let MEMBERS = [];
    const MSTATE = { page:1, pageSize:10, query:"", studio:"", status:"" };
    function onMemberFilterChange(){ MSTATE.studio=document.getElementById("filterStudio").value||""; MSTATE.status=document.getElementById("filterStatus").value||""; MSTATE.page=1; renderMembers(); }
    function onMemberSearchChange(){ MSTATE.query=document.getElementById("memberSearch").value.trim().toLowerCase(); MSTATE.page=1; renderMembers(); }
    function onMemberPageSizeChange(){ MSTATE.pageSize=parseInt(document.getElementById("memberPageSize").value,10)||10; MSTATE.page=1; renderMembers(); }
    function memberPrevPage(){ if(MSTATE.page>1){ MSTATE.page--; renderMembers(); } }
    function memberNextPage(){ const t=Math.max(1,Math.ceil(applyMemberFilters().length/MSTATE.pageSize)); if(MSTATE.page<t){ MSTATE.page++; renderMembers(); } }

    function applyMemberFilters(){
      let arr = MEMBERS.slice();
      if (MSTATE.studio) arr = arr.filter(m => (m.studio||"CC")===MSTATE.studio);
      if (MSTATE.status) arr = arr.filter(m => (m.status||"active")===MSTATE.status);
      if (MSTATE.query){
        arr = arr.filter(m=>{
          const n=(m.name||"").toLowerCase(), e=(m.email||"").toLowerCase();
          return n.includes(MSTATE.query)||e.includes(MSTATE.query);
        });
      }
      arr.sort((a,b)=>{ const sa=a.status==="active"?0:1, sb=b.status==="active"?0:1; if(sa!==sb) return sa-sb; return (a.name||"").localeCompare(b.name||""); });
      return arr;
    }
    function nameForEmail(email){
      const em=(email||"").toLowerCase();
      const m=MEMBERS.find(x => (x.email||"").toLowerCase()===em);
      return (m && m.name) ? m.name : "";
    }

    async function addMember(){
      const name=document.getElementById("memberName").value.trim();
      const email=document.getElementById("memberEmail").value.trim();
      const studio=document.getElementById("memberStudio").value;
      const status=document.getElementById("memberStatus").value;
      const clan_lead=document.getElementById("memberClanLead").checked;
      const external=document.getElementById("memberExternal").checked;
      if(!name||!email){ alert("Please fill in name and email"); return; }
      await apiSend("/api/members","POST",{name,email,studio,status,clan_lead,external});
      document.getElementById("memberName").value=""; document.getElementById("memberEmail").value=""; document.getElementById("memberClanLead").checked=false; document.getElementById("memberExternal").checked=false;
      await loadMembers(); await loadParticipants(true); refreshAgendaOwnerOptions();
    }
    async function loadMembers(){ MEMBERS = await apiGet("/api/members"); renderMembers(); refreshAgendaOwnerOptions(); }
    function renderMembers(){
      const wrap=document.getElementById("memberList"), info=document.getElementById("memberPageInfo");
      wrap.innerHTML="";
      const filtered=applyMemberFilters(); const totalPages=Math.max(1,Math.ceil(filtered.length/MSTATE.pageSize));
      if(MSTATE.page>totalPages) MSTATE.page=totalPages;
      const start=(MSTATE.page-1)*MSTATE.pageSize, end=start+MSTATE.pageSize;
      const pageSlice=filtered.slice(start,end);
      pageSlice.map((m)=>({...m,_i:MEMBERS.findIndex(mm=>mm===m)})).forEach(m=>{
        const row=document.createElement("div"); row.className="item";
        const left=document.createElement("div");
        left.innerHTML=`<strong>${escapeHtml(m.name)}</strong> ‚Äì ${escapeHtml(m.email)}
          <span class="chip">${m.studio}</span>
          <span class="chip ${m.status==='active'?'green':'gray'}">${m.status==='active'?'Active':'Inactive/Maternity'}</span>
          ${m.clan_lead?'<span class="chip" style="background:#fef3c7;color:#92400e;border:1px solid #fcd34d;">üëë Clan Lead</span>':''}
          ${m.external?'<span class="chip" style="background:#e0f2fe;color:#0c4a6e;border:1px solid #0ea5e9;">üåê External</span>':''}`;
        const right=document.createElement("div");
        const ebtn=document.createElement("button"); ebtn.className="btn subtle"; ebtn.textContent="Edit";
        ebtn.onclick=()=>openMemberEditModal(m);
        const dbtn=document.createElement("button"); dbtn.className="btn danger"; dbtn.textContent="Delete";
        dbtn.onclick=async()=>{ if(!confirm("Delete this member?"))return; await apiSend(`/api/members/${m._i}`,"DELETE"); await loadMembers(); await loadParticipants(true); refreshAgendaOwnerOptions(); };
        right.appendChild(ebtn); right.appendChild(dbtn);
        row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
      });
      info.textContent=`Page ${MSTATE.page}/${totalPages} ‚Äî ${filtered.length} results`;
    }

    /* ---------- KPI ---------- */
    let CATEGORIES = [];
    let currentCategoryId = null;
    let currentKpiEditId = null;
    let currentCategoryEditId = null;

    async function initKpiData() {
      try {
        await apiSend("/api/kpis/init", "POST", {});
      } catch(e) {
        console.log("Init already done or error:", e);
      }
    }

    async function loadKpis() {
      try {
        await initKpiData(); // Initialize data structure if needed
        CATEGORIES = await apiGet("/api/kpi-categories");
        renderCategories();
      } catch(e) {
        console.error("Error loading KPIs:", e);
      }
    }

    function renderCategories() {
      const container = document.getElementById("categoriesContainer");
      container.innerHTML = "";
      
      CATEGORIES.forEach(category => {
        const categoryCard = document.createElement("div");
        categoryCard.className = "card mt";
        
        // Create header div
        const headerDiv = document.createElement("div");
        headerDiv.className = "row gap align-center mb";
        
        // Create title
        const title = document.createElement("h2");
        title.style.margin = "0";
        title.style.flex = "1";
        title.textContent = category.name;
        
        // Create Edit button
        const editBtn = document.createElement("button");
        editBtn.className = "btn subtle";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => openEditCategoryModal(category.id, category.name);
        
        // Create Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn danger";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteCategory(category.id);
        
        // Create Add KPI button
        const addKpiBtn = document.createElement("button");
        addKpiBtn.className = "btn primary";
        addKpiBtn.textContent = "Add KPI";
        addKpiBtn.onclick = () => openKpiModal(category.id);
        
        headerDiv.appendChild(title);
        headerDiv.appendChild(editBtn);
        headerDiv.appendChild(deleteBtn);
        headerDiv.appendChild(addKpiBtn);
        
        // Create KPIs container
        const kpisContainer = document.createElement("div");
        kpisContainer.id = `category-kpis-${category.id}`;
        kpisContainer.className = "list";
        
        categoryCard.appendChild(headerDiv);
        categoryCard.appendChild(kpisContainer);
        container.appendChild(categoryCard);
        
        renderCategoryKpis(category);
      });
    }

    function renderCategoryKpis(category) {
      const kpisContainer = document.getElementById(`category-kpis-${category.id}`);
      if (!category.kpis || category.kpis.length === 0) {
        kpisContainer.innerHTML = '<p style="color:#888; font-style:italic;">No KPIs yet. Click "Add KPI" to add one.</p>';
        return;
      }
      
      kpisContainer.innerHTML = "";
      category.kpis.forEach(kpi => {
        const row = document.createElement("div");
        row.className = "item";
        
        // Create content div
        const contentDiv = document.createElement("div");
        contentDiv.style.flex = "1";
        contentDiv.innerHTML = `
          <strong>${escapeHtml(kpi.name)}</strong>
          <div style="color:#666; margin-top:4px; white-space: pre-wrap;">${escapeHtml(kpi.how_to_measure)}</div>
        `;
        
        // Create buttons div
        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "row gap";
        
        // Create Edit button
        const editBtn = document.createElement("button");
        editBtn.className = "btn subtle";
        editBtn.textContent = "Edit";
        editBtn.onclick = () => openEditKpiModal(category.id, kpi.id, kpi.name, kpi.how_to_measure);
        
        // Create Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn danger";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = () => deleteKpi(category.id, kpi.id);
        
        buttonsDiv.appendChild(editBtn);
        buttonsDiv.appendChild(deleteBtn);
        
        row.appendChild(contentDiv);
        row.appendChild(buttonsDiv);
        kpisContainer.appendChild(row);
      });
    }

    async function addCategory() {
      const name = document.getElementById("categoryNameInput").value.trim();
      if (!name) {
        alert("Please enter a category name");
        return;
      }
      try {
        await apiSend("/api/kpi-categories", "POST", { name });
        document.getElementById("categoryNameInput").value = "";
        await loadKpis();
      } catch(e) {
        alert("Error adding category: " + (e.message || "Unknown error"));
      }
    }

    async function deleteCategory(categoryId) {
      if (!confirm("Are you sure you want to delete this category and all its KPIs?")) return;
      try {
        await apiSend(`/api/kpi-categories/${categoryId}`, "DELETE");
        await loadKpis();
      } catch(e) {
        alert("Error deleting category: " + (e.message || "Unknown error"));
      }
    }

    function openEditCategoryModal(categoryId, currentName) {
      currentCategoryEditId = categoryId;
      document.getElementById("editCategoryNameInput").value = currentName;
      document.getElementById("editCategoryModal").style.display = "block";
    }

    function closeCategoryModal() {
      document.getElementById("editCategoryModal").style.display = "none";
      currentCategoryEditId = null;
    }

    async function saveCategoryEdit() {
      const name = document.getElementById("editCategoryNameInput").value.trim();
      if (!name) {
        alert("Please enter a category name");
        return;
      }
      try {
        await apiSend(`/api/kpi-categories/${currentCategoryEditId}`, "PUT", { name });
        closeCategoryModal();
        await loadKpis();
      } catch(e) {
        alert("Error updating category: " + (e.message || "Unknown error"));
      }
    }

    function openKpiModal(categoryId) {
      currentCategoryId = categoryId;
      currentKpiEditId = null; // Reset edit mode
      document.getElementById("kpiNameInput").value = "";
      document.getElementById("kpiMeasureInput").value = "";
      document.getElementById("kpiModal").style.display = "block";
    }

    function closeKpiModal() {
      document.getElementById("kpiModal").style.display = "none";
      currentCategoryId = null;
      currentKpiEditId = null;
    }

    function openEditKpiModal(categoryId, kpiId, currentName, currentMeasure) {
      currentCategoryId = categoryId;
      currentKpiEditId = kpiId;
      document.getElementById("kpiNameInput").value = currentName;
      document.getElementById("kpiMeasureInput").value = currentMeasure;
      document.getElementById("kpiModal").style.display = "block";
    }

    async function deleteKpi(categoryId, kpiId) {
      if (!confirm("Are you sure you want to delete this KPI?")) return;
      try {
        await apiSend(`/api/kpi-categories/${categoryId}/kpis/${kpiId}`, "DELETE");
        await loadKpis();
      } catch(e) {
        alert("Error deleting KPI: " + (e.message || "Unknown error"));
      }
    }

    async function saveKpi() {
      const name = document.getElementById("kpiNameInput").value.trim();
      const howToMeasure = document.getElementById("kpiMeasureInput").value.trim();
      
      if (!name || !howToMeasure) {
        alert("Please fill in both KPI name and how to measure");
        return;
      }
      
      try {
        if (currentKpiEditId !== null) {
          // Editing existing KPI
          await apiSend(`/api/kpi-categories/${currentCategoryId}/kpis/${currentKpiEditId}`, "PUT", { name, how_to_measure: howToMeasure });
          currentKpiEditId = null;
        } else {
          // Adding new KPI
          await apiSend(`/api/kpi-categories/${currentCategoryId}/kpis`, "POST", { name, how_to_measure: howToMeasure });
        }
        closeKpiModal();
        await loadKpis();
      } catch(e) {
        alert("Error saving KPI: " + (e.message || "Unknown error"));
      }
    }

    /* ---------- Participants (pagination) ---------- */
    const PSTATE={page:1,pageSize:10,query:"",studio:"all",includeInactive:false};
    const SELECTED_EMAILS=new Set();
    function onPtSearchChange(){ PSTATE.query=document.getElementById("ptSearch").value.trim().toLowerCase(); PSTATE.page=1; renderParticipants(); }
    function onPtStudioChange(){ PSTATE.studio=document.getElementById("ptStudioFilter").value; PSTATE.page=1; renderParticipants(); }
    function onPtIncludeInactiveChange(){ PSTATE.includeInactive=document.getElementById("includeInactive").checked; PSTATE.page=1; renderParticipants(); }
    function onPtPageSizeChange(){ PSTATE.pageSize=parseInt(document.getElementById("ptPageSize").value,10)||10; PSTATE.page=1; renderParticipants(); }
    function ptPrevPage(){ if(PSTATE.page>1){ PSTATE.page--; renderParticipants(); } }
    function ptNextPage(){ const t=Math.max(1,Math.ceil(applyPtFilters().length/PSTATE.pageSize)); if(PSTATE.page<t){ PSTATE.page++; renderParticipants(); } }

    function applyPtFilters(){
      let arr=MEMBERS.slice();
      if(!PSTATE.includeInactive) arr=arr.filter(m=>(m.status||"active")==="active");
      if(PSTATE.studio!=="all") arr=arr.filter(m=>(m.studio||"CC")===PSTATE.studio);
      if(PSTATE.query){ arr=arr.filter(m=>{ const n=(m.name||"").toLowerCase(), e=(m.email||"").toLowerCase(); return n.includes(PSTATE.query)||e.includes(PSTATE.query); }); }
      arr.sort((a,b)=>{ const sa=a.status==="active"?0:1, sb=b.status==="active"?0:1; if(sa!==sb) return sa-sb; return (a.name||"").localeCompare(b.name||""); });
      return arr;
    }
    function renderParticipants(){
      const wrap=document.getElementById("participantList"), info=document.getElementById("ptPageInfo"), master=document.getElementById("selectAllParticipants");
      const filtered=applyPtFilters(), totalPages=Math.max(1,Math.ceil(filtered.length/PSTATE.pageSize));
      if(PSTATE.page>totalPages) PSTATE.page=totalPages;
      const start=(PSTATE.page-1)*PSTATE.pageSize, end=start+PSTATE.pageSize, pageSlice=filtered.slice(start,end);
      wrap.innerHTML="";
      let allChecked = pageSlice.length>0;
      pageSlice.forEach(m=>{
        const line=document.createElement("label"); line.className="chkline participant-line";
        const cb=document.createElement("input"); cb.type="checkbox"; const key=(m.email||"").toLowerCase(); cb.checked=SELECTED_EMAILS.has(key);
        cb.onchange=()=>{ if(cb.checked) SELECTED_EMAILS.add(key); else SELECTED_EMAILS.delete(key); syncMasterCheckbox(); };
        const span=document.createElement("span"); span.textContent=`${m.name} (${m.email})`;
        if(m.status!=="active"){ const chip=document.createElement("span"); chip.className="chip gray"; chip.textContent="inactiv"; span.appendChild(document.createTextNode(" ")); span.appendChild(chip); }
        const chips=document.createElement("span"); chips.innerHTML=` <span class="chip">${m.studio||"CC"}</span>`; span.appendChild(document.createTextNode(" ")); span.appendChild(chips);
        line.appendChild(cb); line.appendChild(span); wrap.appendChild(line);
        if(!cb.checked) allChecked=false;
      });
      master.indeterminate = !allChecked && pageSlice.some(m=>SELECTED_EMAILS.has((m.email||"").toLowerCase()));
      master.checked = allChecked;
      info.textContent = `Page ${PSTATE.page}/${totalPages} ‚Äî ${filtered.length} results`;
    }
    function toggleSelectAll(){
      const master=document.getElementById("selectAllParticipants");
      const filtered=applyPtFilters(); const start=(PSTATE.page-1)*PSTATE.pageSize, end=start+PSTATE.pageSize, pageSlice=filtered.slice(start,end);
      pageSlice.forEach(m=>{ const key=(m.email||"").toLowerCase(); if(master.checked) SELECTED_EMAILS.add(key); else SELECTED_EMAILS.delete(key); });
      renderParticipants();
    }
    function syncMasterCheckbox(){ renderParticipants(); }
    async function loadParticipants(forceReload=false){ if(forceReload||MEMBERS.length===0) await loadMembers(); renderParticipants(); }

    /* ---------- Agenda (creation) ---------- */
    let AGENDA=[];
    function refreshAgendaOwnerOptions(){
      const sel=document.getElementById("agendaOwner");
      if(!sel) return;
      const val=sel.value;
      sel.innerHTML = `<option value="">(Optional responsible)</option>` +
        MEMBERS.map(m=>`<option value="${(m.email||'').toLowerCase()}">${escapeHtml(m.name||m.email)} ‚Äî ${escapeHtml(m.email||'')}</option>`).join("");
      sel.value = val || "";
    }
    function addAgenda(){
      const s=document.getElementById("agendaStart").value.trim(),
            e=document.getElementById("agendaEnd").value.trim(),
            t=document.getElementById("agendaTitle").value.trim(),
            ow=document.getElementById("agendaOwner").value;
      if(!s||!e||!t) return;
      const ownerEmail = (ow||"").toLowerCase();
      const ownerName  = ownerEmail ? (nameForEmail(ownerEmail) || ownerEmail) : "";
      AGENDA.push({start:s,end:e,title:t, ownerEmail, ownerName});
      if(ownerEmail){ SELECTED_EMAILS.add(ownerEmail); renderParticipants(); }
      renderAgenda();
      document.getElementById("agendaStart").value=""; document.getElementById("agendaEnd").value=""; document.getElementById("agendaTitle").value="";
      document.getElementById("agendaOwner").value="";
    }
    function renderAgenda(){
      const ul=document.getElementById("agendaList");
      ul.innerHTML="";
      AGENDA.forEach((a,i)=>{
        const li=document.createElement("li");
        li.textContent = `${a.start} - ${a.end}: ${a.title}` + (a.ownerEmail ? ` ‚Äî responsible: ${a.ownerName||a.ownerEmail}` : "");
        ul.appendChild(li);
      });
    }

    /* ---------- Meetings: save + list ---------- */
    async function saveMeeting(){
      const title=document.getElementById("meetingTitle").value.trim();
      const date=document.getElementById("meetingDate").value;
      const topic=document.getElementById("meetingTopic").value.trim();
      if(!title||!date){ alert("Title and date are required."); return; }
      
      // Collect meeting features
      const types = [];
      if(document.getElementById("meetingTypeDebate").checked) types.push("debate");
      if(document.getElementById("meetingTypeQuiz").checked) types.push("quiz");
      
      // If no features selected, types will be empty array (meeting is just regular)
      
      const participants=Array.from(SELECTED_EMAILS);
      const saveBtn = document.querySelector('button[onclick="saveMeeting()"]');
      setButtonLoading(saveBtn, true);
      
      try{
        await apiSend("/api/meetings","POST",{title,date,topic,participants,agenda:AGENDA,types});
        document.getElementById("saveMsg").textContent="Saved.";
        AGENDA=[]; renderAgenda(); SELECTED_EMAILS.clear();
        document.getElementById("meetingTitle").value=""; document.getElementById("meetingDate").value=""; document.getElementById("meetingTopic").value=""; document.getElementById("selectAllParticipants").checked=false;
        // Reset meeting features
        document.getElementById("meetingTypeDebate").checked=false;
        document.getElementById("meetingTypeQuiz").checked=false;
        await loadMeetings(); renderParticipants();
        setButtonLoading(saveBtn, false);
      }catch{ 
        setButtonLoading(saveBtn, false);
        alert("Error saving."); 
      }
    }

    function quarterOf(dateStr){ if(!dateStr) return "Q1"; const m=parseInt(dateStr.slice(5,7)||"1",10); if(m<=3) return "Q1"; if(m<=6) return "Q2"; if(m<=9) return "Q3"; return "Q4"; }
    function attendanceStats(m){ const p=m.participants||[]; const total=p.length, attended=p.filter(x=>x.present).length, pct=total?Math.round(attended*100/total):0; return {attended,total,pct}; }
    function isFinished(m){ const today=new Date().toISOString().slice(0,10); return (m.date||"")<today; }

    function makeCollapsible(titleText,countText,innerElem,open=false){
      const box=document.createElement("div"); box.className="collapsible"+(open?" open":"");
      const header=document.createElement("div"); header.className="collapsible-header";
      const left=document.createElement("div"); left.className="collapsible-title"; left.textContent=titleText+(countText?` (${countText})`:"");
      const right=document.createElement("div"); const chev=document.createElement("span"); chev.className="chev"; chev.textContent=open?"‚ñæ":"‚ñ∏"; right.appendChild(chev);
      header.appendChild(left); header.appendChild(right);
      const content=document.createElement("div"); content.className="collapsible-content"; content.appendChild(innerElem);
      header.onclick=()=>{ const o=box.classList.toggle("open"); chev.textContent=o?"‚ñæ":"‚ñ∏"; };
      box.appendChild(header); box.appendChild(content); return box;
    }

    const STOPWORDS=new Set(["si","sau","care","cu","de","din","la","pe","pentru","in","√Æn","cƒÉ","ca","un","o","ale","al","ai","este","sunt","am","e","sa","sƒÉ","prin","ce","cum","cƒÉtre","a","an","anul","by","end","of","year","and","or","with","the","to","for","in","on","by","of","a","an","is","are","be","at","from","this","that","as","per"]);
    function tokenize(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").match(/[a-z0-9ƒÉ√¢√Æ»ô≈£»õ]+/gi)?.filter(w=>w.length>3&&!STOPWORDS.has(w))||[]; }
    function expandKpiText(short, all){ const s=(short||"").toLowerCase().trim(); let best=short,bestScore=-1; all.forEach(k=>{ const kl=(k||"").toLowerCase(); let score=0; if(kl===s) score+=1000; if(kl.includes(s)) score+=200+s.length; const st=new Set(tokenize(s)), kt=new Set(tokenize(kl)); let inter=0; st.forEach(t=>{ if(kt.has(t)) inter++; }); const j=inter/(new Set([...st,...kt]).size||1); score+=j*100; score+=k.length/80; if(score>bestScore){bestScore=score; best=k;} }); return best; }
    function buildKpiExplanation(full, m){
      const ctx=[m.title||"",m.topic||"",...(m.agenda||[]).map(a=>a.title||"")].join(" ");
      const ctxTokens=new Set(tokenize(ctx)); const kTokens=tokenize(full);
      const common=[]; const kSet=new Set(); kTokens.forEach(t=>{ if(ctxTokens.has(t)&&!kSet.has(t)){ kSet.add(t); common.push(t);} });
      const top=common.slice(0,3);
      let bestAgenda="", bestScore=0; (m.agenda||[]).forEach(a=>{ const t=tokenize(a.title||""); const sc=t.filter(x=>kSet.has(x)).length; if(sc>bestScore){bestScore=sc; bestAgenda=a.title||"";} });
      let parts=[]; if(top.length) parts.push(`Match on: ${top.join(", ")}`); if(bestAgenda) parts.push(`Related to agenda: ‚Äû${bestAgenda}‚Äù`); if(!parts.length) parts.push("Textual match with title/topic/agenda."); return parts.join(". ")+".";
    }
    function kpisForPayload(k){ if(!Array.isArray(k)) return []; return k.map(x=>typeof x==="string"?x:(x.kpi||x.text||"")); }

    async function renderMeetingCard(m){
      const card=document.createElement("div"); card.className="card meeting-card";
      const head=document.createElement("div"); head.className="meeting-head";
      head.innerHTML=`<h4>${escapeHtml(m.title||"No title")}</h4><div class="meeting-meta"><span class="badge-date">${m.date||"No date"}</span> ¬∑ ${escapeHtml(m.topic||"‚Äì")}</div>`;
      
      // Add meeting features display (only if there are any)
      const types = m.types || [];
      if(types.length > 0) {
        const typesDiv=document.createElement("div"); typesDiv.className="meeting-types";
        types.forEach(type => {
          // Skip regular type - don't show it as a badge
          if(type !== 'regular') {
            const typeBadge = document.createElement("span");
            typeBadge.className = "chip type-" + type;
            typeBadge.textContent = type === "debate" ? "Debate" : 
                                   type === "quiz" ? "Quiz" : type;
            typesDiv.appendChild(typeBadge);
          }
        });
        // Only add typesDiv if it has content
        if(typesDiv.children.length > 0) {
          head.appendChild(typesDiv);
        }
      }
      
      const badges=document.createElement("div"); badges.className="badges";
      const st=document.createElement("span"); st.className="chip "+(isFinished(m)?"gray":"green"); st.textContent=isFinished(m)?"Completed":"Scheduled";
      const at=attendanceStats(m); const ch=document.createElement("span"); ch.className="chip"; ch.textContent=`Attendance: ${at.attended}/${at.total} (${at.pct}%)`;
      const ag=document.createElement("span"); ag.className="chip"; ag.textContent=`${(m.agenda||[]).length} agenda`;
      badges.appendChild(st); badges.appendChild(ch); badges.appendChild(ag);
      
      // Collect all feedback metrics together
      const feedbackMetrics = [];
      
      // Get feedback response rate
      try {
        const responseRate = await getMeetingFeedbackResponseRate(m.id, m);
        if(responseRate && responseRate.presentCount > 0) {
          feedbackMetrics.push({
            type: 'response_rate',
            data: responseRate
          });
        }
      } catch (error) {
        console.error('Error getting response rate for meeting', m.id, ':', error);
      }
      
      // Get feedback rating
      try {
        const feedbackRating = await getMeetingFeedbackRating(m.id);
        if(feedbackRating) {
          feedbackMetrics.push({
            type: 'rating',
            data: feedbackRating
          });
        }
      } catch (error) {
        console.error('Error getting rating for meeting', m.id, ':', error);
      }
      
      // Get presenter ratings
      try {
        const presenterRatings = await getMeetingPresenterRatings(m.id);
        if(presenterRatings && presenterRatings.length > 0) {
          feedbackMetrics.push({
            type: 'presenter_ratings',
            data: presenterRatings
          });
        }
      } catch (error) {
        console.error('Error getting presenter ratings for meeting', m.id, ':', error);
      }
      
      // If we have any feedback metrics, create a grouped section
      if(feedbackMetrics.length > 0) {
        const feedbackSection = document.createElement("div");
        feedbackSection.style.cssText = `
          margin-top: 12px;
          padding: 12px;
          background: #f8fafc;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
        `;
        
        const feedbackTitle = document.createElement("div");
        feedbackTitle.style.cssText = `
          font-size: 12px;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 8px;
        `;
        feedbackTitle.textContent = "üìä Feedback";
        feedbackSection.appendChild(feedbackTitle);
        
        const feedbackBadges = document.createElement("div");
        feedbackBadges.className = "badges";
        feedbackBadges.style.cssText = "display: flex; flex-wrap: wrap; gap: 8px;";
        
        feedbackMetrics.forEach(metric => {
          if(metric.type === 'response_rate') {
            const responseRateChip = document.createElement("span");
            responseRateChip.className = "chip";
            responseRateChip.style.background = "#e0f2fe";
            responseRateChip.style.color = "#0c4a6e";
            responseRateChip.style.border = "1px solid #0ea5e9";
            responseRateChip.textContent = `Response Rate: ${metric.data.responses}/${metric.data.presentCount} (${metric.data.rate}%)`;
            feedbackBadges.appendChild(responseRateChip);
          } else if(metric.type === 'rating') {
            const ratingChip = document.createElement("span");
            ratingChip.className = "chip";
            ratingChip.style.background = "#fef3c7";
            ratingChip.style.color = "#92400e";
            ratingChip.style.border = "1px solid #f59e0b";
            ratingChip.innerHTML = `‚≠ê Rating: ${metric.data.average.toFixed(1)}`;
            feedbackBadges.appendChild(ratingChip);
          } else if(metric.type === 'presenter_ratings') {
            metric.data.forEach(pr => {
              const presenterChip = document.createElement("span");
              presenterChip.className = "chip";
              presenterChip.style.background = "#faf5ff";
              presenterChip.style.color = "#6b21a8";
              presenterChip.style.border = "1px solid #8b5cf6";
              presenterChip.innerHTML = `üé§ ${pr.presenter}: ${pr.avg.toFixed(1)}`;
              feedbackBadges.appendChild(presenterChip);
            });
          }
        });
        
        feedbackSection.appendChild(feedbackBadges);
        badges.appendChild(feedbackSection);
      }
      
      card.appendChild(head); card.appendChild(badges);

      const actions=document.createElement("div"); actions.className="actions-row";
      
      // Base actions for all meetings
      let actionsHTML = `<button class="btn subtle" onclick="aiKpi(${m.id})">AI KPI</button>
        <button class="btn subtle" onclick="newsletter(${m.id})">Newsletter</button>
        <button class="btn subtle" onclick="exportPptx(${m.id})">Export PPTX</button>
        <button class="btn subtle" onclick="qrCheckin(${m.id})">QR Check-in</button>
        <button class="btn subtle" onclick="editMeeting(${m.id})">Edit</button>
        <button class="btn subtle" onclick="editAgenda(${m.id})">‚úé Edit agenda</button>`;
      
      // Add type-specific actions
      if(types && types.includes("debate")) {
        // Check if debate already exists
        const existingDebate = await findExistingDebate(m.id);
        if(existingDebate) {
          actionsHTML += `<button class="btn primary" onclick="openDebate(${existingDebate.id})">üéØ Open Debate</button>`;
        } else {
          actionsHTML += `<button class="btn primary" onclick="createDebate(${m.id})">üéØ Create Debate</button>`;
        }
      }
      if(types && types.includes("quiz")) {
        // Optionally open existing quiz if exists later; for now always create
        actionsHTML += `<button class="btn primary" onclick="createQuiz(${m.id})">‚ùì Create Quiz</button>`;
      }
      
      actionsHTML += `<button class="btn danger" onclick="deleteMeeting(${m.id})">Delete</button>`;
      actions.innerHTML = actionsHTML;
      card.appendChild(actions);

      const agendaWrap=document.createElement("div"); const agendaList=document.createElement("ul"); agendaList.className="bullets";
      (m.agenda||[]).forEach(a=>{
        const li=document.createElement("li");
        const owner = a.ownerEmail ? (a.ownerName || nameForEmail(a.ownerEmail) || a.ownerEmail) : "";
        li.textContent = `${a.start||""}${(a.start&&a.end)?' - ':''}${a.end||""}: ${a.title||""}` + (owner ? ` ‚Äî responsible: ${owner}` : "");
        agendaList.appendChild(li);
      });
      if((m.agenda||[]).length===0){ const li=document.createElement("li"); li.className="muted"; li.textContent="No agenda items."; agendaList.appendChild(li); }
      agendaWrap.appendChild(agendaList); card.appendChild(makeCollapsible("Agenda",(m.agenda||[]).length,agendaWrap,true));

      const inviteWrap=document.createElement("div");
      (m.participants||[]).forEach(p=>{
        const line=document.createElement("div"); line.className="pt-row";
        const dot=document.createElement("span"); dot.className="dot "+(p.present?"green":"red"); line.appendChild(dot);
        const displayName = p.name || nameForEmail(p.email) || p.email;
        line.appendChild(document.createTextNode(` ${displayName} ‚Äì ${p.email}`));
        inviteWrap.appendChild(line);
      });
      card.appendChild(makeCollapsible("Invited",(m.participants||[]).length,inviteWrap,false));

      if(m.matched_kpis && m.matched_kpis.length){
        const kdiv=document.createElement("div"); const kul=document.createElement("ul"); kul.className="bullets";
        const isObj=typeof m.matched_kpis[0]==="object"&&(m.matched_kpis[0].kpi||m.matched_kpis[0].text);
        (m.matched_kpis||[]).forEach(k=>{ const li=document.createElement("li");
          if(isObj){ const full=k.kpi||k.text||"", expl=k.explanation||""; li.innerHTML=`<strong>${escapeHtml(full)}</strong>${expl?`<div class="muted">${escapeHtml(expl)}</div>`:""}`; }
          else li.textContent=k; kul.appendChild(li); });
        kdiv.appendChild(kul); card.appendChild(makeCollapsible("Matched KPIs",m.matched_kpis.length,kdiv,false));
      }
      
      return card;
    }

    // Get feedback rating for a meeting
    async function getMeetingFeedbackRating(meetingId) {
      try {
        console.log('Getting feedback rating for meeting:', meetingId);
        
        // Get all feedback forms for this meeting
        const forms = await apiGet(`/api/feedback/forms?meeting_id=${encodeURIComponent(meetingId)}`);
        console.log('Forms found:', forms);
        if (!forms || !forms.length) {
          console.log('No forms found for meeting:', meetingId);
          return null;
        }
        
        // Get the latest form
        const form = forms[forms.length - 1];
        console.log('Latest form:', form);
        if (!form || !form.questions) {
          console.log('No questions in form');
          return null;
        }
        
        // Find the rating question
        const ratingQuestion = form.questions.find(q => q.type === 'rating');
        console.log('Rating question found:', ratingQuestion);
        if (!ratingQuestion) {
          console.log('No rating question found');
          return null;
        }
        
        // Get form results
        const results = await apiGet(`/api/feedback/forms/${form.id}/results`);
        console.log('Form results full object:', results);
        console.log('Form results keys:', Object.keys(results));
        if (!results || !results.questions) {
          console.log('No results found');
          return null;
        }
        
        // Debug: log all questions to see the structure
        console.log('All questions in results:', results.questions);
        results.questions.forEach((q, index) => {
          console.log(`Question ${index} full object:`, q);
          console.log(`Question ${index} keys:`, Object.keys(q));
        });
        
        // Find the rating question results - match by type and title
        let questionResults = results.questions.find(q => 
          q.type === 'rating' && 
          q.title && 
          ratingQuestion.title && 
          q.title.includes(ratingQuestion.title.substring(0, 20))
        );
        
        if (!questionResults) {
          // Try matching by question type only
          questionResults = results.questions.find(q => q.type === 'rating');
        }
        
        console.log('Question results found:', questionResults);
        if (!questionResults || !questionResults.avg) {
          console.log('No rating data found for question');
          return null;
        }
        
        // Calculate total responses from counts object
        const counts = questionResults.counts || {};
        const totalResponses = Object.values(counts).reduce((sum, count) => sum + count, 0);
        console.log('Total responses:', totalResponses);
        if (totalResponses === 0) {
          console.log('No responses to calculate average');
          return null;
        }
        
        const average = questionResults.avg;
        
        console.log('Calculated rating:', { average, max: ratingQuestion.max || 5, count: totalResponses });
        
        return {
          average: average,
          max: ratingQuestion.max || 5,
          count: totalResponses
        };
      } catch (error) {
        console.error('Error getting feedback rating:', error);
        return null;
      }
    }

    // Get presenter ratings for a meeting
    async function getMeetingPresenterRatings(meetingId) {
      try {
        // Get all feedback forms for this meeting
        const forms = await apiGet(`/api/feedback/forms?meeting_id=${encodeURIComponent(meetingId)}`);
        if (!forms || !forms.length) {
          return null;
        }
        
        // Get the latest form
        const form = forms[forms.length - 1];
        if (!form || !form.questions) {
          return null;
        }
        
        // Find rating_presenter questions
        const ratingPresenterQuestions = form.questions.filter(q => q.type === 'rating_presenter');
        if (!ratingPresenterQuestions.length) {
          return null;
        }
        
        // Get form results
        const results = await apiGet(`/api/feedback/forms/${form.id}/results`);
        if (!results || !results.questions) {
          return null;
        }
        
        // Collect all presenter ratings from all rating_presenter questions
        const allPresenterRatings = {};
        
        ratingPresenterQuestions.forEach(rpQuestion => {
          const questionResults = results.questions.find(q => 
            q.type === 'rating_presenter' && 
            q.presenter_ratings
          );
          
          if (questionResults && questionResults.presenter_ratings) {
            questionResults.presenter_ratings.forEach(pr => {
              if (pr.count > 0 && pr.avg) {
                // Use presenter name as key, keep the highest count if duplicate
                if (!allPresenterRatings[pr.presenter] || 
                    allPresenterRatings[pr.presenter].count < pr.count) {
                  allPresenterRatings[pr.presenter] = {
                    presenter: pr.presenter,
                    avg: pr.avg,
                    count: pr.count
                  };
                }
              }
            });
          }
        });
        
        // Return as array sorted by average (descending)
        return Object.values(allPresenterRatings).sort((a, b) => b.avg - a.avg);
      } catch (error) {
        console.error('Error getting presenter ratings:', error);
        return null;
      }
    }

    // Get feedback response rate for a meeting
    async function getMeetingFeedbackResponseRate(meetingId, meeting) {
      try {
        // Get all feedback forms for this meeting
        const forms = await apiGet(`/api/feedback/forms?meeting_id=${encodeURIComponent(meetingId)}`);
        if (!forms || !forms.length) {
          return null;
        }
        
        // Get the latest form
        const form = forms[forms.length - 1];
        
        // Get form results to count responses
        const results = await apiGet(`/api/feedback/forms/${form.id}/results`);
        if (!results) {
          return null;
        }
        
        // Get total number of responses
        const totalResponses = results.total_responses || 0;
        
        // Get number of present participants
        const participants = meeting.participants || [];
        const presentParticipants = participants.filter(p => p.present === true);
        const presentCount = presentParticipants.length;
        
        // Calculate response rate
        if (presentCount === 0) {
          return null; // No present participants, can't calculate rate
        }
        
        const responseRate = Math.round((totalResponses / presentCount) * 100);
        
        return {
          responses: totalResponses,
          presentCount: presentCount,
          rate: responseRate
        };
      } catch (error) {
        console.error('Error getting feedback response rate:', error);
        return null;
      }
    }

    // Test function to check feedback rating
    window.testFeedbackRating = async function(meetingId) {
      console.log('Testing feedback rating for meeting:', meetingId);
      const rating = await getMeetingFeedbackRating(meetingId);
      console.log('Test result:', rating);
      return rating;
    };

    // Generate AI report for a quarter
    async function generateQuarterReport(year, quarter, meetings) {
      try {
        console.log(`Generating AI report for ${year} ${quarter}`, meetings);
        
        // Collect data from all meetings in the quarter
        const quarterData = await collectQuarterData(meetings);
        
        // Generate AI report
        const report = await generateAIReport(quarterData, `${year} ${quarter}`, 'quarter');
        
        // Generate HTML
        await generateReportHTML(report, `${year}_${quarter}_Report`);
        
      } catch (error) {
        console.error('Error generating quarter report:', error);
        alert('Error generating quarter report: ' + error.message);
      }
    }

    // Generate AI report for a year
    async function generateYearReport(year, yearData) {
      try {
        console.log(`Generating AI report for ${year}`, yearData);
        
        // Collect data from all meetings in the year
        const allMeetings = [];
        Object.values(yearData).forEach(quarterMeetings => {
          allMeetings.push(...quarterMeetings);
        });
        
        const yearDataCollected = await collectQuarterData(allMeetings);
        
        // Generate AI report
        const report = await generateAIReport(yearDataCollected, year, 'year');
        
        // Generate HTML
        await generateReportHTML(report, `${year}_Annual_Report`);
        
      } catch (error) {
        console.error('Error generating year report:', error);
        alert('Error generating year report: ' + error.message);
      }
    }
    // Collect data from meetings for AI analysis
    async function collectQuarterData(meetings) {
      const data = {
        meetings: [],
        totalMeetings: meetings.length,
        totalAttendance: 0,
        averageAttendance: 0,
        totalRatings: 0,
        averageRating: 0,
        allKPIs: [],
        allAgendas: [],
        allTitles: [],
        allTopics: [],
        meetingTypes: {},
        feedbackForms: []
      };
      let completedMeetingsCount = 0; // only meetings considered completed (not Scheduled)
      let attendancePercentSum = 0;   // sum of per-meeting attendance percentages for completed meetings
      let ratedMeetingsCount = 0;     // count of meetings that have a rating

      for (const meeting of meetings) {
        // Basic meeting data
        const meetingData = {
          id: meeting.id,
          title: meeting.title,
          date: meeting.date,
          topic: meeting.topic,
          agenda: meeting.agenda || [],
          kpis: meeting.matched_kpis || [],
          participants: meeting.participants || [],
          types: meeting.types || ['regular']
        };

        // Calculate attendance
        const attendance = attendanceStats(meeting);
        meetingData.attendance = attendance;
        // Only include completed meetings in average attendance computation
        if (isFinished(meeting)) {
          completedMeetingsCount += 1;
          // Use exact percentage per meeting (avoid rounding bias)
          const pctExact = attendance.total ? (attendance.attended * 100 / attendance.total) : 0;
          attendancePercentSum += pctExact;
        }

        // Get feedback rating
        const rating = await getMeetingFeedbackRating(meeting.id);
        if (rating) {
          meetingData.rating = rating;
          data.totalRatings += rating.average;
          ratedMeetingsCount += 1;
        }

        // Collect KPIs
        if (meeting.matched_kpis) {
          data.allKPIs.push(...meeting.matched_kpis);
        }

        // Collect agenda items
        if (meeting.agenda) {
          data.allAgendas.push(...meeting.agenda.map(a => a.title));
        }

        // Collect titles and topics
        if (meeting.title) data.allTitles.push(meeting.title);
        if (meeting.topic) data.allTopics.push(meeting.topic);

        // Count meeting types
        (meeting.types || ['regular']).forEach(type => {
          data.meetingTypes[type] = (data.meetingTypes[type] || 0) + 1;
        });

        data.meetings.push(meetingData);
      }

      // Calculate averages per requirements
      // Average attendance: mean of attendance percentages across completed meetings only
      data.averageAttendance = completedMeetingsCount > 0 ? (attendancePercentSum / completedMeetingsCount) : 0;
      // Average rating: mean across only meetings that have a rating
      data.averageRating = ratedMeetingsCount > 0 ? (data.totalRatings / ratedMeetingsCount) : 0;

      return data;
    }

    // Generate AI report using LLM
    async function generateAIReport(data, period, type) {
      // Get settings from sidebar
      const customPrompt = document.getElementById('customPrompt').value.trim();
      const reportFocus = document.getElementById('reportFocus').value;
      const reportLength = document.getElementById('reportLength').value;
      const includeCharts = document.getElementById('includeCharts').checked;
      const includeRecommendations = document.getElementById('includeRecommendations').checked;
      const includeActionItems = document.getElementById('includeActionItems').checked;

      // Build focus-specific instructions
      let focusInstructions = '';
      switch(reportFocus) {
        case 'performance':
          focusInstructions = 'Focus heavily on performance metrics, KPIs, attendance rates, and quantitative achievements.';
          break;
        case 'challenges':
          focusInstructions = 'Emphasize problems, challenges, and issues identified during the period.';
          break;
        case 'improvements':
          focusInstructions = 'Concentrate on process improvements, efficiency gains, and optimization opportunities.';
          break;
        case 'team':
          focusInstructions = 'Focus on team dynamics, collaboration, communication, and interpersonal aspects.';
          break;
        default:
          focusInstructions = 'Provide a balanced overview covering all aspects.';
      }

      // Build length instructions
      let lengthInstructions = '';
      switch(reportLength) {
        case 'brief':
          lengthInstructions = 'Keep the report concise (1-2 pages), focusing on key points only.';
          break;
        case 'detailed':
          lengthInstructions = 'Provide a comprehensive and detailed report (5+ pages) with extensive analysis.';
          break;
        default:
          lengthInstructions = 'Provide a standard-length report (3-5 pages) with good detail.';
      }

      // Build additional sections based on checkboxes
      let additionalSections = '';
      if (includeCharts) {
        additionalSections += '\n6. **Data Visualization**\n- Include suggestions for charts and graphs\n- Highlight key metrics visually\n';
      }
      if (includeRecommendations) {
        additionalSections += '\n7. **Strategic Recommendations**\n- High-level strategic recommendations\n- Long-term planning suggestions\n';
      }
      if (includeActionItems) {
        additionalSections += '\n8. **Action Items & Next Steps**\n- Specific action items with owners\n- Timeline for implementation\n- Success metrics for each action\n';
      }

      const prompt = `
        Generate a comprehensive ${type} report for QA Leadership Team covering ${period}.
        
        ${focusInstructions}
        ${lengthInstructions}
        
        Based on the following meeting data:
        - Total meetings: ${data.totalMeetings}
        - Average attendance: ${data.averageAttendance.toFixed(1)}%
        - Average rating: ${data.averageRating.toFixed(1)}/5
        - Meeting types: ${JSON.stringify(data.meetingTypes)}
        - Key topics: ${data.allTopics.join(', ')}
        - KPIs discussed: ${data.allKPIs.map(k => typeof k === 'object' ? k.kpi || k.text : k).join(', ')}
        
        ${customPrompt ? `\nAdditional Instructions:\n${customPrompt}\n` : ''}
        
        Please provide a structured report with these sections:
        
        1. **Goals & Achievements**
        - What were the main goals for this period?
        - What key achievements were accomplished?
        - What metrics show success?
        
        2. **Main Takeaways & KPIs**
        - What were the most important learnings?
        - Which KPIs were most discussed and why?
        - What insights emerged from the meetings?
        
        3. **Next ${type === 'quarter' ? 'Quarter' : 'Year'} Goals and Plans**
        - What should be the focus areas for the next period?
        - What goals should be set based on current progress?
        - What new initiatives should be considered?
        
        4. **Problems and Challenges**
        - What challenges were identified?
        - What issues need to be addressed?
        - What improvements are needed?
        
        5. **Recommendations**
        - Specific actionable recommendations
        - Process improvements
        - Resource needs${additionalSections}
        
        Format the response as a structured report with clear sections and bullet points.
      `;

      try {
        console.log('Generating AI report for:', period, type);
        console.log('Settings:', { customPrompt, reportFocus, reportLength, includeCharts, includeRecommendations, includeActionItems });
        console.log('Data being sent:', data);
        
        const response = await apiSend('/api/ai/generate-report', 'POST', {
          prompt: prompt,
          period: period,
          type: type,
          data: data,
          settings: {
            customPrompt,
            reportFocus,
            reportLength,
            includeCharts,
            includeRecommendations,
            includeActionItems
          }
        });

        console.log('AI report response:', response);

        return {
          period: period,
          type: type,
          content: response.report || response.content || response,
          data: data,
          settings: {
            customPrompt,
            reportFocus,
            reportLength,
            includeCharts,
            includeRecommendations,
            includeActionItems
          }
        };
      } catch (error) {
        console.error('Error generating AI report:', error);
        console.error('Error details:', error.message, error.stack);
        throw error;
      }
    }

    // Generate HTML from AI report
    async function generateReportHTML(report, filename) {
      try {
        console.log('Generating HTML for:', filename);
        console.log('Report data:', report);
        
        const response = await apiSend('/api/generate-report-html', 'POST', {
          report: report,
          filename: filename
        });

        console.log('HTML API response:', response);

        if (response.download_url) {
          // Show preview modal first
          showReportPreview(response.download_url, filename);
          console.log('HTML preview shown');
        } else {
          console.error('No download URL in response:', response);
          throw new Error('No download URL received');
        }
      } catch (error) {
        console.error('Error generating HTML:', error);
        console.error('Error details:', error.message, error.stack);
        throw error;
      }
    }

    // Show report preview modal
    function showReportPreview(downloadUrl, filename) {
      // Create modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 12px;
          width: 90%;
          height: 90%;
          max-width: 1200px;
          display: flex;
          flex-direction: column;
          box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
        ">
          <div style="
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h2 style="margin: 0; color: #1f2937;">Report Preview - ${filename}</h2>
            <button onclick="this.closest('.modal').remove()" style="
              background: #ef4444;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
            ">‚úï</button>
          </div>
          <div style="flex: 1; display: flex; flex-direction: column;">
            <div style="
              padding: 20px;
              border-bottom: 1px solid #e5e7eb;
              display: flex;
              gap: 12px;
            ">
              <button onclick="downloadReport('${downloadUrl}', '${filename}')" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                üì• Download HTML
              </button>
              <button onclick="openReportInNewTab('${downloadUrl}')" style="
                background: #10b981;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                üîó Open in New Tab
              </button>
            </div>
            <iframe src="${downloadUrl}" style="
              flex: 1;
              border: none;
              border-radius: 0 0 12px 12px;
            "></iframe>
          </div>
        </div>
      `;

      modal.className = 'modal';
      document.body.appendChild(modal);

      // Close on escape key
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }

    // Download report
    function downloadReport(downloadUrl, filename) {
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `${filename}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Open report in new tab
    function openReportInNewTab(downloadUrl) {
      window.open(downloadUrl, '_blank');
    }

    /* -------- Agenda editor (modal) -------- */
    async function editAgenda(mid){
      const meetings=await apiGet("/api/meetings");
      const m=meetings.find(x=>String(x.id)===String(mid));
      if(!m){ alert("Meeting not found."); return; }
      const rowsHtml = (m.agenda||[]).map((a,idx)=> agendaRowHtml(idx,a)).join("");
      const html = `
        <h3>Edit agenda</h3>
        <div id="agRows">${rowsHtml || agendaRowHtml(0,{start:"",end:"",title:"",ownerEmail:""})}</div>
        <div class="row gap mt">
          <button class="btn" id="agAdd">+ Add item</button>
          <button class="btn primary" id="agSave">Save</button>
        </div>`;
      openModal(html);
      // populate owner selects
      populateOwnerSelects();
      document.getElementById("agAdd").onclick = () => {
        const wrap=document.getElementById("agRows");
        const idx = wrap.querySelectorAll(".ag-row").length;
        wrap.insertAdjacentHTML("beforeend", agendaRowHtml(idx,{start:"",end:"",title:"",ownerEmail:""}));
        populateOwnerSelects();
      };
      document.getElementById("agSave").onclick = async () => {
        const wrap=document.getElementById("agRows");
        const rows = Array.from(wrap.querySelectorAll(".ag-row"));
        const newAgenda = rows.map(r=>{
          const start=r.querySelector(".ag-start").value.trim();
          const end=r.querySelector(".ag-end").value.trim();
          const title=r.querySelector(".ag-title").value.trim();
          const ownerEmail=(r.querySelector(".ag-owner").value||"").toLowerCase();
          const ownerName = ownerEmail ? (nameForEmail(ownerEmail)||ownerEmail) : "";
          return {start,end,title, ownerEmail, ownerName};
        }).filter(x=>x.title && x.start && x.end);

        // extend participants with missing owners
        const participants = (m.participants||[]).slice();
        const have = new Set(participants.map(p=>(p.email||"").toLowerCase()));
        newAgenda.forEach(a=>{
          if(a.ownerEmail && !have.has(a.ownerEmail)){
            participants.push({email:a.ownerEmail, name:nameForEmail(a.ownerEmail)||"", present:false});
            have.add(a.ownerEmail);
          }
        });

        try{
          await apiSend("/api/meetings","PUT",{ id:m.id, agenda:newAgenda, participants });
          closeModal(); await loadMeetings();
        }catch{ alert("Error saving agenda."); }
      };
    }
    function agendaRowHtml(i,a){
      return `<div class="ag-row item" style="align-items:flex-start">
        <div class="row gap" style="flex-wrap:wrap">
          <input class="inp ag-start" placeholder="Start" value="${escapeHtml(a.start||'')}" style="width:90px">
          <input class="inp ag-end" placeholder="End" value="${escapeHtml(a.end||'')}" style="width:90px">
          <input class="inp ag-title" placeholder="Title" value="${escapeHtml(a.title||'')}" style="min-width:220px;flex:1">
          <select class="sel ag-owner" data-val="${escapeHtml((a.ownerEmail||'').toLowerCase())}" style="min-width:220px"></select>
          <button class="btn danger" onclick="this.closest('.ag-row').remove()">Delete</button>
        </div>
      </div>`;
    }
    function populateOwnerSelects(){
      const opts = `<option value="">(Optional responsible)</option>` +
        MEMBERS.map(m=>`<option value="${(m.email||'').toLowerCase()}">${escapeHtml(m.name||m.email)} ‚Äî ${escapeHtml(m.email||'')}</option>`).join("");
      document.querySelectorAll(".ag-owner").forEach(sel=>{
        const val = sel.getAttribute("data-val") || "";
        sel.innerHTML = opts;
        sel.value = val;
      });
    }

    /* ---------- KPI AI + Newsletter (pe template) ---------- */
    async function aiKpi(mid){
      try{
        showLoading("ü§ñ AI is analyzing your meeting and finding relevant KPIs...");
        
        const meetings=await apiGet("/api/meetings"); 
        const m=meetings.find(x=>String(x.id)===String(mid)); 
        if(!m) {
          hideLoading();
          return alert("Meeting not found.");
        }
        
        // Get all KPIs from all categories and flatten them
        const categories = await apiGet("/api/kpi-categories");
        const allKpis = [];
        categories.forEach(category => {
          if (category.kpis) {
            category.kpis.forEach(kpi => {
              allKpis.push(`${kpi.name}: ${kpi.how_to_measure}`);
            });
          }
        });
        
        const payload={ title:m.title||"", topic:m.topic||"", agenda:(m.agenda||[]).map(a=>({title:a.title||""})), kpis:allKpis };
        
        const res=await apiSend("/api/kpi-match","POST",payload);
        const llmMatches=Array.isArray(res.matched_kpis)?res.matched_kpis:[]; 
        const expanded=llmMatches.map(s=>expandKpiText(String(s||""),allKpis));
        const detailed=expanded.map(full=>({ kpi:full, explanation:buildKpiExplanation(full,m) }));
        
        m.matched_kpis=detailed; 
        await apiSend("/api/meetings","PUT",{ id:m.id, matched_kpis:m.matched_kpis }); 
        await loadMeetings();
        
        hideLoading();
      }catch(e){ 
        hideLoading();
        console.error(e); 
        alert("AI KPI error."); 
      }
    }
    function newsletter(mid){
      const templates=TPL_loadAll(); if(!templates.length){ openModal(`<p>You have no templates. Create one in <strong>Templates</strong>.</p>`); return; }
      const modal=document.createElement('div');
      modal.innerHTML=`<h3>Newsletter</h3>
        <p class="muted">Choose a template. <strong>AI Copy</strong> produces a short recap (no invitations/CTA/links), based ONLY on agenda and KPIs.</p>
        <div id="nlTplList" class="mt"></div>
        <hr style="border:none;border-top:1px solid #eee;margin:12px 0">
        <div class="row gap">
          <button class="btn" id="nlAiNewsletter">üìß Newsletter</button>
          <button class="btn" id="nlAiInvite">üìÖ Meeting Invite</button>
          <button class="btn" id="nlCopy" disabled>Copy HTML</button>
          <button class="btn" id="nlDownload" disabled>Download .html</button>
        </div>
        <div id="nlPreview" class="mt"></div>`;
      openModal(modal.outerHTML);

      let selectedTpl=null, aiOverlay=null, lastHtml="";
      const listDiv=document.getElementById('nlTplList');
      templates.forEach(t=>{ const b=document.createElement('button'); b.className='btn'; b.style.marginRight='6px'; b.textContent=t.name; b.onclick=()=>{selectedTpl=t; render();}; listDiv.appendChild(b); });

      async function getMeeting(){ const ms=await apiGet("/api/meetings"); return ms.find(x=>String(x.id)===String(mid)); }

      const INVITE_RE=/(?:\bjoin\b(?:\s+(?:us|our|the))?|\bcome\b(?:\s+debate|\s+join)?|\brsvp\b|\bregister\b|\bsign\s*up\b|\bsave\s+the\s+date\b|\bsee\s+you\b|\bwe\s+invite\b|\byou(?:'| )are invited\b|\blocation\b|\bvenue\b|\bzoom\b|\bteams\b|\blink\b)/i;
      function stripLinks(s){ return String(s||'').replace(/https?:\/\/\S+/gi,'').replace(/\b(www\.[^\s]+)\b/gi,'').replace(/\s{2,}/g,' ').trim(); }
      function dropInviteSentences(s){ const parts=String(s||'').split(/(?<=[\.\!\?])\s+/); return parts.filter(p=>!INVITE_RE.test(p)).join(' ').trim(); }
      function cleanBullets(arr){
        let out=(arr||[]).map(b=>stripLinks(b)).filter(b=>b && !INVITE_RE.test(b));
        out=out.map(b=> (b.length>85 ? (b.slice(0,82)+'‚Ä¶'):b));
        const seen=new Set(); out=out.filter(b=>{const k=b.toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true;});
        return out.slice(0,6);
      }
      function normalizeOverlay(ai,m){
        const o=ai||{};
        const head=dropInviteSentences(stripLinks(o.headline||m.title||""));
        const sub=dropInviteSentences(stripLinks(o.subheadline||(`${m.date||''} ¬∑ ${m.topic||''}`).trim()));
        return { headline:head, subheadline:sub, bullets:cleanBullets(o.bullets||[]) };
      }
      function enrichIfThin(overlay, m){
        let bullets = overlay.bullets || [];
        if (bullets.length < 4){
          const agendaBullets = (m.agenda||[]).map(a => `Covered: ${a.title}`);
          const kpiRaw = (m.matched_kpis||[]).slice(0,3).map(k => (typeof k==='string'?k:(k.kpi||k.text||'')));
          const kpiBullets = kpiRaw.map(k => `KPI progress: ${k}`);
        bullets = cleanBullets(bullets.concat(agendaBullets, kpiBullets)).slice(0,6);
        }
        let headline = fixEncoding(overlay.headline || (m.title||'QA Meeting'));
        if (INVITE_RE.test(headline)) headline = fixEncoding(m.title||'QA Meeting');
        let sub = fixEncoding(overlay.subheadline || (`${m.date||''} ¬∑ ${m.topic||''}`).trim());
        if (INVITE_RE.test(sub)) sub = fixEncoding((`${m.date||''} ¬∑ ${m.topic||''}`).trim());
        return { headline, subheadline: sub, bullets: bullets.map(b => fixEncoding(b)) };
      }
      async function requestAI(m, type = 'newsletter'){
        try{
          const aiButton = document.getElementById(type === 'invite' ? 'nlAiInvite' : 'nlAiNewsletter');
          setButtonLoading(aiButton, true);
          
          let payload, endpoint;
          
          if(type === 'invite') {
            // For meeting invites - simpler content
            payload = {
              title: m.title,
              date: m.date,
              topic: m.topic,
              agenda: m.agenda || [],
              mode: "meeting_invite_simple",
              style: "invite_clean_minimal"
            };
            endpoint = "/api/newsletter-overlay";
          } else {
            // For newsletters - full content
            payload = {
            title:m.title, date:m.date, topic:m.topic,
            agenda:m.agenda||[], kpis:kpisForPayload(m.matched_kpis),
            mode:"recap_past_meeting_no_links_no_invites_v2",
            style:"short_bullets_outcomes_fun_if_applicable"
          };
            endpoint = "/api/newsletter-overlay";
          }
          
          console.log("AI Payload:", payload);
          const raw=await apiSend(endpoint,"POST",payload);
          console.log("AI API Response:", raw);
          aiOverlay = enrichIfThin(normalizeOverlay(raw,m), m);
          console.log("Processed AI Overlay:", aiOverlay);
          render(aiOverlay);
          
          setButtonLoading(aiButton, false);
        }catch{ 
          setButtonLoading(document.getElementById(type === 'invite' ? 'nlAiInvite' : 'nlAiNewsletter'), false);
          alert("AI Copy error."); 
        }
      }
      function NL_esc(s){ 
        return String(s||'')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/√¢‚Ç¨¬¢/g,'‚Ä¢')
          .replace(/√¢‚Ç¨¬¶/g,'‚Ä¶')
          .replace(/√¢‚Ç¨≈ì/g,'"')
          .replace(/√¢‚Ç¨/g,'"')
          .replace(/√¢‚Ç¨Àú/g,"'")
          .replace(/√¢‚Ç¨‚Ñ¢/g,"'")
          .replace(/√¢‚Ç¨"/g,'‚Äì')
          .replace(/√¢‚Ç¨"/g,'‚Äî');
      }
      
      function fixEncoding(text) {
        if (!text) return '';
        
        // Fix common UTF-8 encoding issues
        let result = text;
        
        // Fix bullet points and special characters
        result = result.replace(/√¢‚Ç¨¬¢/g, '‚Ä¢');
        result = result.replace(/√¢‚Ç¨¬¶/g, '‚Ä¶');
        
        // Fix quotes
        result = result.replace(/√¢‚Ç¨≈ì/g, '"');
        result = result.replace(/√¢‚Ç¨/g, '"');
        result = result.replace(/√¢‚Ç¨Àú/g, "'");
        result = result.replace(/√¢‚Ç¨‚Ñ¢/g, "'");
        
        // Fix dashes
        result = result.replace(/√¢‚Ç¨"/g, '‚Äì');
        result = result.replace(/√¢‚Ç¨"/g, '‚Äî');
        
        // Fix any remaining encoding issues with a more general approach
        result = result.replace(/√¢‚Ç¨[¬¢¬¶≈ìÀú‚Ç¨‚Ñ¢"]/g, (match) => {
          const fixes = {
            '√¢‚Ç¨¬¢': '‚Ä¢',
            '√¢‚Ç¨¬¶': '‚Ä¶',
            '√¢‚Ç¨≈ì': '"',
            '√¢‚Ç¨': '"',
            '√¢‚Ç¨Àú': "'",
            '√¢‚Ç¨‚Ñ¢': "'",
            '√¢‚Ç¨"': '‚Äì',
            '√¢‚Ç¨"': '‚Äî'
          };
          return fixes[match] || match;
        });
        
        return result;
      }
      function scale(val, base, axis){ const bw=(base?.w||360), bh=(base?.h||640); return axis==='y' ? Math.round((val||0)*(NL_H/bh)) : Math.round((val||0)*(NL_W/bw)); }
      function NL_renderOnTemplate(tpl, m, ai){
        console.log("NL_renderOnTemplate called with:", {tpl, m, ai});
        // Always use 3-zone system for AI text rendering
        console.log("Using 3-zone system for AI text rendering");
        return NL_render3ZoneTemplate(m, ai, tpl.zones || {}, tpl);
      }
      
      function NL_render3ZoneTemplate(m, ai, zones, tpl){
        const canvasWidth = NL_W; // 1080
        const canvasHeight = NL_H; // 1920
        // Ratios: top 1 unit, body 3 units, bottom 0.5 units (total 4.5 units)
        const topHeight = Math.round(canvasHeight * (1/4.5));      // ~426px
        const bodyHeight = Math.round(canvasHeight * (3/4.5));     // ~1280px  
        const bottomHeight = Math.round(canvasHeight * (0.5/4.5)); // ~214px
        
        let html = `<div style="position:relative;margin:0 auto;width:${canvasWidth}px;height:${canvasHeight}px;font-family:Arial,Helvetica,sans-serif;background:#f0f0f0;">`;
        
        // Top Zone
        if(zones && zones.top){
          html += `<div style="position:absolute;top:0;left:0;width:100%;height:${topHeight}px;background-image:url('${zones.top}');background-size:cover;background-position:center;background-repeat:no-repeat;"></div>`;
        }
        
        // Body Zone
        if(zones && zones.body){
          html += `<div style="position:absolute;top:${topHeight}px;left:0;width:100%;height:${bodyHeight}px;background-image:url('${zones.body}');background-size:cover;background-position:center;background-repeat:no-repeat;"></div>`;
        }
        
        // Bottom Zone
        if(zones && zones.bottom){
          html += `<div style="position:absolute;bottom:0;left:0;width:100%;height:${bottomHeight}px;background-image:url('${zones.bottom}');background-size:cover;background-position:center;background-repeat:no-repeat;"></div>`;
        }
        
        // Add existing template layers
        if(tpl && tpl.layers){
          const base = tpl.base || {w:360, h:640};
          const imgs = (tpl.layers||[]).filter(l=>l.type==='image').map(l=>{
            const x=scale(l.x,base,'x'), y=scale(l.y,base,'y'), w=scale(l.w,base,'x'), h=scale(l.h,base,'y'); 
            const op=(l.opacity==null?1:l.opacity);
            return `<img src="${l.src||''}" alt="" style="position:absolute;left:${x}px;top:${y}px;width:${w}px;height:${h}px;opacity:${op};z-index:5;" />`;
          }).join('');
          
          const texts = (tpl.layers||[]).filter(l=>l.type==='text').map(l=>{
            const x=scale(l.x,base,'x'), y=scale(l.y,base,'y'), w=scale(l.w,base,'x'); 
            const fs=Math.max(10,scale(l.fs||24,base,'y')); 
            const fw=l.fw||700; 
            const ta=l.ta||'center'; 
            const color=l.color||'#fff';
            return `<div style="position:absolute;left:${x}px;top:${y}px;width:${w}px;color:${color};font-weight:${fw};font-size:${fs}px;line-height:1.15;text-align:${ta};text-shadow:0 1px 2px rgba(0,0,0,.35);word-wrap:break-word;z-index:5;">${NL_esc(l.text||'')}</div>`;
          }).join('');
          
          html += imgs + texts;
        }
        
        // Add AI text as layers distributed around existing layers
        if(ai){
          console.log("AI data received:", ai);
          const bullets=(ai.bullets||[]).map(b=>`‚Ä¢ ${NL_esc(b)}`).join('<br>');
          const headline=NL_esc(ai.headline||m.title||'');
          const sub=NL_esc(ai.subheadline||(`${m.date||''} ¬∑ ${m.topic||''}`).trim());
          
          console.log("Processed text:", {headline, sub, bullets});
          
          // Use configurable AI zones
          const aiZones = tpl.aiZones || TPL_AI_ZONES;
          console.log("AI Zones being used:", aiZones);
          console.log("Template AI zones:", tpl.aiZones);
          console.log("Global TPL_AI_ZONES:", TPL_AI_ZONES);
          
          // Find existing layers and their positions
          const existingLayers = (tpl && tpl.layers) ? tpl.layers : [];
          const base = tpl?.base || {w:360, h:640};
          
          // Convert existing layers to screen coordinates
          const existingRects = existingLayers.map(l => {
            const x = scale(l.x, base, 'x');
            const y = scale(l.y, base, 'y');
            const w = l.type === 'image' ? scale(l.w, base, 'x') : scale(l.w, base, 'x');
            const h = l.type === 'image' ? scale(l.h, base, 'y') : Math.round(scale(l.fs || 24, base, 'y') * 1.5);
            return { x, y, w, h, type: l.type };
          });
          
          // Find free spaces in body zone
          const bodyStartY = topHeight;
          const bodyEndY = topHeight + bodyHeight;
          const margin = 20; // margin around existing layers
          
          // Calculate available spaces more carefully
          const spaces = [];
          
          // Helper function to check if two rectangles overlap
          function rectanglesOverlap(rect1, rect2) {
            return !(rect1.x + rect1.w <= rect2.x || 
                    rect2.x + rect2.w <= rect1.x || 
                    rect1.y + rect1.h <= rect2.y || 
                    rect2.y + rect2.h <= rect1.y);
          }
          
          // Helper function to check if a space overlaps with any existing layer
          function spaceIsFree(space) {
            const overlaps = existingRects.some(rect => rectanglesOverlap(space, rect));
            console.log(`Space ${space.x},${space.y} ${space.w}x${space.h} overlaps:`, overlaps);
            return !overlaps;
          }
          
          // Generate potential spaces around each existing layer - prioritize left/right
          existingRects.forEach(rect => {
            // Left space - HIGH PRIORITY
            if(rect.x > margin * 2) {
              const leftSpace = {
                x: margin,
                y: Math.max(bodyStartY, rect.y - margin),
                w: rect.x - margin * 2,
                h: Math.min(rect.h + margin * 2, bodyEndY - Math.max(bodyStartY, rect.y - margin)),
                priority: 1 // High priority
              };
              if(spaceIsFree(leftSpace) && leftSpace.w > 100 && leftSpace.h > 50) {
                spaces.push(leftSpace);
              }
            }
            
            // Right space - HIGH PRIORITY
            if(rect.x + rect.w < canvasWidth - margin * 2) {
              const rightSpace = {
                x: rect.x + rect.w + margin,
                y: Math.max(bodyStartY, rect.y - margin),
                w: canvasWidth - rect.x - rect.w - margin * 2,
                h: Math.min(rect.h + margin * 2, bodyEndY - Math.max(bodyStartY, rect.y - margin)),
                priority: 1 // High priority
              };
              if(spaceIsFree(rightSpace) && rightSpace.w > 100 && rightSpace.h > 50) {
                spaces.push(rightSpace);
              }
            }
            
            // Top space - MEDIUM PRIORITY
            if(rect.y > bodyStartY + margin * 2) {
              const topSpace = {
                x: Math.max(margin, rect.x - margin),
                y: bodyStartY + margin,
                w: Math.min(rect.w + margin * 2, canvasWidth - Math.max(margin, rect.x - margin)),
                h: rect.y - bodyStartY - margin * 2,
                priority: 2 // Medium priority
              };
              if(spaceIsFree(topSpace) && topSpace.w > 100 && topSpace.h > 50) {
                spaces.push(topSpace);
              }
            }
            
            // Bottom space - MEDIUM PRIORITY
            if(rect.y + rect.h < bodyEndY - margin * 2) {
              const bottomSpace = {
                x: Math.max(margin, rect.x - margin),
                y: rect.y + rect.h + margin,
                w: Math.min(rect.w + margin * 2, canvasWidth - Math.max(margin, rect.x - margin)),
                h: bodyEndY - rect.y - rect.h - margin * 2,
                priority: 2 // Medium priority
              };
              if(spaceIsFree(bottomSpace) && bottomSpace.w > 100 && bottomSpace.h > 50) {
                spaces.push(bottomSpace);
              }
            }
          });
          
          // Add some default safe spaces if no layers exist or no spaces found
          if(existingRects.length === 0 || spaces.length === 0) {
            // Left area - HIGH PRIORITY (wider)
            spaces.push({
              x: Math.round(canvasWidth * 0.02),
              y: bodyStartY + Math.round(bodyHeight * 0.1),
              w: Math.round(canvasWidth * 0.45),
              h: Math.round(bodyHeight * 0.8),
              priority: 1
            });
            
            // Right area - HIGH PRIORITY (wider)
            spaces.push({
              x: Math.round(canvasWidth * 0.53),
              y: bodyStartY + Math.round(bodyHeight * 0.1),
              w: Math.round(canvasWidth * 0.45),
              h: Math.round(bodyHeight * 0.8),
              priority: 1
            });
            
            // Top area - MEDIUM PRIORITY
            spaces.push({
              x: Math.round(canvasWidth * 0.1),
              y: bodyStartY + Math.round(bodyHeight * 0.05),
              w: Math.round(canvasWidth * 0.8),
              h: Math.round(bodyHeight * 0.25),
              priority: 2
            });
            
            // Bottom area - MEDIUM PRIORITY
            spaces.push({
              x: Math.round(canvasWidth * 0.1),
              y: bodyStartY + Math.round(bodyHeight * 0.7),
              w: Math.round(canvasWidth * 0.8),
              h: Math.round(bodyHeight * 0.25),
              priority: 2
            });
          }
          
          // If no spaces found, use default positions
          if(spaces.length === 0) {
            spaces.push({
              x: Math.round(canvasWidth * 0.08),
              y: bodyStartY + Math.round(bodyHeight * 0.1),
              w: Math.round(canvasWidth * 0.84),
              h: Math.round(bodyHeight * 0.8)
            });
          }
          
          // Sort spaces by priority first, then by area (largest first)
          spaces.sort((a, b) => {
            if(a.priority !== b.priority) {
              return a.priority - b.priority; // Lower priority number = higher priority
            }
            return (b.w * b.h) - (a.w * a.h); // Larger area first
          });
          
          console.log("Available spaces:", spaces);
          console.log("Existing layers:", existingRects);
          
          // Place AI text in available spaces
          let spaceIndex = 0;
          
          // Always use default spaces if no custom spaces found
          if(spaces.length === 0) {
            console.log("No custom spaces found, using default spaces");
            // Left side - top
            spaces.push({
              x: 20,
              y: bodyStartY + 50,
              w: Math.round(canvasWidth * 0.4),
              h: 150,
              priority: 1
            });
            // Right side - top
            spaces.push({
              x: Math.round(canvasWidth * 0.55),
              y: bodyStartY + 50,
              w: Math.round(canvasWidth * 0.4),
              h: 150,
              priority: 1
            });
            // Left side - middle
            spaces.push({
              x: 20,
              y: bodyStartY + 250,
              w: Math.round(canvasWidth * 0.4),
              h: 150,
              priority: 1
            });
            // Right side - middle
            spaces.push({
              x: Math.round(canvasWidth * 0.55),
              y: bodyStartY + 250,
              w: Math.round(canvasWidth * 0.4),
              h: 150,
              priority: 1
            });
            // Center - top
            spaces.push({
              x: Math.round(canvasWidth * 0.1),
              y: bodyStartY + 50,
              w: Math.round(canvasWidth * 0.8),
              h: 100,
              priority: 2
            });
          }
          
          // Force some spaces if we still don't have any
          if(spaces.length === 0) {
            console.log("Still no spaces, forcing default");
            spaces.push({
              x: 50,
              y: bodyStartY + 100,
              w: 300,
              h: 200,
              priority: 1
            });
            spaces.push({
              x: 400,
              y: bodyStartY + 100,
              w: 300,
              h: 200,
              priority: 1
            });
            spaces.push({
              x: 100,
              y: bodyStartY + 400,
              w: 600,
              h: 150,
              priority: 2
            });
          }
          
          // Simple, clean text placement in predefined zones
          console.log("Placing AI text in predefined zones");
          
          // Zone 1: Headline
          if(headline) {
            console.log("Rendering headline:", headline);
            console.log("Headline zone config:", aiZones.headline);
            const zoneX = Math.round(canvasWidth * (aiZones.headline.x / 100));
            const zoneY = bodyStartY + Math.round(bodyHeight * (aiZones.headline.y / 100));
            const zoneWidth = Math.round(canvasWidth * (aiZones.headline.w / 100));
            const zoneHeight = Math.round(bodyHeight * (aiZones.headline.h / 100));
            const fontSize = Math.min(24, Math.max(16, Math.round(zoneWidth / 15)));
            
            console.log("Headline position:", {zoneX, zoneY, zoneWidth, zoneHeight, fontSize});
            
            html += `
              <div style="position:absolute;left:${zoneX}px;top:${zoneY}px;width:${zoneWidth}px;height:${zoneHeight}px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.7);font-size:${fontSize}px;font-weight:800;line-height:1.2;text-align:center;z-index:10;word-wrap:break-word;padding:10px;box-sizing:border-box;display:flex;align-items:center;justify-content:center;">${headline}</div>
            `;
          }
          
          // Zone 2: Subheadline
          if(sub) {
            const zoneX = Math.round(canvasWidth * (aiZones.sub.x / 100));
            const zoneY = bodyStartY + Math.round(bodyHeight * (aiZones.sub.y / 100));
            const zoneWidth = Math.round(canvasWidth * (aiZones.sub.w / 100));
            const zoneHeight = Math.round(bodyHeight * (aiZones.sub.h / 100));
            const fontSize = Math.min(18, Math.max(12, Math.round(zoneWidth / 12)));
            
            html += `
              <div style="position:absolute;left:${zoneX}px;top:${zoneY}px;width:${zoneWidth}px;height:${zoneHeight}px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.6);font-size:${fontSize}px;font-weight:600;line-height:1.3;text-align:left;z-index:10;word-wrap:break-word;padding:8px;box-sizing:border-box;">${sub}</div>
            `;
          }
          
          // Zone 3: Bullets (multiple zones)
          if(bullets && aiZones.bullets && aiZones.bullets.length > 0) {
            console.log("Rendering bullets:", bullets);
            console.log("Bullets zones config:", aiZones.bullets);
            // Split bullets into multiple zones
            const bulletLines = bullets.split('<br>');
            const bulletsPerZone = Math.ceil(bulletLines.length / aiZones.bullets.length);
            
            console.log("Bullet lines:", bulletLines);
            console.log("Bullets per zone:", bulletsPerZone);
            
            aiZones.bullets.forEach((bulletZone, index) => {
              const startIndex = index * bulletsPerZone;
              const endIndex = Math.min(startIndex + bulletsPerZone, bulletLines.length);
              const zoneBullets = bulletLines.slice(startIndex, endIndex).join('<br>');
              
              console.log(`Bullets zone ${index}:`, {startIndex, endIndex, zoneBullets});
              
              if(zoneBullets.trim()) {
                const zoneX = Math.round(canvasWidth * (bulletZone.x / 100));
                const zoneY = bodyStartY + Math.round(bodyHeight * (bulletZone.y / 100));
                const zoneWidth = Math.round(canvasWidth * (bulletZone.w / 100));
                const zoneHeight = Math.round(bodyHeight * (bulletZone.h / 100));
                const fontSize = Math.min(16, Math.max(10, Math.round(zoneWidth / 15)));
                
                console.log(`Bullets zone ${index} position:`, {zoneX, zoneY, zoneWidth, zoneHeight, fontSize});
                
                html += `
                  <div style="position:absolute;left:${zoneX}px;top:${zoneY}px;width:${zoneWidth}px;height:${zoneHeight}px;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.6);font-size:${fontSize}px;line-height:1.4;text-align:left;z-index:10;word-wrap:break-word;padding:8px;box-sizing:border-box;">${zoneBullets}</div>
                `;
              }
            });
          } else {
            console.log("No bullets to render or no bullets zones configured");
            console.log("Bullets:", bullets);
            console.log("AI zones bullets:", aiZones.bullets);
          }
        }
        
        html += `</div>`;
        return html;
      }
      function render(aiData = null){
        const area=document.getElementById('nlPreview'), btnC=document.getElementById('nlCopy'), btnD=document.getElementById('nlDownload');
        if(!selectedTpl){ area.innerHTML=`<div class="muted">Select a template.</div>`; btnC.disabled=btnD.disabled=true; return; }
        getMeeting().then(m=>{
          const aiToUse = aiData || aiOverlay;
          console.log("Render function - AI data to use:", aiToUse);
          lastHtml=NL_renderOnTemplate(selectedTpl,m,aiToUse);
          area.innerHTML=`<iframe style="width:100%;height:400px;border:1px solid #eaedf4;border-radius:10px;" srcdoc="${lastHtml.replaceAll('"','&quot;')}"></iframe>`;
          btnC.disabled=btnD.disabled=!aiToUse;
          btnC.onclick=()=>navigator.clipboard.writeText(lastHtml);
          btnD.onclick=()=>{ const blob=new Blob([lastHtml],{type:'text/html'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(selectedTpl.name||'newsletter')+'.html'; a.click(); URL.revokeObjectURL(a.href); };
        });
      }
      document.getElementById('nlAiNewsletter').onclick=async()=>{ if(!selectedTpl){ alert("Choose a template first."); return; } const m=await getMeeting(); await requestAI(m, 'newsletter'); };
      document.getElementById('nlAiInvite').onclick=async()=>{ if(!selectedTpl){ alert("Choose a template first."); return; } const m=await getMeeting(); await requestAI(m, 'invite'); };
    }

    /* ---------- Templates ‚Äì localStorage ---------- */
    const TPL_KEY='qa_img_templates_v4';
    let TPL_LIST=[], TPL_CURRENT=null;

    function TPL_loadAll(){ 
      try{ 
        const data = localStorage.getItem(TPL_KEY);
        return JSON.parse(data||'[]'); 
      }catch(e){
        return [];
      }
    }
    function TPL_saveAll(arr){ localStorage.setItem(TPL_KEY, JSON.stringify(arr)); }
    function TPL_init(){ 
      TPL_LIST=TPL_loadAll(); 
      TPL_renderList(); 
      TPL_renderTemplateSelector(); 
      TPL_renderBulletsZonesConfig(); // Initialize bullets zones config
      if(!TPL_CURRENT && TPL_LIST.length) TPL_edit(TPL_LIST[0].id); 
      TPL_renderStage(); 
    }
    function TPL_new(){ 
      TPL_CURRENT=null; 
      document.getElementById('tplName').value=''; 
      const st=document.getElementById('tplStage'); 
      st.style.backgroundImage='none'; 
      document.getElementById('tplLayers').innerHTML=''; 
      
      // Clear zones
      TPL_ZONES = {top: null, body: null, bottom: null};
      TPL_updateZonePreview('top', null);
      TPL_updateZonePreview('body', null);
      TPL_updateZonePreview('bottom', null);
      document.getElementById('topZoneFile').value='';
      document.getElementById('bodyZoneFile').value='';
      document.getElementById('bottomZoneFile').value='';
      
      // Hide delete button
      document.getElementById('deleteBtn').style.display = 'none';
      
      TPL_renderStage(); 
    }
    function TPL_save(){
      const name=document.getElementById('tplName').value.trim(); 
      if(!name){ alert('Set template name.'); return; }
      
      const st=document.getElementById('tplStage');
      const baseW=Math.floor(st.clientWidth), baseH=Math.floor(st.clientHeight);
      
      // Collect layers
      const layers=Array.from(document.querySelectorAll('.tpl-layer-row')).map(r=>{
        const type=r.dataset.type;
        if(type==='image') return { type:'image', id:r.dataset.id, src:r.querySelector('.tpl-layer-src').value, x:+r.querySelector('.tpl-layer-x').value||0, y:+r.querySelector('.tpl-layer-y').value||0, w:+r.querySelector('.tpl-layer-w').value||120, h:+r.querySelector('.tpl-layer-h').value||120, opacity:parseFloat(r.querySelector('.tpl-layer-op').value||'1') };
        return { type:'text', id:r.dataset.id, text:r.querySelector('.tpl-layer-text').value||'', x:+r.querySelector('.tpl-layer-x').value||0, y:+r.querySelector('.tpl-layer-y').value||0, w:+r.querySelector('.tpl-layer-w').value||260, fs:+r.querySelector('.tpl-layer-fs').value||24, fw:+r.querySelector('.tpl-layer-fw').value||700, color:r.querySelector('.tpl-layer-color').value||'#ffffff', ta:r.querySelector('.tpl-layer-ta').value||'center' };
      });
      
      // Check if we have 3-zone system or traditional background
      const hasZones = TPL_ZONES.top || TPL_ZONES.body || TPL_ZONES.bottom;
      const bg = st.style.backgroundImage?.replace(/^url\((.+)\)$/,'$1').replaceAll('"','');
      
      if(!hasZones && !bg){ 
        alert('Set background image or upload zone images.'); 
        return; 
      }
      
      const item={ 
        id:TPL_CURRENT||('tpl_'+Math.random().toString(36).slice(2,9)), 
        name, 
        img: hasZones ? null : {data:bg}, 
        base:{w:baseW,h:baseH}, 
        layers, 
        zones: hasZones ? {...TPL_ZONES} : null,
        aiZones: {...TPL_AI_ZONES},
        created_at:Date.now() 
      };
      
      const idx=TPL_LIST.findIndex(x=>x.id===item.id); 
      if(idx>=0) TPL_LIST[idx]=item; else TPL_LIST.unshift(item);
      
      TPL_saveAll(TPL_LIST); 
      TPL_CURRENT=item.id; 
      TPL_renderList(); 
      TPL_renderTemplateSelector();
      TPL_edit(item.id);
      
      alert('Template saved successfully!');
    }
    function TPL_edit(id){ 
      const t=TPL_LIST.find(x=>x.id===id); 
      if(!t) return; 
      TPL_CURRENT=id; 
      document.getElementById('tplName').value=t.name; 
      const st=document.getElementById('tplStage'); 
      
      // Load zones if available
      if(t.zones){
        TPL_ZONES = {...t.zones};
        TPL_updateZonePreview('top', TPL_ZONES.top);
        TPL_updateZonePreview('body', TPL_ZONES.body);
        TPL_updateZonePreview('bottom', TPL_ZONES.bottom);
        
        // Load AI zones
        TPL_loadAIZonesFromTemplate(t);
        st.style.backgroundImage='none';
      } else {
        // Clear zones and load traditional background
        TPL_ZONES = {top: null, body: null, bottom: null};
        TPL_updateZonePreview('top', null);
        TPL_updateZonePreview('body', null);
        TPL_updateZonePreview('bottom', null);
        if(t.img?.data) st.style.backgroundImage=`url("${t.img.data}")`;
      }
      
      TPL_renderLayerControls(t.layers||[]); 
      TPL_renderStage();
      
      // Show delete button
      document.getElementById('deleteBtn').style.display = 'inline-block'; 
    }
    function TPL_delete(id){ if(!confirm('Delete this template?')) return; TPL_LIST=TPL_LIST.filter(x=>x.id!==id); TPL_saveAll(TPL_LIST); TPL_renderList(); if(TPL_CURRENT===id) TPL_new(); TPL_renderStage(); }
    function TPL_renderList(){ 
      // This function is not used in the current UI - templates are shown in dropdown
      // Keeping for compatibility but not rendering anything
    }
    
    function TPL_renderTemplateSelector(){
      const selector = document.getElementById('templateSelector');
      if(!selector) return;
      selector.innerHTML = '<option value="">Select a template...</option>';
      TPL_LIST.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        if(t.id === TPL_CURRENT) option.selected = true;
        selector.appendChild(option);
      });
    }
    
    function TPL_selectTemplate(templateId){
      if(!templateId) {
        document.getElementById('deleteBtn').style.display = 'none';
        return;
      }
      TPL_edit(templateId);
      document.getElementById('deleteBtn').style.display = 'inline-block';
    }
    
    function TPL_deleteCurrent(){
      if(!TPL_CURRENT) return;
      if(!confirm('Delete this template?')) return;
      
      TPL_LIST = TPL_LIST.filter(x => x.id !== TPL_CURRENT);
      TPL_saveAll(TPL_LIST);
      TPL_renderTemplateSelector();
      TPL_new();
      document.getElementById('deleteBtn').style.display = 'none';
    }
    
    
    // 3-Zone Template System Functions
    let TPL_ZONES = {
      top: null,
      body: null,
      bottom: null
    };
    
    let TPL_AI_ZONES = {
      headline: { x: 10, y: 1.5, w: 80, h: 8 },
      sub: { x: 1.8, y: 6.25, w: 35, h: 10 },
      bullets: [
        { x: 63.2, y: 6.25, w: 35, h: 15 }
      ]
    };
    
    function TPL_loadZoneImage(zone, input){
      const file = input.files && input.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = e => {
        const data = e.target.result;
        TPL_ZONES[zone] = data;
        TPL_updateZonePreview(zone, data);
        TPL_renderStage();
      };
      reader.readAsDataURL(file);
    }
    
    function TPL_clearZone(zone){
      TPL_ZONES[zone] = null;
      TPL_updateZonePreview(zone, null);
      document.getElementById(zone + 'ZoneFile').value = '';
      TPL_renderStage();
    }
    
    function TPL_updateZonePreview(zone, data){
      const preview = document.getElementById(zone + 'ZonePreview');
      if(!preview) return;
      
      if(data){
        preview.innerHTML = `<img src="${data}" alt="${zone} zone preview" />`;
      } else {
        preview.innerHTML = `<div class="muted">No image uploaded for ${zone} zone</div>`;
      }
    }
    function TPL_render3ZoneTemplate(){
      const stage = document.getElementById('tplStage');
      if(!stage) return;
      
      stage.innerHTML = '';
      
      // Calculate dimensions for 1080x1920 canvas
      // Ratios: top 1 unit, body 3 units, bottom 0.5 units (total 4.5 units)
      const canvasWidth = 1080;
      const canvasHeight = 1920;
      const topHeight = Math.round(canvasHeight * (1/4.5));      // ~426px
      const bodyHeight = Math.round(canvasHeight * (3/4.5));     // ~1280px  
      const bottomHeight = Math.round(canvasHeight * (0.5/4.5)); // ~214px
      
      // Create container
      const container = document.createElement('div');
      container.style.cssText = `
        position: relative;
        width: 100%;
        height: 100%;
        background: #f0f0f0;
        overflow: hidden;
      `;
      
      // Top Zone
      if(TPL_ZONES.top){
        const topZone = document.createElement('div');
        topZone.style.cssText = `
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: ${(topHeight/canvasHeight)*100}%;
          background-image: url('${TPL_ZONES.top}');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
        `;
        container.appendChild(topZone);
      }
      
      // Body Zone
      if(TPL_ZONES.body){
        const bodyZone = document.createElement('div');
        bodyZone.style.cssText = `
          position: absolute;
          top: ${(topHeight/canvasHeight)*100}%;
          left: 0;
          width: 100%;
          height: ${(bodyHeight/canvasHeight)*100}%;
          background-image: url('${TPL_ZONES.body}');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
        `;
        container.appendChild(bodyZone);
        
        // Add AI zones overlay
        TPL_renderAIZonesOverlay(container, topHeight, bodyHeight, canvasHeight);
      }
      
      // Bottom Zone
      if(TPL_ZONES.bottom){
        const bottomZone = document.createElement('div');
        bottomZone.style.cssText = `
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: ${(bottomHeight/canvasHeight)*100}%;
          background-image: url('${TPL_ZONES.bottom}');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
        `;
        container.appendChild(bottomZone);
      }
      
      stage.appendChild(container);
    }
    
    function TPL_renderAIZonesOverlay(container, topHeight, bodyHeight, canvasHeight){
      // Create AI zones overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: absolute;
        top: ${(topHeight/canvasHeight)*100}%;
        left: 0;
        width: 100%;
        height: ${(bodyHeight/canvasHeight)*100}%;
        pointer-events: auto;
        z-index: 5;
      `;
      
      // Headline zone
      const headlineZone = TPL_createDraggableAIZone('headline', TPL_AI_ZONES.headline, '#ef4444', 'AI Headline Zone');
      overlay.appendChild(headlineZone);
      
      // Subheadline zone
      const subZone = TPL_createDraggableAIZone('sub', TPL_AI_ZONES.sub, '#3b82f6', 'AI Subheadline Zone');
      overlay.appendChild(subZone);
      
      // Bullets zones (multiple)
      TPL_AI_ZONES.bullets.forEach((bulletZone, index) => {
        const bulletsZone = TPL_createDraggableAIZone(`bullets_${index}`, bulletZone, '#10b981', `AI Bullets Zone ${index + 1}`);
        overlay.appendChild(bulletsZone);
      });
      
      container.appendChild(overlay);
    }
    
    function TPL_createDraggableAIZone(zoneType, zone, color, label){
      const zoneDiv = document.createElement('div');
      zoneDiv.className = 'ai-zone-draggable';
      zoneDiv.dataset.zoneType = zoneType;
      zoneDiv.style.cssText = `
        position: absolute;
        top: ${zone.y}%;
        left: ${zone.x}%;
        width: ${zone.w}%;
        height: ${zone.h}%;
        background: rgba(${color === '#ef4444' ? '239, 68, 68' : color === '#3b82f6' ? '59, 130, 246' : '16, 185, 129'}, 0.2);
        border: 2px dashed ${color};
        display: flex;
        align-items: center;
        justify-content: center;
        color: ${color};
        font-size: 12px;
        font-weight: bold;
        cursor: move;
        user-select: none;
        resize: both;
        overflow: hidden;
        min-width: 50px;
        min-height: 30px;
      `;
      
      // Add text content
      const textDiv = document.createElement('div');
      textDiv.textContent = label;
      textDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      `;
      zoneDiv.appendChild(textDiv);
      
      // Add resize handles
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle';
      resizeHandle.style.cssText = `
        position: absolute;
        bottom: 0;
        right: 0;
        width: 20px;
        height: 20px;
        background: #ff0000;
        cursor: se-resize;
        border-radius: 0 0 4px 0;
        z-index: 20;
        pointer-events: auto;
        border: 2px solid #ffffff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      `;
      
      // Resize handle will be handled by TPL_makeDraggable function
      
      zoneDiv.appendChild(resizeHandle);
      
      // Make draggable
      TPL_makeDraggable(zoneDiv, zoneType);
      
      return zoneDiv;
    }
    
    function TPL_makeDraggable(element, zoneType){
      let isDragging = false;
      let isResizing = false;
      let startX, startY, startLeft, startTop, startWidth, startHeight;
      
      element.addEventListener('mousedown', (e) => {
        console.log('AI Zone mousedown:', e.target, e.target.classList.contains('resize-handle'));
        if(e.target.classList.contains('resize-handle')){
          console.log('Starting resize for AI zone:', zoneType);
          e.stopPropagation();
          e.preventDefault();
          
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = element.offsetWidth;
          startHeight = element.offsetHeight;
          
          const handleMouseMove = (e) => {
            if(isResizing){
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              const newWidth = Math.max(50, startWidth + deltaX);
              const newHeight = Math.max(30, startHeight + deltaY);
              
              // Convert to percentages
              const parentWidth = element.parentElement.offsetWidth;
              const parentHeight = element.parentElement.offsetHeight;
              
              const newWidthPercent = Math.max(5, Math.min(100 - (element.offsetLeft / parentWidth * 100), (newWidth / parentWidth) * 100));
              const newHeightPercent = Math.max(2, Math.min(100 - (element.offsetTop / parentHeight * 100), (newHeight / parentHeight) * 100));
              
              element.style.width = newWidthPercent + '%';
              element.style.height = newHeightPercent + '%';
              
              // Update TPL_AI_ZONES
              if(zoneType.startsWith('bullets_')) {
                const index = parseInt(zoneType.split('_')[1]);
                TPL_AI_ZONES.bullets[index].w = newWidthPercent;
                TPL_AI_ZONES.bullets[index].h = newHeightPercent;
              } else {
                TPL_AI_ZONES[zoneType].w = newWidthPercent;
                TPL_AI_ZONES[zoneType].h = newHeightPercent;
              }
              
              console.log('Resizing zone:', zoneType, 'to', newWidthPercent + '%', 'x', newHeightPercent + '%');
            }
          };
          
          const handleMouseUp = () => {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            
            // Update form inputs
            TPL_updateFormInputs(zoneType);
            console.log('AI zone resize completed for:', zoneType);
          };
          
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        } else {
          console.log('Starting drag for AI zone:', zoneType);
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startLeft = element.offsetLeft;
          startTop = element.offsetTop;
          
          const handleMouseMove = (e) => {
            if(isDragging){
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              const newLeft = startLeft + deltaX;
              const newTop = startTop + deltaY;
              
              // Convert to percentages
              const parentWidth = element.parentElement.offsetWidth;
              const parentHeight = element.parentElement.offsetHeight;
              
              const newLeftPercent = Math.max(0, Math.min(100 - (element.offsetWidth / parentWidth * 100), (newLeft / parentWidth) * 100));
              const newTopPercent = Math.max(0, Math.min(100 - (element.offsetHeight / parentHeight * 100), (newTop / parentHeight) * 100));
              
              element.style.left = newLeftPercent + '%';
              element.style.top = newTopPercent + '%';
              
              // Update TPL_AI_ZONES
              if(zoneType.startsWith('bullets_')) {
                const index = parseInt(zoneType.split('_')[1]);
                TPL_AI_ZONES.bullets[index].x = newLeftPercent;
                TPL_AI_ZONES.bullets[index].y = newTopPercent;
              } else {
                TPL_AI_ZONES[zoneType].x = newLeftPercent;
                TPL_AI_ZONES[zoneType].y = newTopPercent;
              }
            }
          };
          
          const handleMouseUp = () => {
            isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            
            // Update form inputs
            TPL_updateFormInputs(zoneType);
            console.log('AI zone drag completed for:', zoneType);
          };
          
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }
        e.preventDefault();
      });
    }
    
    function TPL_updateFormInputs(zoneType){
      let zone;
      if(zoneType.startsWith('bullets_')) {
        const index = parseInt(zoneType.split('_')[1]);
        zone = TPL_AI_ZONES.bullets[index];
      } else {
        zone = TPL_AI_ZONES[zoneType];
      }
      
      if(document.getElementById(zoneType + 'X')){
        document.getElementById(zoneType + 'X').value = zone.x.toFixed(1);
        document.getElementById(zoneType + 'Y').value = zone.y.toFixed(1);
        document.getElementById(zoneType + 'W').value = zone.w.toFixed(1);
        document.getElementById(zoneType + 'H').value = zone.h.toFixed(1);
      }
    }
    
    function TPL_updateAIZones(){
      // Update AI zones from form inputs
      TPL_AI_ZONES.headline = {
        x: parseFloat(document.getElementById('headlineX').value) || 10,
        y: parseFloat(document.getElementById('headlineY').value) || 1.5,
        w: parseFloat(document.getElementById('headlineW').value) || 80,
        h: parseFloat(document.getElementById('headlineH').value) || 8
      };
      
      TPL_AI_ZONES.sub = {
        x: parseFloat(document.getElementById('subX').value) || 1.8,
        y: parseFloat(document.getElementById('subY').value) || 6.25,
        w: parseFloat(document.getElementById('subW').value) || 35,
        h: parseFloat(document.getElementById('subH').value) || 10
      };
      
      // Update bullets zones from form inputs
      TPL_AI_ZONES.bullets.forEach((bulletZone, index) => {
        const prefix = `bullets_${index}`;
        if(document.getElementById(prefix + 'X')) {
          bulletZone.x = parseFloat(document.getElementById(prefix + 'X').value) || bulletZone.x;
          bulletZone.y = parseFloat(document.getElementById(prefix + 'Y').value) || bulletZone.y;
          bulletZone.w = parseFloat(document.getElementById(prefix + 'W').value) || bulletZone.w;
          bulletZone.h = parseFloat(document.getElementById(prefix + 'H').value) || bulletZone.h;
        }
      });
      
      // Re-render the stage with new zones
      TPL_renderStage();
    }
    
    function TPL_addBulletsZone(){
      // Add a new bullets zone with default position
      const newZone = {
        x: 10 + (TPL_AI_ZONES.bullets.length * 25), // Offset each new zone
        y: 20 + (TPL_AI_ZONES.bullets.length * 10), // Offset vertically too
        w: 30,
        h: 12
      };
      TPL_AI_ZONES.bullets.push(newZone);
      TPL_renderBulletsZonesConfig();
      TPL_renderStage();
      console.log('Added bullets zone:', newZone);
    }
    
    function TPL_removeBulletsZone(){
      if(TPL_AI_ZONES.bullets.length > 1) {
        TPL_AI_ZONES.bullets.pop();
        TPL_renderBulletsZonesConfig();
        TPL_renderStage();
        console.log('Removed bullets zone. Remaining:', TPL_AI_ZONES.bullets.length);
      } else {
        alert('Cannot remove the last bullets zone. At least one is required.');
      }
    }
    
    function TPL_renderBulletsZonesConfig(){
      const container = document.getElementById('bulletsZonesConfig');
      if(!container) return;
      
      container.innerHTML = '';
      
      TPL_AI_ZONES.bullets.forEach((bulletZone, index) => {
        const zoneDiv = document.createElement('div');
        zoneDiv.className = 'bullets-zone-config';
        zoneDiv.style.cssText = 'margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;';
        
        zoneDiv.innerHTML = `
          <div class="row gap align-center" style="margin-bottom: 5px;">
            <label style="font-weight: bold; min-width: 120px;">Bullets Zone ${index + 1}:</label>
            <button class="btn danger small" onclick="TPL_removeSpecificBulletsZone(${index})" ${TPL_AI_ZONES.bullets.length <= 1 ? 'disabled' : ''}>Remove</button>
          </div>
          <div class="row gap">
            <input type="number" id="bullets_${index}X" value="${bulletZone.x}" min="0" max="100" class="inp small" placeholder="X %" onchange="TPL_updateAIZones()">
            <input type="number" id="bullets_${index}Y" value="${bulletZone.y}" min="0" max="100" class="inp small" placeholder="Y %" onchange="TPL_updateAIZones()">
            <input type="number" id="bullets_${index}W" value="${bulletZone.w}" min="10" max="100" class="inp small" placeholder="Width %" onchange="TPL_updateAIZones()">
            <input type="number" id="bullets_${index}H" value="${bulletZone.h}" min="1" max="20" class="inp small" placeholder="Height %" onchange="TPL_updateAIZones()">
          </div>
        `;
        
        container.appendChild(zoneDiv);
      });
    }
    
    function TPL_removeSpecificBulletsZone(index){
      if(TPL_AI_ZONES.bullets.length > 1) {
        TPL_AI_ZONES.bullets.splice(index, 1);
        TPL_renderBulletsZonesConfig();
        TPL_renderStage();
        console.log('Removed bullets zone at index:', index);
      } else {
        alert('Cannot remove the last bullets zone. At least one is required.');
      }
    }
    
    function TPL_loadAIZonesFromTemplate(template){
      if(template.aiZones){
        TPL_AI_ZONES = {...template.aiZones};
        
        // Ensure bullets is an array for backward compatibility
        if(!Array.isArray(TPL_AI_ZONES.bullets)) {
          TPL_AI_ZONES.bullets = [TPL_AI_ZONES.bullets || { x: 63.2, y: 6.25, w: 35, h: 15 }];
        }
        
        // Update form inputs
        document.getElementById('headlineX').value = TPL_AI_ZONES.headline.x;
        document.getElementById('headlineY').value = TPL_AI_ZONES.headline.y;
        document.getElementById('headlineW').value = TPL_AI_ZONES.headline.w;
        document.getElementById('headlineH').value = TPL_AI_ZONES.headline.h;
        
        document.getElementById('subX').value = TPL_AI_ZONES.sub.x;
        document.getElementById('subY').value = TPL_AI_ZONES.sub.y;
        document.getElementById('subW').value = TPL_AI_ZONES.sub.w;
        document.getElementById('subH').value = TPL_AI_ZONES.sub.h;
        
        // Render bullets zones config
        TPL_renderBulletsZonesConfig();
      }
    }
    function TPL_addImageLayer(){ const wrap=document.getElementById('tplLayers'); const id='ly_'+Math.random().toString(36).slice(2,9); const row=document.createElement('div'); row.className='item tpl-layer-row'; row.dataset.id=id; row.dataset.type='image';
      row.innerHTML=`<div class="row gap" style="flex-wrap:wrap"><span class="chip">Image</span><input class="inp tpl-layer-src" style="min-width:260px" placeholder="(data URL) ‚Äì click Upload" /><input type="file" accept="image/*" class="inp" style="width:220px" onchange="TPL_pickImage(this)" /><input class="inp tpl-layer-x" type="number" style="width:90px" placeholder="x" value="30" onchange="TPL_renderStage()" /><input class="inp tpl-layer-y" type="number" style="width:90px" placeholder="y" value="30" onchange="TPL_renderStage()" /><input class="inp tpl-layer-w" type="number" style="width:110px" placeholder="width" value="120" onchange="TPL_renderStage()" /><input class="inp tpl-layer-h" type="number" style="width:110px" placeholder="height" value="120" onchange="TPL_renderStage()" /><input class="inp tpl-layer-op" type="number" step="0.1" min="0" max="1" style="width:110px" placeholder="opacity" value="1" onchange="TPL_renderStage()" /><button class="btn danger" onclick="this.closest('.tpl-layer-row').remove(); TPL_renderStage();">Remove</button></div>`; wrap.appendChild(row); TPL_renderStage(); }
    function TPL_addTextLayer(){ const wrap=document.getElementById('tplLayers'); const id='ly_'+Math.random().toString(36).slice(2,9); const row=document.createElement('div'); row.className='item tpl-layer-row'; row.dataset.id=id; row.dataset.type='text';
      row.innerHTML=`<div class="row gap" style="flex-wrap:wrap"><span class="chip">Text</span><input class="inp tpl-layer-text" style="min-width:260px" placeholder="Text" value="TITLE" onchange="TPL_renderStage()" /><input class="inp tpl-layer-x" type="number" style="width:90px" placeholder="x" value="40" onchange="TPL_renderStage()" /><input class="inp tpl-layer-y" type="number" style="width:90px" placeholder="y" value="80" onchange="TPL_renderStage()" /><input class="inp tpl-layer-w" type="number" style="width:110px" placeholder="width" value="280" onchange="TPL_renderStage()" /><input class="inp tpl-layer-fs" type="number" style="width:110px" placeholder="font-size" value="28" onchange="TPL_renderStage()" /><select class="inp tpl-layer-fw" style="width:120px" onchange="TPL_renderStage()"><option value="600">Semi-bold</option><option value="700" selected>Bold</option><option value="800">Extra-bold</option></select><input class="inp tpl-layer-color" type="color" style="width:70px" value="#ffffff" onchange="TPL_renderStage()" /><select class="inp tpl-layer-ta" style="width:120px" onchange="TPL_renderStage()"><option>left</option><option selected>center</option><option>right</option></select><button class="btn danger" onclick="this.closest('.tpl-layer-row').remove(); TPL_renderStage();">Remove</button></div>`; wrap.appendChild(row); TPL_renderStage(); }
    function TPL_pickImage(input){ const f=input.files&&input.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const data=e.target.result; const row=input.closest('.tpl-layer-row'); row.querySelector('.tpl-layer-src').value=data; TPL_renderStage(); }; r.readAsDataURL(f); }
    function TPL_renderLayerControls(layers){ const wrap=document.getElementById('tplLayers'); wrap.innerHTML=''; (layers||[]).forEach(l=>{ if(l.type==='image'){ TPL_addImageLayer(); const row=wrap.lastElementChild; row.dataset.id=l.id; row.querySelector('.tpl-layer-src').value = l.src || ''; row.querySelector('.tpl-layer-x').value=l.x||0; row.querySelector('.tpl-layer-y').value=l.y||0; row.querySelector('.tpl-layer-w').value=l.w||120; row.querySelector('.tpl-layer-h').value=l.h||120; row.querySelector('.tpl-layer-op').value=(l.opacity==null?1:l.opacity); } else { TPL_addTextLayer(); const row=wrap.lastElementChild; row.dataset.id=l.id; row.querySelector('.tpl-layer-text').value=l.text||''; row.querySelector('.tpl-layer-x').value=l.x||0; row.querySelector('.tpl-layer-y').value=l.y||0; row.querySelector('.tpl-layer-w').value=l.w||260; row.querySelector('.tpl-layer-fs').value=l.fs||28; row.querySelector('.tpl-layer-fw').value=l.fw||700; row.querySelector('.tpl-layer-color').value=l.color||'#ffffff'; row.querySelector('.tpl-layer-ta').value=l.ta||'center'; } }); }
    function TPL_renderStage(){
      const st=document.getElementById('tplStage'); 
      const stageW=Math.floor(st.clientWidth), stageH=Math.floor(stageW*16/9); 
      st.style.height=stageH+'px';
      
      // Always render 3-zone system if we have zone images, plus layers
      if(TPL_ZONES.top || TPL_ZONES.body || TPL_ZONES.bottom){
        TPL_render3ZoneTemplate();
        TPL_renderLayersOnStage();
        return;
      }
      
      // Fallback: render AI zones and layers even without zone images
      st.innerHTML='';
      
      // Create a basic container for AI zones and layers
      const container = document.createElement('div');
      container.style.cssText = `
        position: relative;
        width: 100%;
        height: 100%;
        background: #f0f0f0;
        overflow: hidden;
      `;
      
      // Add AI zones overlay
      TPL_renderAIZonesOverlay(container, 0, stageH, stageH);
      
      // Add layers
      TPL_renderLayersOnStage();
      
      st.appendChild(container);
    }
    
    function TPL_renderLayersOnStage(){
      const st=document.getElementById('tplStage');
      if(!st) return;
      
      // Clear existing layers
      const existingLayers = st.querySelectorAll('.tpl-layer');
      existingLayers.forEach(layer => layer.remove());
      
      const rows=Array.from(document.querySelectorAll('.tpl-layer-row')); 
      rows.forEach(row=>{ 
        const id=row.dataset.id, type=row.dataset.type; 
        let d;
        if(type==='image'){ 
          d=document.createElement('img'); 
          d.src=row.querySelector('.tpl-layer-src').value||''; 
          d.style.width=(row.querySelector('.tpl-layer-w').value||120)+'px'; 
          d.style.height=(row.querySelector('.tpl-layer-h').value||120)+'px'; 
          d.style.opacity=(row.querySelector('.tpl-layer-op').value||1);
          d.style.objectFit = 'contain';
          d.style.display = 'block';
        } else { 
          d=document.createElement('div'); 
          d.textContent=row.querySelector('.tpl-layer-text').value||''; 
          d.style.width=(row.querySelector('.tpl-layer-w').value||260)+'px'; 
          d.style.color=row.querySelector('.tpl-layer-color').value||'#fff'; 
          d.style.fontWeight=row.querySelector('.tpl-layer-fw').value||700; 
          d.style.fontSize=(row.querySelector('.tpl-layer-fs').value||28)+'px'; 
          d.style.lineHeight='1.15'; 
          d.style.textAlign=row.querySelector('.tpl-layer-ta').value||'center'; 
          d.style.textShadow='0 1px 2px rgba(0,0,0,.3)'; 
          d.style.whiteSpace='normal'; 
          d.style.wordWrap='break-word';
        }
        d.className='tpl-layer tpl-layer-draggable'; 
        d.dataset.id=id; 
        d.dataset.type=type; 
        d.style.position='absolute'; 
        d.style.left=(row.querySelector('.tpl-layer-x').value||0)+'px'; 
        d.style.top=(row.querySelector('.tpl-layer-y').value||0)+'px'; 
        d.style.cursor='move'; 
        d.style.zIndex='10'; // Ensure layers are above zones
        d.style.border='2px solid transparent';
        d.style.transition='border-color 0.2s';
        
        // Add resize handle
        const addResizeHandle = () => {
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'layer-resize-handle';
          resizeHandle.style.cssText = `
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: #ff0000;
            cursor: se-resize;
            border-radius: 0 0 4px 0;
            z-index: 20;
            pointer-events: auto;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          `;
          d.appendChild(resizeHandle);
          
          console.log('Added resize handle to layer:', id, type, 'Element:', d, 'Handle:', resizeHandle);
          console.log('Layer dimensions:', d.offsetWidth, 'x', d.offsetHeight);
          console.log('Handle position:', resizeHandle.offsetLeft, resizeHandle.offsetTop);
        };
        
        if(type === 'image') {
          // For images, add handle immediately but also after load
          addResizeHandle();
          d.onload = () => {
            console.log('Image loaded, ensuring resize handle is visible');
            // Force a reflow to ensure handle is properly positioned
            setTimeout(() => {
              const handle = d.querySelector('.layer-resize-handle');
              if (handle) {
                handle.style.display = 'block';
                console.log('Resize handle visibility ensured for image layer:', id);
              }
            }, 10);
          };
          if(d.complete) {
            console.log('Image already complete, ensuring handle visibility');
            setTimeout(() => {
              const handle = d.querySelector('.layer-resize-handle');
              if (handle) {
                handle.style.display = 'block';
                console.log('Resize handle visibility ensured for completed image layer:', id);
              }
            }, 10);
          }
        } else {
          addResizeHandle();
        }
        
        // Make draggable
        TPL_makeLayerDraggable(d, id);
        
        // Add hover effect
        d.addEventListener('mouseenter', () => {
          d.style.borderColor = '#007bff';
        });
        d.addEventListener('mouseleave', () => {
          d.style.borderColor = 'transparent';
        });
        
        st.appendChild(d); 
      });
    }
    
    function TPL_makeLayerDraggable(element, layerId){
      let isDragging = false;
      let isResizing = false;
      let startX, startY, startLeft, startTop, startWidth, startHeight;
      
      element.addEventListener('mousedown', (e) => {
        console.log('Layer mousedown:', e.target, e.target.classList.contains('layer-resize-handle'));
        console.log('Target classes:', e.target.className);
        console.log('Target tagName:', e.target.tagName);
        if(e.target.classList.contains('layer-resize-handle')){
          console.log('Starting resize for layer:', layerId);
          e.stopPropagation();
          e.preventDefault();
          
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = element.offsetWidth;
          startHeight = element.offsetHeight;
          
          const handleMouseMove = (e) => {
            if(isResizing){
              const deltaX = e.clientX - startX;
              const deltaY = e.clientY - startY;
              const newWidth = Math.max(20, startWidth + deltaX);
              const newHeight = Math.max(20, startHeight + deltaY);
              
              element.style.width = newWidth + 'px';
              element.style.height = newHeight + 'px';
              
              // Update form inputs
              TPL_updateLayerFormInputs(layerId, element.offsetLeft, element.offsetTop, newWidth, newHeight);
              
              console.log('Resizing layer:', layerId, 'to', newWidth + 'px', 'x', newHeight + 'px');
            }
          };
          
          const handleMouseUp = () => {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            console.log('Layer resize completed for:', layerId);
          };
          
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        } else {
          console.log('Starting drag for layer:', layerId);
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startLeft = element.offsetLeft;
          startTop = element.offsetTop;
        }
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if(isDragging){
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          const newLeft = startLeft + deltaX;
          const newTop = startTop + deltaY;
          
          element.style.left = Math.max(0, newLeft) + 'px';
          element.style.top = Math.max(0, newTop) + 'px';
          
          // Update form inputs
          TPL_updateLayerFormInputs(layerId, newLeft, newTop, element.offsetWidth, element.offsetHeight);
        }
      });
      
      document.addEventListener('mouseup', () => {
        if(isDragging || isResizing){
          isDragging = false;
          isResizing = false;
          console.log('Layer interaction completed for:', layerId);
        }
      });
    }
    
    function TPL_updateLayerFormInputs(layerId, x, y, w, h){
      const row = document.querySelector(`[data-id="${layerId}"]`);
      if(row){
        row.querySelector('.tpl-layer-x').value = Math.round(x);
        row.querySelector('.tpl-layer-y').value = Math.round(y);
        row.querySelector('.tpl-layer-w').value = Math.round(w);
        if(row.querySelector('.tpl-layer-h')){
          row.querySelector('.tpl-layer-h').value = Math.round(h);
        }
      }
    }
    
    function TPL_seed(){
      if(!confirm('Add example image+text template?')) return;
      const t = {
        id: 'tpl_demo_imgtext',
        name: 'QA Clan ‚Äì Bold Visual + Title',
        img: { data: 'https://i.imgur.com/9p6Qm6Z.png' },
        base: { w: 360, h: 640 },
        layers: [
          { type:'image', id:'logo1', src:'https://i.imgur.com/rQnE2mL.png', x:20, y:20, w:90, h:90, opacity:1 },
          { type:'text',  id:'tx1',  text:'THIS Q WE HAD',    x:40, y:120, w:280, fs:26, fw:800, color:'#ffffff', ta:'center' },
          { type:'text',  id:'tx2',  text:'Highlights & Wins', x:40, y:160, w:280, fs:22, fw:700, color:'#ffffff', ta:'center' }
        ],
        created_at: Date.now()
      };
      const idx = TPL_LIST.findIndex(x => x.id === t.id);
      if (idx >= 0) TPL_LIST[idx] = t; else TPL_LIST.unshift(t);
      TPL_saveAll(TPL_LIST);
      TPL_renderTemplateSelector();
      TPL_edit(t.id);
    }

    /* ---------- Meetings list / other actions ---------- */
    async function loadMeetings(){
      const meetings=await apiGet("/api/meetings");
      const byYear={};
      meetings.forEach(m=>{
        const dateStr = (m.date||"").trim();
        const y = dateStr.slice(0,4)||"No date";
        // Normalize year string to avoid duplicates
        const yearKey = y.trim();
        const q=quarterOf(m.date);
        byYear[yearKey]=byYear[yearKey]||{Q1:[],Q2:[],Q3:[],Q4:[]};
        byYear[yearKey][q].push(m);
      });
      // Remove duplicates and sort
      const years=[...new Set(Object.keys(byYear))].sort((a,b)=>{
        if(a==="No date") return 1;
        if(b==="No date") return -1;
        return b.localeCompare(a);
      });
      const wrap=document.getElementById("meetingsContainer");
      wrap.innerHTML="";
      
      for(const y of years){
        const block=document.createElement("div");
        block.className="year-block";
        const yearHeader = document.createElement("div");
        yearHeader.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border: 2px solid #3b82f6; border-radius: 12px; margin-bottom: 16px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); box-shadow: 0 4px 6px rgba(59, 130, 246, 0.1);";
        
        const yearInfo = document.createElement("div");
        yearInfo.style.cssText = "display: flex; align-items: center; gap: 12px; cursor: pointer; flex: 1;";
        yearInfo.onclick = () => toggleYear(`${y}`);
        yearInfo.innerHTML = `<span class="year-toggle" data-year="${y}" style="font-size: 20px;">üìÇ</span><span style="font-size: 24px; font-weight: 700; color: #1e40af;">${y}</span>`;
        
        // Add AI Report button for year
        const yearReportBtn = document.createElement("button");
        yearReportBtn.className = "btn primary";
        yearReportBtn.style.cssText = "padding: 12px 20px; font-size: 16px; font-weight: 600; background: #3b82f6; border: 2px solid #2563eb;";
        yearReportBtn.innerHTML = "üìà Annual AI Report";
        yearReportBtn.onclick = () => generateYearReport(y, byYear[y]);
        
        yearHeader.appendChild(yearInfo);
        yearHeader.appendChild(yearReportBtn);
        
        block.appendChild(yearHeader);
        
        // Add year content container
        const yearContent = document.createElement("div");
        yearContent.className = "year-content";
        yearContent.id = `year-${y}`;
        yearContent.style.display = "block"; // Start expanded to show quarters
        
        const quarters = [["Q1","quarter-q1","#2563eb"],["Q2","quarter-q2","#16a34a"],["Q3","quarter-q3","#f59e0b"],["Q4","quarter-q4","#7c3aed"]];
        
        for(const [q,cls,color] of quarters){
          const list=byYear[y][q]||[];
          if(!list.length) continue;
          
          const qHeader=document.createElement("div");
          qHeader.className="quarter-header";
          qHeader.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);";
          
          const quarterInfo = document.createElement("div");
          quarterInfo.style.cssText = "display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1;";
          quarterInfo.onclick = () => toggleQuarter(`${y}-${q}`);
          quarterInfo.innerHTML = `<span class="quarter-toggle" id="toggle-${y}-${q}">üå±</span><span class="qdot" style="background:${color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span><span style="font-weight: 600; color: #1f2937; font-size: 16px;">${q}</span><span class="muted" style="margin-left: 8px; font-size: 14px;">${list.length} meeting${list.length>1?'s':''}</span>`;
          
          // Add AI Report button for quarter
          const quarterReportBtn = document.createElement("button");
          quarterReportBtn.className = "btn primary";
          quarterReportBtn.style.cssText = "padding: 8px 16px; font-size: 14px; font-weight: 600;";
          quarterReportBtn.innerHTML = "üìä AI Report";
          quarterReportBtn.onclick = () => generateQuarterReport(y, q, list);
          
          qHeader.appendChild(quarterInfo);
          qHeader.appendChild(quarterReportBtn);
          
          yearContent.appendChild(qHeader);
          
          const grid=document.createElement("div");
          grid.className=`quarter-grid ${cls}`;
          grid.id = `grid-${y}-${q}`;
          list.sort((a,b)=>(a.date||"").localeCompare(b.date));
          
          // Render cards asynchronously
          for(const m of list){
            const card = await renderMeetingCard(m);
            grid.appendChild(card);
          }
          
          yearContent.appendChild(grid);
        }
        
        block.appendChild(yearContent);
        wrap.appendChild(block);
      }
    }

    // Toggle functions for meetings
    function toggleYear(year) {
      const yearContent = document.getElementById(`year-${year}`);
      const toggle = document.querySelector(`[data-year="${year}"]`);
      
      if (yearContent.style.display === 'none') {
        yearContent.style.display = '';
        toggle.textContent = 'üìÇ'; // Open folder
      } else {
        yearContent.style.display = 'none';
        toggle.textContent = 'üìÖ'; // Closed calendar
      }
    }
    function toggleQuarter(quarterId) {
      const grid = document.getElementById(`grid-${quarterId}`);
      const toggle = document.getElementById(`toggle-${quarterId}`);
      
      if (grid.style.display === 'none') {
        grid.style.display = '';
        toggle.textContent = 'üåø'; // Open plant
      } else {
        grid.style.display = 'none';
        toggle.textContent = 'üå±'; // Closed bud
      }
    }

    async function exportPptx(mid){
      try{
        const meetings=await apiGet("/api/meetings");
        const m=meetings.find(x=>String(x.id)===String(mid));
        if(!m) return alert("Meeting not found.");
        const r=await apiSend("/api/pptx-report","POST",{
          title:m.title, date:m.date,
          kpis:kpisForPayload(m.matched_kpis),
          feedback:{rating:0,comments:[]},
          ai_summary:"‚Äî"
        });
        openModal(`<p><a class="btn primary" href="/static/generated/${r.filename}" target="_blank">Download PPTX report</a></p>`);
      }catch(e){ 
        alert("PPTX error: " + e.message); 
      }
    }

    async function qrCheckin(mid){
      try{
        const r=await apiSend(`/api/meetings/${mid}/qr`,"POST");
        openModal(`<h3>Scan to check in</h3><img src="${r.qr_url}" class="qrimg" alt="Check-in QR"/><p><a href="${r.checkin_url}" target="_blank">${r.checkin_url}</a></p>`);
      }catch(e){ 
        alert("QR error: " + e.message); 
      }
    }

    async function deleteMeeting(mid){
      if(!confirm("Delete the meeting?")) return;
      await apiSend(`/api/meetings?id=${encodeURIComponent(mid)}`,"DELETE");
      await loadMeetings();
    }

    async function editMeeting(mid){
      const ms=await apiGet("/api/meetings");
      const m=ms.find(x=>String(x.id)===String(mid));
      if(!m) return;
      
      // Create a more comprehensive edit modal
      const currentTypes = m.types || [];
      const typesHtml = `
        <h3>Edit Meeting</h3>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title:</label>
          <input id="editTitle" type="text" value="${escapeHtml(m.title||'')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date (YYYY-MM-DD):</label>
          <input id="editDate" type="date" value="${m.date||''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Topic:</label>
          <input id="editTopic" type="text" value="${escapeHtml(m.topic||'')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Meeting Features:</label>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 6px;">
              <input type="checkbox" id="editTypeDebate" ${currentTypes.includes('debate') ? 'checked' : ''}>
              <span>Include Debate</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px;">
              <input type="checkbox" id="editTypeQuiz" ${currentTypes.includes('quiz') ? 'checked' : ''}>
              <span>Include Quiz</span>
            </label>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 6px;">
            Select additional features. All meetings include standard agenda and feedback.
          </div>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
          <button class="btn subtle" onclick="closeModal()">Cancel</button>
          <button class="btn primary" onclick="saveMeetingEdit(${m.id})">Save Changes</button>
        </div>
      `;
      
      openModal(typesHtml);
    }

    async function saveMeetingEdit(meetingId){
      const title = document.getElementById("editTitle").value.trim();
      const date = document.getElementById("editDate").value;
      const topic = document.getElementById("editTopic").value.trim();
      
      // Collect meeting features
      const types = [];
      if(document.getElementById("editTypeDebate").checked) types.push("debate");
      if(document.getElementById("editTypeQuiz").checked) types.push("quiz");
      
      if(!title || !date) {
        alert("Title and date are required.");
        return;
      }
      
      // No need to check for empty types - meetings can be regular without features
      
      const saveBtn = document.querySelector('button[onclick="saveMeetingEdit(' + meetingId + ')"]');
      setButtonLoading(saveBtn, true);
      
      try{
        await apiSend("/api/meetings","PUT",{
          id: meetingId,
          title: title,
          date: date,
          topic: topic,
          types: types
        });
        closeModal();
      await loadMeetings();
        setButtonLoading(saveBtn, false);
      }catch(e){
        setButtonLoading(saveBtn, false);
        alert("Error updating meeting: " + e.message);
      }
    }

    /* ---------- Loading System ---------- */
    function showLoading(message = "Loading..."){
      const overlay = document.createElement("div");
      overlay.className = "loading-overlay";
      overlay.id = "loadingOverlay";
      overlay.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
          <div class="text">${message}</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function hideLoading(){
      const overlay = document.getElementById("loadingOverlay");
      if(overlay) overlay.remove();
    }

    function setButtonLoading(button, loading = true){
      if(!button) return;
      
      if(loading){
        // Store original text
        button.setAttribute('data-original-text', button.textContent);
        button.textContent = 'Loading...';
        button.classList.add("loading");
        button.disabled = true;
      } else {
        // Restore original text
        const originalText = button.getAttribute('data-original-text');
        if(originalText) {
          button.textContent = originalText;
          button.removeAttribute('data-original-text');
        }
        button.classList.remove("loading");
        button.disabled = false;
      }
    }

    function showInlineLoading(container, message = "Loading..."){
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "loading-inline";
      loadingDiv.id = "inlineLoading";
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <span>${message}</span>
      `;
      container.appendChild(loadingDiv);
    }

    function hideInlineLoading(){
      const loading = document.getElementById("inlineLoading");
      if(loading) loading.remove();
    }

    /* ---------- Meeting Type Actions ---------- */
    async function findExistingDebate(meetingId){
      try{
        const debates = await apiGet("/api/debates");
        return debates.find(d => String(d.meeting_id) === String(meetingId));
      }catch(e){
        console.error("Error finding existing debate:", e);
        return null;
      }
    }

    async function createDebate(mid){
      const ms=await apiGet("/api/meetings");
      const m=ms.find(x=>String(x.id)===String(mid));
      if(!m) return;
      
      // Check if debate already exists
      const existingDebate = await findExistingDebate(mid);
      if(existingDebate) {
        // Redirect to existing debate
        window.open(`/debate?did=${existingDebate.id}`, '_blank');
        return;
      }
      
      const affirmation = prompt("Debate affirmation/topic:", m.topic || "");
      if(!affirmation) return;
      
      showLoading("üéØ Creating debate...");
      
      try{
        const debate = await apiSend("/api/debates", "POST", {
          meeting_id: mid,
          affirmation: affirmation,
          status: "draft"
        });
        hideLoading();
        alert(`Debate created! ID: ${debate.id}`);
        // Redirect to debate page
        window.open(`/debate?did=${debate.id}`, '_blank');
      }catch(e){
        hideLoading();
        alert("Error creating debate: " + e.message);
      }
    }

    async function createQuiz(mid) {
      // Store meeting id in sessionStorage for the quizz page to pick up
      sessionStorage.setItem('quizz_meeting_id', mid);
      window.location.href = '/quizz';
    }

    function openDebate(debateId){
      // Redirect to existing debate
      window.open(`/debate?did=${debateId}`, '_blank');
    }

    /* ---------- Feedback (UI + API) ---------- */
    let FB_QUESTIONS = [];
    let FB_FORM_ID = null;

    // --- Feedback URL + QR helpers (normalize to ?id=) ---
    function normalizeFeedbackUrl(raw){
      try{
        const u = new URL(raw, window.location.origin);
        const m = u.pathname.match(/^\/feedback\/([^\/?#]+)$/);
        if(m){
          u.pathname = "/feedback";
          u.search   = `?id=${encodeURIComponent(m[1])}`;
        }
        return u.toString();
      }catch{ return raw||""; }
    }
    function fallbackQR(data){
      return `https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=${encodeURIComponent(data)}`;
    }
    function setShareLinkAndQR({url, qr_url}){
      const norm = normalizeFeedbackUrl(url||"");
      const a = document.getElementById("fbLink");
      const img = document.getElementById("fbQR");
      if(a){ a.href = norm; a.textContent = norm; }
      const isPathStyle = /\/feedback\/[^/?#]+$/.test(url||"");
      img.src = (!isPathStyle && qr_url) ? (qr_url) : fallbackQR(norm);
    }

    async function fbInit(){
      // populate meetings
      const sel=document.getElementById("fbMeeting");
      sel.innerHTML=`<option value="">(choose meeting)</option>`;
      try{
        const meetings=await apiGet("/api/meetings");
        meetings.sort((a,b)=>(a.date||"").localeCompare(b.date));
        meetings.forEach(m=>{
          const opt=document.createElement("option");
          opt.value=m.id;
          opt.textContent=`${m.date||""} ‚Äî ${m.title||"(no title)"}`;
          sel.appendChild(opt);
        });
      }catch(e){ console.error(e); }
      sel.onchange=()=>{
        fbLoadExistingForMeeting(sel.value);
        // Reload presenters for all rating_presenter questions when meeting changes
        setTimeout(() => {
          FB_QUESTIONS.forEach(q => {
            if(q.type === 'rating_presenter') {
              fbLoadPresentersForQuestion(q.id);
            }
          });
        }, 200);
      };

      // Add New Question button - toggle question type selector
      document.getElementById("fbAddQuestion").onclick=()=>{
        const selector = document.getElementById("fbQuestionTypes");
        const isVisible = selector.style.display !== "none";
        selector.style.display = isVisible ? "none" : "block";
        
        // Update button text
        const btn = document.getElementById("fbAddQuestion");
        if (isVisible) {
          btn.innerHTML = '<span style="font-size: 18px; margin-right: 8px;">+</span> Add New Question';
        } else {
          btn.innerHTML = '<span style="font-size: 18px; margin-right: 8px;">‚àí</span> Cancel';
        }
      };
      
      // Question type selector buttons
      document.querySelectorAll(".fb-question-type-btn").forEach(btn => {
        btn.onclick = () => {
          const type = btn.dataset.type;
          fbAddQ(type);
          
          // Hide selector and reset button after adding question
          document.getElementById("fbQuestionTypes").style.display = "none";
          const addBtn = document.getElementById("fbAddQuestion");
          addBtn.innerHTML = '<span style="font-size: 18px; margin-right: 8px;">+</span> Add New Question';
        };
      });
      
      // Delete form button
      document.getElementById("fbDeleteForm").onclick = fbDeleteForm;
      document.getElementById("fbSave").onclick     =fbSaveForm;
      document.getElementById("fbCopy").onclick     =()=>fbCopy(document.getElementById("fbLink")?.href||"");
      document.getElementById("fbTeams").onclick    =fbGenerateTeamsMsg;
      document.getElementById("fbTeamsCopy").onclick=fbCopyTeamsText;
      document.getElementById("fbTeamsCopyHtml").onclick=fbCopyTeamsHtml;

      // reset UI
      FB_QUESTIONS=[]; FB_FORM_ID=null;
      document.getElementById("fbTitle").value="";
      document.getElementById("fbDesc").value="";
      document.getElementById("fbExtraSuggestions").value="";
      document.getElementById("fbShare").style.display="none";
      document.getElementById("fbResults").style.display="none";
      document.getElementById("fbTeamsSection").style.display="none";
      fbRenderQuestions();
    }

    function fbAddQ(type){
      const q = {
        id:'q_'+Math.random().toString(36).slice(2,9),
        type,
        title: type==='rating' ? 'How would you rate the meeting (1‚Äì5)?' : 
               type==='rating_presenter' ? 'Rate the presenters (1‚Äì5)' : 'Question',
        options: (type==='single'||type==='multi') ? ['Yes','No'] : [],
        min: (type==='rating'||type==='rating_presenter') ? 1 : undefined,
        max: (type==='rating'||type==='rating_presenter') ? 5 : undefined,
        max_answers: type==='multi' ? undefined : undefined, // Max answers for multiple choice
        presenters: type==='rating_presenter' ? [] : undefined,
        mandatory: false
      };
      FB_QUESTIONS.push(q);
      fbRenderQuestions();
      
      // If it's a rating_presenter question, load presenters from meeting
      if(type === 'rating_presenter') {
        fbLoadPresentersForQuestion(q.id);
      }
    }

    function fbRenderQuestions(){
      const wrap=document.getElementById("fbQList");
      wrap.innerHTML="";
      
      if(!FB_QUESTIONS.length){
        wrap.innerHTML=`
          <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 2px dashed #cbd5e1; border-radius: 16px; color: #64748b;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìù</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #374151;">No questions yet</div>
            <div style="font-size: 14px;">Add questions using the buttons above or the "Add New Question" button below</div>
          </div>
        `;
        return;
      }
      
      FB_QUESTIONS.forEach((q, index) => {
        const row = document.createElement("div");
        row.style.cssText = `
          background: white;
          border: 2px solid #e5e7eb;
          border-radius: 16px;
          padding: 24px;
          margin-bottom: 16px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
          transition: all 0.2s;
        `;
        row.onmouseover = () => {
          row.style.borderColor = '#3b82f6';
          row.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
        };
        row.onmouseout = () => {
          row.style.borderColor = '#e5e7eb';
          row.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.05)';
        };
        
        let inner = `
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <div style="
              background: #3b82f6;
              color: white;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 700;
              font-size: 14px;
              flex-shrink: 0;
            ">${index + 1}</div>
            <div style="flex: 1;">
              <input class="inp q-title" data-id="${q.id}" 
                style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; font-weight: 600; background: #f8fafc;" 
                value="${escapeHtml(q.title||'')}" 
                placeholder="Enter your question here..."
                onfocus="this.style.borderColor='#3b82f6'; this.style.background='white'"
                onblur="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="
                background: ${getTypeColor(q.type)};
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
              ">${q.type}</span>
              
              <!-- Mandatory checkbox -->
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; color: #374151; font-weight: 500;">
                <input type="checkbox" class="q-mandatory" data-id="${q.id}" ${q.mandatory ? 'checked' : ''} style="
                  width: 16px;
                  height: 16px;
                  accent-color: #3b82f6;
                  cursor: pointer;
                ">
                <span>Required</span>
              </label>
              
              <!-- Reorder buttons -->
              <div style="display: flex; flex-direction: column; gap: 2px;">
                <button onclick="fbMoveQuestion('${q.id}', 'up')" style="
                  background: #6b7280;
                  color: white;
                  border: none;
                  padding: 4px 8px;
                  border-radius: 4px;
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 24px;
                  height: 20px;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'" ${index === 0 ? 'disabled' : ''}>
                  ‚Üë
                </button>
                <button onclick="fbMoveQuestion('${q.id}', 'down')" style="
                  background: #6b7280;
                  color: white;
                  border: none;
                  padding: 4px 8px;
                  border-radius: 4px;
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 24px;
                  height: 20px;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'" ${index === FB_QUESTIONS.length - 1 ? 'disabled' : ''}>
                  ‚Üì
                </button>
              </div>
              
              <button onclick="fbDeleteQ('${q.id}')" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
              " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>`;
        if(q.type==='single'||q.type==='multi'){
          inner += `
            <div style="margin-top: 16px;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 14px;">Options</div>
              <div class="q-opts" data-id="${q.id}" style="display: flex; flex-direction: column; gap: 8px;">
                ${(q.options||[]).map((opt,i)=>`
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="
                      width: 20px;
                      height: 20px;
                      border: 2px solid #d1d5db;
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      flex-shrink: 0;
                    ">${q.type === 'single' ? '‚óã' : '‚òê'}</div>
                    <input class="inp q-opt" data-idx="${i}" 
                      style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #f8fafc;" 
                      value="${escapeHtml(opt)}" 
                      placeholder="Option text"
                      onfocus="this.style.borderColor='#3b82f6'; this.style.background='white'"
                      onblur="this.style.borderColor='#e5e7eb'; this.style.background='#f8fafc'">
                    <button onclick="fbRemoveOpt('${q.id}',${i})" style="
                      background: #ef4444;
                      color: white;
                      border: none;
                      padding: 8px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: all 0.2s;
                    " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">‚àí</button>
                  </div>`).join("")}
              </div>
              <button onclick="fbAddOpt('${q.id}')" style="
                background: #3b82f6;
                color: white;
                border: none;
                padding: 10px 16px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                margin-top: 12px;
                transition: all 0.2s;
              " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                + Add Option
              </button>
              ${q.type === 'multi' ? `
              <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 2px solid #e5e7eb;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 14px;">Selection Limits</div>
                <div style="display: flex; align-items: center; gap: 16px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <label style="font-size: 14px; color: #6b7280;">Max answers allowed:</label>
                    <input class="inp q-max-answers" data-id="${q.id}" type="number" 
                      value="${q.max_answers !== undefined ? q.max_answers : ''}" 
                      placeholder="No limit"
                      min="1"
                      style="width: 120px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 14px;"
                      onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                  </div>
                  <span style="font-size: 12px; color: #9ca3af;">Leave empty for no limit</span>
                </div>
              </div>
              ` : ''}
            </div>`;
        } else if(q.type==='rating'){
          inner += `
            <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 2px solid #e5e7eb;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 14px;">Rating Scale</div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label style="font-size: 14px; color: #6b7280;">Min:</label>
                  <input class="inp q-min" data-id="${q.id}" type="number" value="${q.min??1}" 
                    style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 14px;"
                    onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label style="font-size: 14px; color: #6b7280;">Max:</label>
                  <input class="inp q-max" data-id="${q.id}" type="number" value="${q.max??5}" 
                    style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 14px;"
                    onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <span style="font-size: 12px; color: #9ca3af;">(default 1‚Äì5)</span>
              </div>
            </div>`;
        } else if(q.type==='rating_presenter'){
          inner += `
            <div style="margin-top: 16px; padding: 16px; background: #faf5ff; border-radius: 12px; border: 2px solid #e9d5ff;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 14px;">üé§ Select Presenters to Rate</div>
              <div id="presenter-selector-${q.id}" style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Loading presenters from meeting...</div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label style="font-size: 14px; color: #6b7280;">Min:</label>
                  <input class="inp q-min" data-id="${q.id}" type="number" value="${q.min??1}" 
                    style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 14px;"
                    onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <label style="font-size: 14px; color: #6b7280;">Max:</label>
                  <input class="inp q-max" data-id="${q.id}" type="number" value="${q.max??5}" 
                    style="width: 80px; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; text-align: center; font-size: 14px;"
                    onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <span style="font-size: 12px; color: #9ca3af;">(default 1‚Äì5)</span>
              </div>
            </div>`;
          // Load presenters after rendering
          setTimeout(() => fbLoadPresentersForQuestion(q.id), 100);
        } else {
          inner += `
            <div style="margin-top: 16px; padding: 16px; background: #f0f9ff; border-radius: 12px; border: 2px solid #bae6fd; color: #0369a1; font-size: 14px; text-align: center;">
              üìù Open response (free text)
            </div>`;
        }
        row.innerHTML = inner;
        wrap.appendChild(row);
      });

      // bind edits
      wrap.querySelectorAll(".q-title").forEach(inp=>{
        inp.oninput=()=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.title=inp.value; };
      });
      wrap.querySelectorAll(".q-min").forEach(inp=>{
        inp.oninput=()=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.min=parseInt(inp.value||"1",10); };
      });
      wrap.querySelectorAll(".q-max").forEach(inp=>{
        inp.oninput=()=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.max=parseInt(inp.value||"5",10); };
      });
      wrap.querySelectorAll(".q-max-answers").forEach(inp=>{
        inp.oninput=()=>{ 
          const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); 
          if(q) {
            const val = inp.value.trim();
            q.max_answers = val ? parseInt(val, 10) : undefined;
          }
        };
      });
      wrap.querySelectorAll(".q-opts .q-opt").forEach(inp=>{
        inp.oninput=()=>{ const pid=inp.closest(".q-opts").dataset.id; const q=FB_QUESTIONS.find(x=>x.id===pid); const i=parseInt(inp.dataset.idx,10); if(q && q.options && q.options[i]!=null) q.options[i]=inp.value; };
      });
      wrap.querySelectorAll(".q-mandatory").forEach(cb=>{
        cb.onchange=()=>{ const q=FB_QUESTIONS.find(x=>x.id===cb.dataset.id); if(q) q.mandatory=cb.checked; };
      });
      
      // Show/hide question type selector based on number of questions
      const selector = document.getElementById("fbQuestionTypes");
      const addBtn = document.getElementById("fbAddQuestion");
      
      if (FB_QUESTIONS.length === 0) {
        // No questions - show selector by default
        selector.style.display = "block";
        addBtn.innerHTML = '<span style="font-size: 18px; margin-right: 8px;">‚àí</span> Cancel';
      } else {
        // Has questions - hide selector by default
        selector.style.display = "none";
        addBtn.innerHTML = '<span style="font-size: 18px; margin-right: 8px;">+</span> Add New Question';
      }
    }

    async function fbLoadPresentersForQuestion(questionId) {
      const question = FB_QUESTIONS.find(q => q.id === questionId);
      if (!question || question.type !== 'rating_presenter') return;
      
      const meetingId = document.getElementById("fbMeeting").value;
      if (!meetingId) {
        const selector = document.getElementById(`presenter-selector-${questionId}`);
        if (selector) {
          selector.innerHTML = '<div style="font-size: 12px; color: #ef4444;">‚ö†Ô∏è Please select a meeting first</div>';
        }
        return;
      }
      
      try {
        // Ensure MEMBERS is loaded for name lookup
        if (!MEMBERS || MEMBERS.length === 0) {
          MEMBERS = await apiGet("/api/members");
        }
        
        const meetings = await apiGet("/api/meetings");
        const meeting = meetings.find(m => String(m.id) === String(meetingId));
        
        if (!meeting) {
          const selector = document.getElementById(`presenter-selector-${questionId}`);
          if (selector) {
            selector.innerHTML = '<div style="font-size: 12px; color: #ef4444;">‚ö†Ô∏è Meeting not found</div>';
          }
          return;
        }
        
        // Extract presenters from agenda
        const presenters = new Set();
        (meeting.agenda || []).forEach(item => {
          // Check ownerName first (already formatted name), then ownerEmail
          const ownerName = (item.ownerName || "").trim();
          const ownerEmail = (item.ownerEmail || item.owner || "").trim().toLowerCase();
          
          if (ownerName) {
            // Use ownerName directly if available
            presenters.add(ownerName);
          } else if (ownerEmail) {
            // Try to get name from email using MEMBERS
            const presenterName = nameForEmail(ownerEmail) || ownerEmail;
            if (presenterName && presenterName.trim()) {
              presenters.add(presenterName.trim());
            }
          }
        });
        
        const presentersList = Array.from(presenters).sort();
        const selector = document.getElementById(`presenter-selector-${questionId}`);
        
        if (!selector) return;
        
        if (presentersList.length === 0) {
          selector.innerHTML = '<div style="font-size: 12px; color: #f59e0b;">‚ö†Ô∏è No presenters found in meeting agenda</div>';
          return;
        }
        
        // Initialize presenters array if not exists
        if (!question.presenters) {
          question.presenters = [];
        }
        
        // Render checkboxes for each presenter
        selector.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${presentersList.map(presenter => {
              const isSelected = question.presenters.includes(presenter);
              return `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: ${isSelected ? '#f3f4f6' : 'white'}; border-radius: 6px; border: 2px solid ${isSelected ? '#8b5cf6' : '#e5e7eb'}; transition: all 0.2s;" 
                  onmouseover="this.style.borderColor='#8b5cf6'" 
                  onmouseout="this.style.borderColor='${isSelected ? '#8b5cf6' : '#e5e7eb'}'">
                  <input type="checkbox" 
                    data-question-id="${questionId}" 
                    data-presenter="${presenter}"
                    ${isSelected ? 'checked' : ''}
                    style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6;"
                    onchange="fbTogglePresenter('${questionId}', '${presenter.replace(/'/g, "\\'")}', this.checked)">
                  <span style="font-size: 14px; color: #374151; font-weight: ${isSelected ? '600' : '400'};">${escapeHtml(presenter)}</span>
                </label>
              `;
            }).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Error loading presenters:', error);
        const selector = document.getElementById(`presenter-selector-${questionId}`);
        if (selector) {
          selector.innerHTML = '<div style="font-size: 12px; color: #ef4444;">‚ö†Ô∏è Error loading presenters</div>';
        }
      }
    }

    function fbTogglePresenter(questionId, presenter, isChecked) {
      const question = FB_QUESTIONS.find(q => q.id === questionId);
      if (!question || !question.presenters) return;
      
      if (isChecked) {
        if (!question.presenters.includes(presenter)) {
          question.presenters.push(presenter);
        }
      } else {
        question.presenters = question.presenters.filter(p => p !== presenter);
      }
      
      // Re-render to update UI
      fbLoadPresentersForQuestion(questionId);
    }

    function fbDeleteQ(id){ FB_QUESTIONS = FB_QUESTIONS.filter(q=>q.id!==id); fbRenderQuestions(); }
    function fbAddOpt(qid){ const q=FB_QUESTIONS.find(x=>x.id===qid); if(!q) return; q.options=q.options||[]; q.options.push("Option"); fbRenderQuestions(); }
    function fbRemoveOpt(qid, idx){ const q=FB_QUESTIONS.find(x=>x.id===qid); if(!q||!q.options) return; q.options.splice(idx,1); fbRenderQuestions(); }
    
    // Delete entire form
    async function fbDeleteForm(){
      if(!FB_FORM_ID) {
        // If no form ID, just reset the UI
        FB_QUESTIONS = [];
        FB_FORM_ID = null;
        document.getElementById("fbTitle").value = "";
        document.getElementById("fbDesc").value = "";
        document.getElementById("fbShare").style.display = "none";
        document.getElementById("fbResults").style.display = "none";
        fbRenderQuestions();
        return;
      }
      
      if(!confirm("Are you sure you want to delete this entire form? This action cannot be undone.")){
        return;
      }
      
      try {
        // Delete from backend
        await apiSend(`/api/feedback/forms?id=${encodeURIComponent(FB_FORM_ID)}`, "DELETE");
        
        // Reset UI
        FB_QUESTIONS = [];
        FB_FORM_ID = null;
        document.getElementById("fbTitle").value = "";
        document.getElementById("fbDesc").value = "";
        document.getElementById("fbMeeting").value = "";
        document.getElementById("fbShare").style.display = "none";
        document.getElementById("fbResults").style.display = "none";
        fbRenderQuestions();
        
        document.getElementById("fbMsg").textContent = "Form deleted successfully";
        document.getElementById("fbMsg").style.color = "#059669";
        setTimeout(() => {
          document.getElementById("fbMsg").textContent = "";
        }, 3000);
      } catch (error) {
        console.error("Error deleting form:", error);
        document.getElementById("fbMsg").textContent = "Error deleting form: " + (error.message || "Unknown error");
        document.getElementById("fbMsg").style.color = "#dc2626";
        setTimeout(() => {
          document.getElementById("fbMsg").textContent = "";
        }, 5000);
      }
    }
    
    // Move question up or down
    function fbMoveQuestion(id, direction){
      const currentIndex = FB_QUESTIONS.findIndex(q => q.id === id);
      if(currentIndex === -1) return;
      
      const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
      
      // Check bounds
      if(newIndex < 0 || newIndex >= FB_QUESTIONS.length) return;
      
      // Swap questions
      const temp = FB_QUESTIONS[currentIndex];
      FB_QUESTIONS[currentIndex] = FB_QUESTIONS[newIndex];
      FB_QUESTIONS[newIndex] = temp;
      
      // Re-render
      fbRenderQuestions();
    }

    async function fbLoadExistingForMeeting(mid){
      document.getElementById("fbMsg").textContent="";
      FB_QUESTIONS=[]; FB_FORM_ID=null;
      document.getElementById("fbTitle").value="";
      document.getElementById("fbDesc").value="";
      document.getElementById("fbShare").style.display="none";
      document.getElementById("fbResults").style.display="none";
      document.getElementById("fbTeamsSection").style.display="none";
      document.getElementById("fbExtraSuggestions").value = ""; // Clear extra suggestions
      if(!mid){ fbRenderQuestions(); return; }

      try{
        const res = await apiGet(`/api/feedback/forms?meeting_id=${encodeURIComponent(mid)}`);
        const forms = Array.isArray(res) ? res : (res.forms||[]);
        const f = forms && forms.length ? forms[forms.length-1] : null;
        if(f){
          FB_FORM_ID = f.id;
          document.getElementById("fbTitle").value = f.title||"";
          document.getElementById("fbDesc").value  = f.description||"";
          FB_QUESTIONS = (f.questions||[]).map(q=>({
            id:q.id||('q_'+Math.random().toString(36).slice(2,9)),
            type:q.type, title:q.title||"",
            options:(q.options||[]).slice(0),
            min:q.min, max:q.max,
            max_answers: q.max_answers !== undefined ? q.max_answers : undefined,
            presenters: q.type === 'rating_presenter' ? (q.presenters || []) : undefined,
            mandatory:q.mandatory||false
          }));
          fbRenderQuestions();
          if(f.qr && (f.qr.qr_url || f.qr.url)){
            document.getElementById("fbShare").style.display="";
            setShareLinkAndQR({url: f.qr.url, qr_url: f.qr.qr_url});
          }
          if(FB_FORM_ID) fbFetchResults(FB_FORM_ID);
        }else{
          fbRenderQuestions();
        }
      }catch(e){ console.error(e); document.getElementById("fbMsg").textContent="Could not load form."; }
    }

    function fbCollectQuestionsFromDOM(){
      const wrap=document.getElementById("fbQList");
      wrap.querySelectorAll(".q-opts").forEach(box=>{
        const q=FB_QUESTIONS.find(x=>x.id===box.dataset.id);
        if(!q) return;
        const opts=Array.from(box.querySelectorAll(".q-opt")).map(i=>i.value.trim()).filter(Boolean);
        q.options = opts;
      });
      wrap.querySelectorAll(".q-title").forEach(inp=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.title=inp.value.trim(); });
      wrap.querySelectorAll(".q-min").forEach(inp=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.min=parseInt(inp.value||"1",10); });
      wrap.querySelectorAll(".q-max").forEach(inp=>{ const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); if(q) q.max=parseInt(inp.value||"5",10); });
      wrap.querySelectorAll(".q-mandatory").forEach(cb=>{ const q=FB_QUESTIONS.find(x=>x.id===cb.dataset.id); if(q) q.mandatory=cb.checked; });
      wrap.querySelectorAll(".q-max-answers").forEach(inp=>{ 
        const q=FB_QUESTIONS.find(x=>x.id===inp.dataset.id); 
        if(q) {
          const val = inp.value.trim();
          q.max_answers = val ? parseInt(val, 10) : undefined;
        }
      });
      
      // Collect presenters for rating_presenter questions (presenters are stored in question object, not DOM)
      // This is just to ensure presenters are included in the output
      FB_QUESTIONS.forEach(q => {
        if(q.type === 'rating_presenter' && !q.presenters) {
          q.presenters = [];
        }
      });
      
      return FB_QUESTIONS.slice();
    }

    async function fbSaveForm(){
      try{
        const meeting_id = document.getElementById("fbMeeting").value;
        const title = document.getElementById("fbTitle").value.trim() || "Meeting feedback";
        const description = document.getElementById("fbDesc").value.trim();
        if(!meeting_id){ alert("Choose the meeting for which you want the form."); return; }
        const questions = fbCollectQuestionsFromDOM();
        if(!questions.length){ alert("Add at least one question."); return; }

        const method = FB_FORM_ID ? "PUT" : "POST";
        const payload = FB_FORM_ID
          ? { id: FB_FORM_ID, meeting_id, title, description, questions }
          : { meeting_id, title, description, questions };

        const res = await apiSend("/api/feedback/forms", method, payload);
        if(!FB_FORM_ID) FB_FORM_ID = (res && (res.id || res.form_id)) || null;

        if(FB_FORM_ID){
          const qr = await apiSend(`/api/feedback/forms/${FB_FORM_ID}/qr`,"POST");
          document.getElementById("fbShare").style.display="";
          setShareLinkAndQR({url: qr.url, qr_url: qr.qr_url});
          fbFetchResults(FB_FORM_ID);
        }

        document.getElementById("fbMsg").textContent="Saved.";
      }catch(e){ console.error(e); document.getElementById("fbMsg").textContent="Error saving."; }
    }

    /* ---------- Teams message (EN) generat prin LLM + copy + HTML w/ QR ---------- */
    function buildTeamsHtmlEN({message,link,qrSrc}){
      const safeLink = link||"#";
      const safeMessage = escapeHtml(message||"Please provide your feedback using the link below.");
      const qrImg = qrSrc ? `<p><img src="${qrSrc}" alt="Feedback QR" style="max-width:220px;height:auto;border:1px solid #eee;border-radius:8px"></p>` : "";
      return `<div>
        <p>${safeMessage.replace(/\n/g, '<br>')}</p>
        <p><strong>Feedback link:</strong> <a href="${safeLink}">${safeLink}</a></p>
        ${qrImg}
      </div>`;
    }

    async function fbGenerateTeamsMsg(){
      if(!FB_FORM_ID){ alert("Save the form first."); return; }

      const sel = document.getElementById("fbMeeting");
      let title = document.getElementById("fbTitle").value.trim();
      let date = "";
      try{
        const ms = await apiGet("/api/meetings");
        const m  = ms.find(x => String(x.id) === String(sel.value));
        if(m){ if(!title) title = m.title||""; date = m.date||""; }
      }catch{}

      const linkEl = document.getElementById("fbLink");
      const normLink = normalizeFeedbackUrl(linkEl?.href || "");
      const qrSrc    = document.getElementById("fbQR")?.src || "";
      const extraSuggestions = document.getElementById("fbExtraSuggestions").value.trim();

      let txt = "";
      try{
        const res = await apiSend(`/api/feedback/forms/${FB_FORM_ID}/ai-copy`, "POST", {
          extra_suggestions: extraSuggestions
        });
        txt = (res && (res.text || res.message || res.copy)) || "";
      }catch(e){
        console.error(e);
      }

      if(!txt){
        txt = `Hi team ‚Äî thanks for joining ${title||"our session"}${date?` (${date})`:""}!\n` +
              `We'd love your quick feedback (30 seconds).\n\n` +
              `Please use the link below or scan the QR code:\n${normLink}`;
      }

      const textarea = document.getElementById("fbTeamsTxt");
      textarea.value = txt;
      document.getElementById("fbTeamsSection").style.display = "";
      document.getElementById("fbTeamsCopy").style.display = "";
      document.getElementById("fbTeamsCopyHtml").style.display = "";

      const html = buildTeamsHtmlEN({ message: txt, link: normLink, qrSrc });
      textarea.dataset.html = html;
    }

    function fbCopyTeamsText(){
      const textarea=document.getElementById("fbTeamsTxt");
      const txt=textarea.value||"";
      if(!txt) return;
      navigator.clipboard.writeText(txt).then(()=>alert("Message copied"));
    }
    async function fbCopyTeamsHtml(){
      const textarea=document.getElementById("fbTeamsTxt");
      const html=textarea.dataset.html||"";
      const plain=textarea.value||"";
      try{
        await navigator.clipboard.write([
          new ClipboardItem({
            "text/plain": new Blob([plain],{type:"text/plain"}),
            "text/html":  new Blob([html], {type:"text/html"})
          })
        ]);
        alert("HTML+QR copied");
      }catch{
        await navigator.clipboard.writeText(plain);
        alert("Copied as plain text");
      }
    }
    // Detailed results modal
    function showDetailedResults(question, questionIndex) {
      console.log('Debug - showDetailedResults called with:', { question, questionIndex });
      
      // Get the question ID from the raw form data
      const formData = window.currentFeedbackForm || {};
      const questions = formData.questions || [];
      const questionId = questions[questionIndex]?.id;
      
      console.log('Debug - Questions from form:', questions);
      console.log('Debug - Question ID found:', questionId);
      
      // Create modal overlay
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      // Create modal content
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 900px;
        width: 90%;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      `;
      
      // Modal header
      const header = document.createElement('div');
      header.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f0f2f5;
      `;
      
      const title = document.createElement('h3');
      title.style.cssText = `
        margin: 0;
        font-size: 18px;
        color: #1f2937;
      `;
      title.textContent = `Question ${questionIndex + 1}: ${question.title || 'Question'}`;
      
      const closeBtn = document.createElement('button');
      closeBtn.style.cssText = `
        background: #dc2626;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        font-weight: 500;
      `;
      closeBtn.textContent = '‚úï Close';
      closeBtn.onclick = () => modal.remove();
      
      header.appendChild(title);
      header.appendChild(closeBtn);
      
      // Modal body
      const body = document.createElement('div');
      body.style.cssText = `
        font-size: 14px;
        line-height: 1.6;
      `;
      
      // Get detailed responses for this question
      const detailedResponses = getDetailedResponsesForQuestion(questionId);
      
      if (detailedResponses.length === 0) {
        body.innerHTML = '<div style="text-align: center; color: #64748b; padding: 40px;">No detailed responses available</div>';
      } else {
        let content = `
          <div style="margin-bottom: 16px;">
            <span style="color: #3b82f6; font-weight: 600; font-size: 16px;">${detailedResponses.length} Answers</span>
          </div>
          <div style="
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          ">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                  <th style="
                    padding: 12px 16px;
                    text-align: left;
                    font-weight: 600;
                    color: #374151;
                    font-size: 14px;
                    border-right: 1px solid #e5e7eb;
                    width: 60px;
                  ">
                    ID ‚Üë
                  </th>
                  <th style="
                    padding: 12px 16px;
                    text-align: left;
                    font-weight: 600;
                    color: #374151;
                    font-size: 14px;
                    border-right: 1px solid #e5e7eb;
                    width: 250px;
                  ">
                    Name
                  </th>
                  <th style="
                    padding: 12px 16px;
                    text-align: left;
                    font-weight: 600;
                    color: #374151;
                    font-size: 14px;
                  ">
                    Responses
                  </th>
                </tr>
              </thead>
              <tbody>
        `;
        
        detailedResponses.forEach((response, i) => {
          const displayName = getDisplayName(response.email);
          const responseValue = formatResponseValueForTable(response.value, question.type);
          
          content += `
            <tr style="border-bottom: 1px solid #f3f4f6; ${i % 2 === 0 ? 'background: #ffffff;' : 'background: #f9fafb;'}">
              <td style="
                padding: 12px 16px;
                font-weight: 500;
                color: #6b7280;
                font-size: 14px;
                border-right: 1px solid #e5e7eb;
              ">
                ${i + 1}
              </td>
              <td style="
                padding: 12px 16px;
                font-weight: 500;
                color: #1f2937;
                font-size: 14px;
                border-right: 1px solid #e5e7eb;
              ">
                ${displayName}
              </td>
              <td style="
                padding: 12px 16px;
                color: #1f2937;
                font-size: 14px;
                line-height: 1.5;
              ">
                ${responseValue}
              </td>
            </tr>
          `;
        });
        
        content += `
              </tbody>
            </table>
          </div>
        `;
        
        body.innerHTML = content;
      }
      
      modalContent.appendChild(header);
      modalContent.appendChild(body);
      modal.appendChild(modalContent);
      
      // Close on overlay click
      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
      
      document.body.appendChild(modal);
    }

    function getDetailedResponsesForQuestion(questionId) {
      // Get the current feedback form data (raw responses)
      const formData = window.currentFeedbackForm || {};
      const responses = formData.responses || {};
      
      console.log('Debug - Form data:', formData);
      console.log('Debug - Question ID:', questionId);
      console.log('Debug - Responses:', responses);
      
      // Convert responses object to array and filter for this question
      const questionResponses = Object.entries(responses)
        .filter(([email, response]) => {
          const answers = response.answers || {};
          console.log(`Debug - Email: ${email}, Answers:`, answers, 'Has questionId?', answers[questionId] !== undefined);
          return answers[questionId] !== undefined;
        })
        .map(([email, response]) => ({
          email: email || 'Anonymous',
          value: response.answers[questionId],
          timestamp: response.ts ? new Date(response.ts * 1000).toLocaleString() : 'Unknown time'
        }));
      
      console.log('Debug - Filtered responses:', questionResponses);
      return questionResponses;
    }

    function getDisplayName(email) {
      if (!email) return 'Anonymous';
      
      // Use the same logic as nameForEmail - search in MEMBERS array
      const em = (email || "").toLowerCase();
      const member = MEMBERS.find(x => (x.email || "").toLowerCase() === em);
      
      if (member && member.name) {
        return member.name;
      }
      
      // Fallback: try to extract name from email
      const namePart = email.split('@')[0];
      const displayName = namePart
        .replace(/[._]/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
      
      return displayName || email;
    }

    function getTypeColor(type) {
      const colors = {
        'single': '#3b82f6',
        'multi': '#8b5cf6', 
        'rating': '#f59e0b',
        'rating_presenter': '#8b5cf6',
        'text': '#10b981'
      };
      return colors[type] || '#6b7280';
    }

    function formatResponseValue(value, questionType) {
      if (questionType === 'rating') {
        return `${value}/5 ‚≠ê`.repeat(value);
      } else if (questionType === 'rating_presenter') {
        if (typeof value === 'object' && value !== null) {
          return Object.entries(value).map(([presenter, rating]) => 
            `üé§ ${presenter}: ${rating}/5 ‚≠ê`.repeat(rating)
          ).join('<br>');
        }
        return String(value);
      } else if (questionType === 'multi') {
        if (Array.isArray(value)) {
          return value.map(v => `‚Ä¢ ${v}`).join('<br>');
        }
        return `‚Ä¢ ${value}`;
      } else if (questionType === 'text') {
        return `"${value}"`;
      } else {
        return value;
      }
    }

    function formatResponseValueForTable(value, questionType) {
      if (questionType === 'rating') {
        return `${value}/5`;
      } else if (questionType === 'rating_presenter') {
        if (typeof value === 'object' && value !== null) {
          return Object.entries(value).map(([presenter, rating]) => 
            `${presenter}: ${rating}/5`
          ).join(', ');
        }
        return String(value);
      } else if (questionType === 'multi') {
        if (Array.isArray(value)) {
          return value.join(', ');
        }
        return value;
      } else if (questionType === 'text') {
        return value;
      } else {
        return value;
      }
    }

    async function fbFetchResults(fid){
      try{
        const res = await apiGet(`/api/feedback/forms/${fid}/results`);
        const body = document.getElementById("fbResBody");
        const panel = document.getElementById("fbResults");
        body.innerHTML = "";
        panel.style.display = "";

        // Store results globally for detailed view
        window.currentFeedbackResults = res;
        
        // Also store the raw form data for detailed responses
        const rawForm = await apiGet(`/api/feedback/forms/${fid}`);
        console.log('Debug - Raw form data:', rawForm);
        window.currentFeedbackForm = rawForm;
        
        // Store meeting data for participant names
        if (rawForm.meeting_id) {
          // Get all meetings and find the specific one
          const meetings = await apiGet("/api/meetings");
          const meeting = meetings.find(m => String(m.id) === String(rawForm.meeting_id));
          window.currentMeeting = meeting;
          console.log('Debug - Meeting data:', meeting);
        }

        const questions = (res && (res.questions || res.meta || [])) || [];
        const results = (res && (res.results || res.data || {})) || {};
        const totalResponses = res && res.total_responses ? res.total_responses : 0;

        // Update total responses counter
        const totalResponsesEl = document.getElementById("fbTotalResponses");
        if(totalResponsesEl) {
          totalResponsesEl.textContent = totalResponses;
        }

        if(!questions.length){
          body.innerHTML = `<div class="muted">No responses yet.</div>`;
          return;
        }

        questions.forEach((q, index) => {
          const card = document.createElement("div");
          card.className = "feedback-result-card";
          card.style.cssText = `
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s ease;
          `;
          card.onmouseover = () => card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
          card.onmouseout = () => card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';

          // Header with question number and title
          const header = document.createElement("div");
          header.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
          `;
          
          const titleContainer = document.createElement("div");
          titleContainer.style.cssText = `
            display: flex;
            align-items: center;
            gap: 12px;
          `;
          
          const questionNumber = document.createElement("span");
          questionNumber.style.cssText = `
            background: #f3f4f6;
            color: #374151;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
          `;
          questionNumber.textContent = index + 1;
          
          const title = document.createElement("h3");
          title.style.cssText = `
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.4;
          `;
          title.textContent = q.title || 'Question';
          
          const moreInfoBtn = document.createElement("button");
          moreInfoBtn.style.cssText = `
            background: none;
            color: #3b82f6;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          `;
          moreInfoBtn.textContent = "More details";
          moreInfoBtn.onclick = () => showDetailedResults(q, index);
          moreInfoBtn.onmouseover = () => moreInfoBtn.style.backgroundColor = "#f0f9ff";
          moreInfoBtn.onmouseout = () => moreInfoBtn.style.backgroundColor = "transparent";
          
          titleContainer.appendChild(questionNumber);
          titleContainer.appendChild(title);
          header.appendChild(titleContainer);
          header.appendChild(moreInfoBtn);
          card.appendChild(header);

          // Content based on question type
          if((q.type==='single' || q.type==='multi')){
            const options = q.options || [];
            if(!options.length){ 
              const noData = document.createElement('div');
              noData.style.cssText = `
                text-align: center;
                color: #8a8886;
                font-style: italic;
                padding: 40px 20px;
                background: #faf9f8;
                border-radius: 8px;
              `;
              noData.textContent = 'No responses yet';
              card.appendChild(noData);
            } else {
              const totalResponses = options.reduce((sum, opt) => sum + (opt.count || 0), 0);
              
              if(totalResponses > 0) {
                const statsHeader = document.createElement("div");
                statsHeader.style.cssText = `
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 16px;
                `;
                
                const responseCount = document.createElement("div");
                responseCount.style.cssText = `
                  color: #605e5c;
                  font-size: 14px;
                  font-weight: 500;
                `;
                responseCount.textContent = `${totalResponses} response${totalResponses !== 1 ? 's' : ''}`;
                
                const percentage = document.createElement("div");
                percentage.style.cssText = `
                  color: #0078d4;
                  font-size: 14px;
                  font-weight: 600;
                `;
                percentage.textContent = '100%';
                
                statsHeader.appendChild(responseCount);
                statsHeader.appendChild(percentage);
                card.appendChild(statsHeader);
                
                // Add "Top X" section for multiple choice questions
                if(q.type === 'multi' && totalResponses > 0) {
                  // Get max_answers from original form question if available
                  let maxAnswers = 5; // Default to 5 if no limit
                  if (window.currentFeedbackForm && window.currentFeedbackForm.questions) {
                    const originalQuestion = window.currentFeedbackForm.questions.find(origQ => 
                      origQ.id === q.id || origQ.title === q.title
                    );
                    if (originalQuestion && originalQuestion.max_answers) {
                      maxAnswers = parseInt(originalQuestion.max_answers, 10);
                    }
                  }
                  
                  const sortedOptions = [...options].sort((a, b) => (b.count || 0) - (a.count || 0));
                  const topOptions = sortedOptions.slice(0, maxAnswers).filter(opt => (opt.count || 0) > 0);
                  
                  if(topOptions.length > 0) {
                    const topContainer = document.createElement("div");
                    topContainer.style.cssText = `
                      background: #f8fafc;
                      border: 1px solid #e5e7eb;
                      border-radius: 8px;
                      padding: 16px;
                      margin-bottom: 20px;
                    `;
                    
                    const topTitle = document.createElement("div");
                    topTitle.style.cssText = `
                      font-size: 14px;
                      font-weight: 600;
                      color: #374151;
                      margin-bottom: 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                    `;
                    topTitle.innerHTML = `üèÜ Top ${topOptions.length} Most Selected`;
                    topContainer.appendChild(topTitle);
                    
                    const topList = document.createElement("div");
                    topList.style.cssText = `
                      display: flex;
                      flex-direction: column;
                      gap: 8px;
                    `;
                    
                    // Colors for top list
                    const topColors = ['#3b82f6', '#ec4899', '#10b981', '#8b5cf6', '#f59e0b'];
                    
                    topOptions.forEach((opt, idx) => {
                      const topItem = document.createElement("div");
                      topItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px;
                        background: white;
                        border-radius: 6px;
                        border: 1px solid #e5e7eb;
                      `;
                      
                      // Rank badge
                      const rankBadge = document.createElement("div");
                      rankBadge.style.cssText = `
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        background: ${topColors[idx % topColors.length]};
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                        font-size: 14px;
                        flex-shrink: 0;
                      `;
                      rankBadge.textContent = idx + 1;
                      
                      // Option text
                      const optText = document.createElement("div");
                      optText.style.cssText = `
                        flex: 1;
                        font-size: 14px;
                        color: #374151;
                        font-weight: 500;
                      `;
                      optText.textContent = opt.value;
                      
                      // Count badge
                      const countBadge = document.createElement("div");
                      countBadge.style.cssText = `
                        background: #f3f4f6;
                        color: #6b7280;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                        white-space: nowrap;
                      `;
                      countBadge.textContent = `${opt.count || 0} response${(opt.count || 0) !== 1 ? 's' : ''}`;
                      
                      topItem.appendChild(rankBadge);
                      topItem.appendChild(optText);
                      topItem.appendChild(countBadge);
                      topList.appendChild(topItem);
                    });
                    
                    topContainer.appendChild(topList);
                    card.appendChild(topContainer);
                  }
                }
              }

              // Create a single container with combined option + bar for each item
              const contentContainer = document.createElement("div");
              contentContainer.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 12px;
              `;
              
              // Colors for bars
              const colors = ['#3b82f6', '#ec4899', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
              const maxCount = Math.max(...options.map(opt => opt.count || 0));
              
              options.forEach((opt, optIndex) => {
                const count = opt.count || 0;
                const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                // Container for each option (text + bar combined)
                const optionContainer = document.createElement("div");
                optionContainer.style.cssText = `
                  display: flex;
                  flex-direction: column;
                  gap: 6px;
                `;
                
                // Top row: bullet, text, count
                const optionRow = document.createElement("div");
                optionRow.style.cssText = `
                  display: flex;
                  align-items: center;
                  gap: 8px;
                `;
                
                const bullet = document.createElement("div");
                bullet.style.cssText = `
                  width: 8px;
                  height: 8px;
                  border-radius: 50%;
                  background: ${colors[optIndex % colors.length]};
                  flex-shrink: 0;
                `;
                
                const optionText = document.createElement("span");
                optionText.style.cssText = `
                  font-size: 13px;
                  color: #374151;
                  font-weight: 500;
                  flex: 1;
                `;
                optionText.textContent = opt.value;
                
                const countText = document.createElement("span");
                countText.style.cssText = `
                  font-size: 13px;
                  color: #6b7280;
                  font-weight: 500;
                  white-space: nowrap;
                `;
                countText.textContent = `${count} response${count !== 1 ? 's' : ''}`;
                
                optionRow.appendChild(bullet);
                optionRow.appendChild(optionText);
                optionRow.appendChild(countText);
                
                // Bottom row: bar aligned with text
                const barContainer = document.createElement("div");
                barContainer.style.cssText = `
                  display: flex;
                  align-items: center;
                  height: 12px;
                  margin-left: 16px; /* Align with text (8px bullet + 8px gap) */
                `;
                
                const bar = document.createElement("div");
                bar.style.cssText = `
                  width: ${barWidth}%;
                  height: 12px;
                  background: ${colors[optIndex % colors.length]};
                  border-radius: 6px;
                  transition: width 0.3s ease;
                `;
                
                barContainer.appendChild(bar);
                
                optionContainer.appendChild(optionRow);
                optionContainer.appendChild(barContainer);
                contentContainer.appendChild(optionContainer);
              });
              
              card.appendChild(contentContainer);
            }
          } else if(q.type==='rating'){
            const avg = q.avg;
            const counts = q.counts || {};
            const totalResponses = Object.values(counts).reduce((a,b) => a+b, 0);
            
            if(totalResponses > 0) {
              const ratingContainer = document.createElement("div");
              ratingContainer.style.cssText = "text-align: center;";
              
              const avgDisplay = document.createElement("div");
              avgDisplay.style.cssText = `
                font-size: 48px;
                font-weight: 700;
                color: #0078d4;
                margin-bottom: 8px;
                line-height: 1;
              `;
              avgDisplay.textContent = avg ? avg.toFixed(1) : '‚Äì';
              
              const starsContainer = document.createElement("div");
              starsContainer.style.cssText = `
                display: flex;
                justify-content: center;
                gap: 4px;
                margin-bottom: 16px;
              `;
              
              const maxRating = 5;
              for(let i = 1; i <= maxRating; i++) {
                const star = document.createElement("div");
                star.style.cssText = `
                  width: 24px;
                  height: 24px;
                  background: ${i <= Math.round(avg) ? '#ffb900' : '#e1e5e9'};
                  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                  transition: all 0.3s ease;
                  animation: starGlow 0.6s ease-out ${i * 0.1}s both;
                `;
                star.onmouseover = () => {
                  if(i <= Math.round(avg)) {
                    star.style.transform = 'scale(1.2)';
                    star.style.filter = 'drop-shadow(0 0 8px #ffb900)';
                  }
                };
                star.onmouseout = () => {
                  star.style.transform = 'scale(1)';
                  star.style.filter = 'none';
                };
                starsContainer.appendChild(star);
              }
              
              const responseCount = document.createElement("div");
              responseCount.style.cssText = `
                color: #605e5c;
                font-size: 14px;
                margin-bottom: 20px;
              `;
              responseCount.textContent = `${totalResponses} response${totalResponses !== 1 ? 's' : ''}`;
              
              // Rating distribution
              const distributionContainer = document.createElement("div");
              distributionContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin-top: 16px;
              `;
              
              for(let i = 1; i <= 5; i++) {
                const ratingItem = document.createElement("div");
                ratingItem.style.cssText = `
                  text-align: center;
                  padding: 8px;
                  background: #faf9f8;
                  border-radius: 6px;
                `;
                
                const ratingValue = document.createElement("div");
                ratingValue.style.cssText = `
                  font-size: 18px;
                  font-weight: 600;
                  color: #323130;
                  margin-bottom: 4px;
                `;
                ratingValue.textContent = i;
                
                const ratingCount = document.createElement("div");
                ratingCount.style.cssText = `
                  font-size: 12px;
                  color: #605e5c;
                `;
                ratingCount.textContent = counts[i] || 0;
                
                ratingItem.appendChild(ratingValue);
                ratingItem.appendChild(ratingCount);
                distributionContainer.appendChild(ratingItem);
              }
              
              ratingContainer.appendChild(avgDisplay);
              ratingContainer.appendChild(starsContainer);
              ratingContainer.appendChild(responseCount);
              ratingContainer.appendChild(distributionContainer);
              card.appendChild(ratingContainer);
            } else {
              const noData = document.createElement('div');
              noData.style.cssText = `
                text-align: center;
                color: #8a8886;
                font-style: italic;
                padding: 40px 20px;
                background: #faf9f8;
                border-radius: 8px;
              `;
              noData.textContent = 'No responses yet';
              card.appendChild(noData);
            }
          } else if(q.type==='rating_presenter'){
            const presenterRatings = q.presenter_ratings || [];
            
            if(presenterRatings.length === 0) {
              const noData = document.createElement('div');
              noData.style.cssText = `
                text-align: center;
                color: #8a8886;
                font-style: italic;
                padding: 40px 20px;
                background: #faf9f8;
                border-radius: 8px;
              `;
              noData.textContent = 'No responses yet';
              card.appendChild(noData);
            } else {
              presenterRatings.forEach(pr => {
                if(pr.count === 0) return; // Skip presenters with no ratings
                
                const presenterCard = document.createElement("div");
                presenterCard.style.cssText = `
                  margin-bottom: 24px;
                  padding: 20px;
                  background: #faf5ff;
                  border: 2px solid #e9d5ff;
                  border-radius: 12px;
                `;
                
                const presenterHeader = document.createElement("div");
                presenterHeader.style.cssText = `
                  font-weight: 600;
                  color: #374151;
                  margin-bottom: 12px;
                  font-size: 16px;
                `;
                presenterHeader.textContent = `üé§ ${pr.presenter}`;
                presenterCard.appendChild(presenterHeader);
                
                const avgDisplay = document.createElement("div");
                avgDisplay.style.cssText = `
                  font-size: 36px;
                  font-weight: 700;
                  color: #8b5cf6;
                  margin-bottom: 8px;
                  line-height: 1;
                  text-align: center;
                `;
                avgDisplay.textContent = pr.avg ? pr.avg.toFixed(1) : '‚Äì';
                presenterCard.appendChild(avgDisplay);
                
                const starsContainer = document.createElement("div");
                starsContainer.style.cssText = `
                  display: flex;
                  justify-content: center;
                  gap: 4px;
                  margin-bottom: 12px;
                `;
                
                const maxRating = 5;
                for(let i = 1; i <= maxRating; i++) {
                  const star = document.createElement("div");
                  star.style.cssText = `
                    width: 20px;
                    height: 20px;
                    background: ${i <= Math.round(pr.avg || 0) ? '#8b5cf6' : '#e1e5e9'};
                    clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                  `;
                  starsContainer.appendChild(star);
                }
                presenterCard.appendChild(starsContainer);
                
                const responseCount = document.createElement("div");
                responseCount.style.cssText = `
                  color: #605e5c;
                  font-size: 12px;
                  text-align: center;
                  margin-bottom: 16px;
                `;
                responseCount.textContent = `${pr.count} rating${pr.count !== 1 ? 's' : ''}`;
                presenterCard.appendChild(responseCount);
                
                // Rating distribution
                const distributionContainer = document.createElement("div");
                distributionContainer.style.cssText = `
                  display: grid;
                  grid-template-columns: repeat(5, 1fr);
                  gap: 6px;
                  margin-top: 12px;
                `;
                
                for(let i = 1; i <= 5; i++) {
                  const ratingItem = document.createElement("div");
                  ratingItem.style.cssText = `
                    text-align: center;
                    padding: 6px;
                    background: white;
                    border-radius: 6px;
                    border: 1px solid #e9d5ff;
                  `;
                  
                  const ratingValue = document.createElement("div");
                  ratingValue.style.cssText = `
                    font-size: 16px;
                    font-weight: 600;
                    color: #8b5cf6;
                    margin-bottom: 2px;
                  `;
                  ratingValue.textContent = i;
                  
                  const ratingCount = document.createElement("div");
                  ratingCount.style.cssText = `
                    font-size: 11px;
                    color: #605e5c;
                  `;
                  ratingCount.textContent = pr.counts[i] || 0;
                  
                  ratingItem.appendChild(ratingValue);
                  ratingItem.appendChild(ratingCount);
                  distributionContainer.appendChild(ratingItem);
                }
                
                presenterCard.appendChild(distributionContainer);
                card.appendChild(presenterCard);
              });
            }
          } else { // text
            const texts = q.responses || [];
            if(!texts.length){
              const noData = document.createElement('div');
              noData.style.cssText = `
                text-align: center;
                color: #8a8886;
                font-style: italic;
                padding: 40px 20px;
                background: #faf9f8;
                border-radius: 8px;
              `;
              noData.textContent = 'No responses yet';
              card.appendChild(noData);
            } else {
              const responseCount = document.createElement("div");
              responseCount.style.cssText = `
                color: #605e5c;
                font-size: 14px;
                font-weight: 500;
                margin-bottom: 16px;
              `;
              responseCount.textContent = `${texts.length} response${texts.length !== 1 ? 's' : ''}`;
              card.appendChild(responseCount);
              
              const responsesContainer = document.createElement("div");
              responsesContainer.style.cssText = `
                display: grid;
                gap: 12px;
                max-height: 300px;
                overflow-y: auto;
              `;
              
              texts.slice(0, 50).forEach((text, idx) => {
                const responseItem = document.createElement("div");
                responseItem.style.cssText = `
                  background: #f8f9fa;
                  border-left: 4px solid #0078d4;
                  padding: 12px 16px;
                  border-radius: 0 6px 6px 0;
                  font-size: 14px;
                  line-height: 1.5;
                  color: #323130;
                `;
                responseItem.textContent = text;
                responsesContainer.appendChild(responseItem);
              });
              
              if(texts.length > 50) {
                const moreText = document.createElement("div");
                moreText.style.cssText = `
                  text-align: center;
                  color: #605e5c;
                  font-size: 12px;
                  font-style: italic;
                  margin-top: 8px;
                `;
                moreText.textContent = `... and ${texts.length - 50} more responses`;
                responsesContainer.appendChild(moreText);
              }
              
              card.appendChild(responsesContainer);
            }
          }

          body.appendChild(card);
        });
      }catch(e){
        console.error(e);
        const body = document.getElementById("fbResBody");
        body.innerHTML = `<div class="muted">Could not load results.</div>`;
        document.getElementById("fbResults").style.display = "";
      }
    }

    function fbCopy(s){
      if(!s) return;
      navigator.clipboard.writeText(s).then(()=>alert("Copied to clipboard"));
    }

    /* ---------- Modal & utils ---------- */
    function openModal(html){
      const m=document.getElementById("modal");
      const b=document.getElementById("modalBody");
      b.innerHTML = typeof html==='string' ? html : '';
      m.classList.remove("hidden");
    }
    function closeModal(){
      const m=document.getElementById("modal");
      const b=document.getElementById("modalBody");
      b.innerHTML='';
      m.classList.add("hidden");
    }

    // initial loading for default tab
    window.addEventListener('DOMContentLoaded', ()=>{ 
      loadMembers().catch(()=>{}); 
      TPL_init(); // Initialize templates on page load
    });

    /* ---------- Rewards System ---------- */
    let LEADERBOARD_DATA = [];
    let LEADERBOARD_STATE = { 
      showAll: false, 
      page: 1, 
      pageSize: 10 
    };
    async function initRewards() {
      await loadMembers();
      await loadLeaderboard();
      await loadCriteria();
      populateMemberSelect();
      await populateCriteriaSelect();
      await populateBadgeMemberSelect();
      await loadCustomBadges();
    }

    async function recalculateAllPoints() {
      const btn = document.getElementById('recalculatePointsBtn');
      const msg = document.getElementById('recalculatePointsMsg');
      
      if (!confirm('Are you sure you want to reset and recalculate all automatic points? This will remove existing automatic points entries (meeting attendance, presentations, debates) and recalculate them based on current rules. Quarterly badges (including Quarter Speaker badges) will also be recalculated.')) {
        return;
      }
      
      btn.disabled = true;
      msg.textContent = 'Recalculating all automatic points and badges...';
      msg.style.color = '#6b7280';
      
      try {
        const response = await fetch('/api/rewards/recalculate-points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          msg.textContent = `‚úÖ ${result.message || 'All points recalculated successfully!'}`;
          msg.style.color = '#059669';
          // Reload leaderboard to show updated scores
          await loadLeaderboard();
        } else {
          msg.textContent = `‚ùå Error: ${result.error || 'Failed to recalculate points'}`;
          msg.style.color = '#dc2626';
        }
      } catch (error) {
        msg.textContent = `‚ùå Error: ${error.message || 'Failed to recalculate points'}`;
        msg.style.color = '#dc2626';
      } finally {
        btn.disabled = false;
        setTimeout(() => {
          msg.textContent = '';
        }, 8000);
      }
    }

    function switchRewardTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Load data for specific tabs
      if (tabName === 'leaderboard') {
        loadLeaderboard();
      } else if (tabName === 'criteria') {
        loadCriteria();
        loadCustomBadges();
      } else if (tabName === 'points') {
        populateMemberSelect();
        populateCriteriaSelect();
        populateBadgeMemberSelect();
        populateBadgeSelect();
      }
    }

    async function loadLeaderboard() {
      try {
        const response = await fetch('/api/rewards/leaderboard');
        LEADERBOARD_DATA = await response.json();
        
        renderLeaderboard();
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboard').innerHTML = '<div class="error">Error loading leaderboard</div>';
      }
    }

    async function renderLeaderboard() {
      const container = document.getElementById('leaderboard');
      const pager = document.getElementById('leaderboardPager');
      const toggleBtn = document.getElementById('toggleViewBtn');
      const toggleText = document.getElementById('toggleText');
      
      if (LEADERBOARD_DATA.length === 0) {
        container.innerHTML = '<div class="loading">No points data available</div>';
        pager.style.display = 'none';
        return;
      }

      let displayData = LEADERBOARD_DATA;
      
      if (!LEADERBOARD_STATE.showAll) {
        // Show only top 10
        displayData = LEADERBOARD_DATA.slice(0, 10);
        pager.style.display = 'none';
        toggleText.textContent = 'Show All';
      } else {
        // Show paginated view
        const startIndex = (LEADERBOARD_STATE.page - 1) * LEADERBOARD_STATE.pageSize;
        const endIndex = startIndex + LEADERBOARD_STATE.pageSize;
        displayData = LEADERBOARD_DATA.slice(startIndex, endIndex);
        pager.style.display = 'flex';
        toggleText.textContent = 'Show Top 10';
        
        // Update pager info
        const totalPages = Math.ceil(LEADERBOARD_DATA.length / LEADERBOARD_STATE.pageSize);
        document.getElementById('leaderboardPageInfo').textContent = 
          `Page ${LEADERBOARD_STATE.page} of ${totalPages} (${LEADERBOARD_DATA.length} total)`;
      }

      // Generate badges async for all members
      const itemsWithBadges = await Promise.all(displayData.map(async (member, index) => {
        const globalIndex = LEADERBOARD_STATE.showAll ? 
          (LEADERBOARD_STATE.page - 1) * LEADERBOARD_STATE.pageSize + index : 
          index;
        const rankClass = ''; // Removed rank styling
        const badges = await generateBadges(member, globalIndex);
        return {
          member,
          globalIndex,
          rankClass,
          badges
        };
      }));

          container.innerHTML = itemsWithBadges.map(({ member, globalIndex, rankClass, badges }) => {
            // Get top 5 unique point values for color coding
            const top5Points = getTop5Ranks();
            const rankTier = top5Points.indexOf(member.total_points) + 1;
            let rankColorClass = '';
            
            if (rankTier === 1) rankColorClass = 'legend-rank';
            else if (rankTier === 2) rankColorClass = 'platinum-rank';
            else if (rankTier === 3) rankColorClass = 'gold-rank';
            else if (rankTier === 4) rankColorClass = 'silver-rank';
            else if (rankTier === 5) rankColorClass = 'bronze-rank';
            
            return `
              <div class="leaderboard-item ${rankClass}" onclick="showMemberDetails('${member.email}')">
                <div class="rank ${rankColorClass}">${globalIndex + 1}</div>
                <div class="member-info">
                  <div class="member-name">${member.name}</div>
                  <div class="member-email">${member.email}</div>
                  <div class="member-badges">${badges}</div>
                </div>
                <div class="points">${member.total_points} pts</div>
              </div>
            `;
          }).join('');
    }

    function toggleLeaderboardView() {
      LEADERBOARD_STATE.showAll = !LEADERBOARD_STATE.showAll;
      LEADERBOARD_STATE.page = 1; // Reset to first page
      renderLeaderboard();
    }

    function leaderboardPrevPage() {
      if (LEADERBOARD_STATE.page > 1) {
        LEADERBOARD_STATE.page--;
        renderLeaderboard();
      }
    }

    function leaderboardNextPage() {
      const totalPages = Math.ceil(LEADERBOARD_DATA.length / LEADERBOARD_STATE.pageSize);
      if (LEADERBOARD_STATE.page < totalPages) {
        LEADERBOARD_STATE.page++;
        renderLeaderboard();
      }
    }

    async function loadCriteria() {
      try {
        const response = await fetch('/api/rewards/criteria');
        const criteria = await response.json();
        
        const container = document.getElementById('criteriaList');
        if (criteria.length === 0) {
          container.innerHTML = '<div class="loading">No criteria defined</div>';
          return;
        }

        container.innerHTML = criteria.map(criterion => `
          <div class="criteria-item">
            <div>
              <div class="criteria-name">${criterion.name}</div>
              <div class="criteria-points">${criterion.points} pts</div>
            </div>
            <div>
              <button class="btn danger" onclick="deleteCriteria(${criterion.id})" style="padding: 6px 12px; font-size: 12px;">
                Delete
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading criteria:', error);
        document.getElementById('criteriaList').innerHTML = '<div class="error">Error loading criteria</div>';
      }
    }


    function populateMemberSelect() {
      const select = document.getElementById('memberSelect');
      select.innerHTML = '<option value="">Select member...</option>';
      
      MEMBERS.forEach(member => {
        const option = document.createElement('option');
        option.value = member.email;
        option.textContent = member.name;
        select.appendChild(option);
      });
    }

    async function populateCriteriaSelect() {
      const select = document.getElementById('criteriaSelect');
      select.innerHTML = '<option value="">Select criteria...</option>';
      
      try {
        // Load criteria from server
        const response = await fetch('/api/rewards/criteria');
        const serverCriteria = await response.json();
        
        // Add server criteria first
        serverCriteria.forEach(criteria => {
          const option = document.createElement('option');
          option.value = criteria.name;
          option.textContent = `${criteria.name} (${criteria.points} pts)`;
          select.appendChild(option);
        });
        
        // Add default criteria (only if not already present)
        const defaultCriteria = [
          { name: 'Meeting Attendance', points: 5 },
          { name: 'Presentation', points: 15 },
          { name: 'Debate Participation', points: 5 },
          { name: 'Debate Winner', points: 15 }
        ];
        
        const existingNames = serverCriteria.map(c => c.name);
        defaultCriteria.forEach(criteria => {
          if (!existingNames.includes(criteria.name)) {
            const option = document.createElement('option');
            option.value = criteria.name;
            option.textContent = `${criteria.name} (${criteria.points} pts)`;
            select.appendChild(option);
          }
        });
      } catch (error) {
        console.error('Error loading criteria for dropdown:', error);
        // Fallback to default criteria only
        const defaultCriteria = [
          { name: 'Meeting Attendance', points: 5 },
          { name: 'Presentation', points: 15 },
          { name: 'Debate Participation', points: 5 },
          { name: 'Debate Winner', points: 15 }
        ];
        
        defaultCriteria.forEach(criteria => {
          const option = document.createElement('option');
          option.value = criteria.name;
          option.textContent = `${criteria.name} (${criteria.points} pts)`;
          select.appendChild(option);
        });
      }
    }

    async function getCriteriaPoints(criteriaName) {
      try {
        // First try to get from server
        const response = await fetch('/api/rewards/criteria');
        const serverCriteria = await response.json();
        const serverCriterion = serverCriteria.find(c => c.name === criteriaName);
        if (serverCriterion) {
          return serverCriterion.points;
        }
      } catch (error) {
        console.error('Error loading criteria for points:', error);
      }
      
      // Fallback to default criteria
      const defaultCriteria = [
        { name: 'Meeting Attendance', points: 5 },
        { name: 'Presentation', points: 15 },
        { name: 'Debate Participation', points: 5 },
        { name: 'Debate Winner', points: 15 }
      ];
      
      const criteria = defaultCriteria.find(c => c.name === criteriaName);
      return criteria ? criteria.points : null;
    }

    async function addPoints() {
      const memberEmail = document.getElementById('memberSelect').value;
      const criteria = document.getElementById('criteriaSelect').value;

      if (!memberEmail || !criteria) {
        alert('Please select both member and criteria');
        return;
      }

      // Get points from selected criteria
      const criteriaPoints = await getCriteriaPoints(criteria);
      if (!criteriaPoints) {
        alert('Could not find points for selected criteria');
        return;
      }

      try {
        const response = await fetch('/api/rewards/points', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            member_email: memberEmail,
            criteria: criteria,
            points: criteriaPoints,
            reason: `Awarded for: ${criteria}`
          })
        });

        if (response.ok) {
          // Clear form
          document.getElementById('memberSelect').value = '';
          document.getElementById('criteriaSelect').value = '';
          
          // Reload data
          await loadLeaderboard();
          
          alert('Points added successfully!');
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        console.error('Error adding points:', error);
        alert('Error adding points: ' + error.message);
      }
    }

    async function addCriteria() {
      const name = document.getElementById('newCriteriaName').value.trim();
      const points = parseInt(document.getElementById('newCriteriaPoints').value);

      if (!name || !points) {
        alert('Please fill in both name and points');
        return;
      }

      try {
        const response = await fetch('/api/rewards/criteria', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, points })
        });

        if (response.ok) {
          // Clear form
          document.getElementById('newCriteriaName').value = '';
          document.getElementById('newCriteriaPoints').value = '';
          
          // Reload data
          await loadCriteria();
          await populateCriteriaSelect();
          
          alert('Criteria added successfully!');
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        console.error('Error adding criteria:', error);
        alert('Error adding criteria: ' + error.message);
      }
    }

    async function deleteCriteria(criteriaId) {
      if (!confirm('Are you sure you want to delete this criteria?')) {
        return;
      }

      try {
        const response = await fetch(`/api/rewards/criteria/${criteriaId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          await loadCriteria();
          await populateCriteriaSelect();
          alert('Criteria deleted successfully!');
        } else {
          const error = await response.json();
          alert('Error: ' + error.error);
        }
      } catch (error) {
        console.error('Error deleting criteria:', error);
        alert('Error deleting criteria: ' + error.message);
      }
    }

    async function deletePoints() {
      const memberEmail = document.getElementById('memberSelect').value;
      const criteria = document.getElementById('criteriaSelect').value;

      if (!memberEmail || !criteria) {
        alert('Please select both member and criteria');
        return;
      }

      if (!confirm(`Are you sure you want to delete points for ${criteria} from this member?`)) {
        return;
      }

      try {
        // First get the points entries for this member and criteria
        const response = await fetch('/api/rewards/points');
        const entries = await response.json();
        
        const memberEntries = entries.filter(entry => 
          entry.member_email === memberEmail && entry.criteria === criteria
        );

        if (memberEntries.length === 0) {
          alert('No points found for this member and criteria');
          return;
        }

        // Delete each entry
        for (const entry of memberEntries) {
          await fetch(`/api/rewards/points/${entry.id}`, {
            method: 'DELETE'
          });
        }

        // Clear form
        document.getElementById('memberSelect').value = '';
        document.getElementById('criteriaSelect').value = '';
        
        // Reload data
        await loadLeaderboard();
        
        alert(`Deleted ${memberEntries.length} point entries successfully!`);
      } catch (error) {
        console.error('Error deleting points:', error);
        alert('Error deleting points: ' + error.message);
      }
    }

    // Badge system
    async function generateBadges(member, memberIndex) {
      const badges = [];
      const totalPoints = member.total_points || 0;
      
      // Get top 5 unique point values
      const top5Points = getTop5Ranks();
      
      // Find which rank tier this member belongs to (1-5)
      const rankTier = top5Points.indexOf(totalPoints) + 1;
      
      // Debug logging
      console.log(`Member ${member.name} (${member.email}): points=${totalPoints}, rankTier=${rankTier}, top5Points=${top5Points.join(', ')}`);
      
      // Top Members Badges - based on rank tier (1-5)
      if (rankTier === 1) badges.push('<span class="badge top-member">üëë QA Legend</span>');
      else if (rankTier === 2) badges.push('<span class="badge top-member">üíé QA Platinum</span>');
      else if (rankTier === 3) badges.push('<span class="badge top-member">ü•á QA Gold</span>');
      else if (rankTier === 4) badges.push('<span class="badge top-member">ü•à QA Silver</span>');
      else if (rankTier === 5) badges.push('<span class="badge top-member">ü•â QA Bronze</span>');
      
      // Points-based badges (removed High Achiever as it's not in legend)
      
      // Activity-based badges (simplified for now)
      if (member.points_breakdown?.presentation > 0) {
        // First-Time Speaker badge - if they have at least 1 presentation (15+ points)
        badges.push('<span class="badge monthly">üÜï First-Time Speaker</span>');
        
        // Speaker badge - if they have more than 1 presentation (30+ points)
        if (member.points_breakdown.presentation >= 30) { // 30+ points = 2+ presentations
          badges.push('<span class="badge monthly">üì¢ Speaker</span>');
        }
      }
      // Check for debate_participant badge
      if (member.points_breakdown?.debate_participant > 0) {
        badges.push('<span class="badge monthly">üí¨ Debate Participation</span>');
      }
      // Check for debate_winner badge - show if entry exists (even with 0 points for winners who got prize)
      const hasDebateWinnerEntry = member.recent_entries?.some(entry => entry.criteria === 'debate_winner') || 
                                   (member.points_breakdown?.debate_winner !== undefined && member.points_breakdown.debate_winner >= 0);
      if (hasDebateWinnerEntry) {
        badges.push('<span class="badge monthly">ü§º‚Äç‚ôÇÔ∏è Debate Winner</span>');
      }
      if (member.points_breakdown?.meeting_attendance > 0) {
        badges.push('<span class="badge monthly">üìç Attendee</span>');
      }
      
      // Quarterly badges
      const quarterlyBadges = await getQuarterlyAttendanceBadges(member);
      quarterlyBadges.forEach(badge => {
        badges.push(`<span class="badge quarterly">${badge}</span>`);
      });
      
      // QA Consistent badge - if member has all 4 Regular badges (Q1, Q2, Q3, Q4)
      if (Array.isArray(quarterlyBadges)) {
        const hasQ1 = quarterlyBadges.some(b => b.includes('Q1 Regular'));
        const hasQ2 = quarterlyBadges.some(b => b.includes('Q2 Regular'));
        const hasQ3 = quarterlyBadges.some(b => b.includes('Q3 Regular'));
        const hasQ4 = quarterlyBadges.some(b => b.includes('Q4 Regular'));
        if (hasQ1 && hasQ2 && hasQ3 && hasQ4) {
          badges.push('<span class="badge top-member">üß≠ QA Consistent</span>');
        }
      }
      
      // Quarterly Speaker badges (Q1, Q2, Q3, Q4 Speaker)
      const quarterlySpeakerBadges = await getQuarterlySpeakerBadges(member);
      quarterlySpeakerBadges.forEach(badge => {
        badges.push(`<span class="badge quarterly">${badge}</span>`);
      });
      
      // Manual badges (added through badge management)
      const manualBadges = await getManualBadges(member);
      manualBadges.forEach(badge => {
        badges.push(`<span class="badge monthly">${badge}</span>`);
      });
      
      return badges.join('');
    }

    async function getManualBadges(member) {
      try {
        // Get all points entries for this member
        const pointsEntries = await apiGet('/api/rewards/points');
        const customBadges = await apiGet('/api/rewards/badges');
        
        const memberEntries = pointsEntries.filter(entry => 
          entry.member_email?.toLowerCase() === member.email?.toLowerCase() &&
          entry.criteria === 'badge_award'
        );
        
        // Extract unique badge names from entries and verify they still exist
        const badgeNames = [...new Set(memberEntries.map(entry => {
          // Extract badge name from reason (format: "Badge awarded: üèÜ Quiz Champion")
          const match = entry.reason.match(/Badge awarded: (.+)/);
          if (!match) return null;
          
          const badgeName = match[1];
          
          // Check if it's a custom badge that still exists
          const isCustomBadge = customBadges.some(badge => 
            `${badge.icon} ${badge.name}` === badgeName
          );
          
          // If it's a custom badge, only include it if it still exists
          if (isCustomBadge) {
            return customBadges.some(badge => `${badge.icon} ${badge.name}` === badgeName) ? badgeName : null;
          }
          
          // For predefined badges, always include them
          return badgeName;
        }).filter(Boolean))];
        
        return badgeNames;
      } catch (error) {
        console.error('Error getting manual badges:', error);
        return [];
      }
    }

    function calculateActualRank(member, memberIndex) {
      // Find all members with the same points as current member
      const samePointsMembers = LEADERBOARD_DATA.filter(m => m.total_points === member.total_points);
      
      if (samePointsMembers.length === 1) {
        const rank = memberIndex + 1;
        console.log(`Single member with ${member.total_points} points: rank ${rank}`);
        return rank;
      }
      
      // Find the first member with same points to get the rank
      const firstSamePointsIndex = LEADERBOARD_DATA.findIndex(m => m.total_points === member.total_points);
      const rank = firstSamePointsIndex + 1;
      console.log(`Multiple members with ${member.total_points} points: first at index ${firstSamePointsIndex}, rank ${rank}`);
      return rank;
    }

    function getTop5Ranks() {
      // Get unique point values sorted in descending order
      const uniquePoints = [...new Set(LEADERBOARD_DATA.map(m => m.total_points))].sort((a, b) => b - a);
      
      // Take only the first 5 unique point values
      const top5Points = uniquePoints.slice(0, 5);
      
      console.log('Top 5 unique points:', top5Points);
      
      return top5Points;
    }

    async function getQuarterlyAttendanceBadges(member) {
      try {
        // Load meetings data from API
        const meetings = await apiGet('/api/meetings');
        
        // Use isFinished function to determine completed meetings
        const completedMeetings = meetings.filter(m => isFinished(m));
        
        if (completedMeetings.length === 0) return [];
        
        // Group meetings by quarter
        const quarters = {};
        completedMeetings.forEach(meeting => {
          const date = new Date(meeting.date);
          const year = date.getFullYear();
          const month = date.getMonth() + 1; // 1-12
          const quarter = Math.ceil(month / 3); // 1-4
          const quarterKey = `${year}-Q${quarter}`;
          
          if (!quarters[quarterKey]) {
            quarters[quarterKey] = [];
          }
          quarters[quarterKey].push(meeting);
        });
        
        const badges = [];
        
        // Check if member attended all meetings in each quarter
        const quarterResults = [];
        for (const [quarterKey, quarterMeetings] of Object.entries(quarters)) {
          if (quarterMeetings.length === 0) continue;
          
          let attendedAll = true;
          
          for (const meeting of quarterMeetings) {
            const participant = meeting.participants?.find(p => 
              p.email?.toLowerCase() === member.email?.toLowerCase()
            );
            if (!participant || !participant.present) {
              attendedAll = false;
              break;
            }
          }
          
          if (attendedAll && quarterMeetings.length > 0) {
            // Extract quarter number from quarterKey (e.g., "2025-Q1" -> "Q1")
            const quarterNumber = quarterKey.split('-')[1]; // Gets "Q1", "Q2", etc.
            const quarterNum = parseInt(quarterNumber.replace('Q', ''));
            quarterResults.push({ quarter: quarterNum, badge: `‚úÖ ${quarterNumber} Regular` });
          }
        }
        
        // Sort by quarter number and add to badges
        quarterResults.sort((a, b) => a.quarter - b.quarter);
        quarterResults.forEach(result => {
          badges.push(result.badge);
        });
        
        return badges;
      } catch (error) {
        console.error('Error checking quarterly attendance:', error);
        return [];
      }
    }

    async function getQuarterlySpeakerBadges(member) {
      try {
        // Load meetings data from API
        const meetings = await apiGet('/api/meetings');
        
        // Load points entries once (optimization)
        let pointsEntries = [];
        try {
          pointsEntries = await apiGet('/api/rewards/points');
        } catch (e) {
          // If API call fails, continue with agenda check only
        }
        
        // Use isFinished function to determine completed meetings
        const completedMeetings = meetings.filter(m => isFinished(m));
        
        if (completedMeetings.length === 0) return [];
        
        // Group meetings by quarter
        const quarters = {};
        completedMeetings.forEach(meeting => {
          const date = new Date(meeting.date);
          const year = date.getFullYear();
          const month = date.getMonth() + 1; // 1-12
          const quarter = Math.ceil(month / 3); // 1-4
          const quarterKey = `${year}-Q${quarter}`;
          
          if (!quarters[quarterKey]) {
            quarters[quarterKey] = [];
          }
          quarters[quarterKey].push(meeting);
        });
        
        const badges = [];
        const memberEmail = (member.email || '').toLowerCase();
        
        // Check if member presented in all meetings in each quarter
        const quarterResults = [];
        for (const [quarterKey, quarterMeetings] of Object.entries(quarters)) {
          if (quarterMeetings.length === 0) continue;
          
          let presentedInAll = true;
          
          for (const meeting of quarterMeetings) {
            // Check if member presented in this meeting
            // Method 1: Check agenda items with owner
            const agenda = meeting.agenda || [];
            let hasPresentation = false;
            
            for (const agendaItem of agenda) {
              const owner = (agendaItem.owner || '').toLowerCase();
              if (owner === memberEmail) {
                // Verify member was present at this meeting
                const participant = meeting.participants?.find(p => 
                  p.email?.toLowerCase() === memberEmail
                );
                if (participant && participant.present) {
                  hasPresentation = true;
                  break;
                }
              }
            }
            
            // Method 2: Also check points entries for presentation (in case agenda owner is missing but points exist)
            if (!hasPresentation && pointsEntries.length > 0) {
              const meetingId = meeting.id;
              const presentationEntry = pointsEntries.find(entry => 
                entry.member_email?.toLowerCase() === memberEmail &&
                entry.criteria === 'presentation' &&
                entry.meeting_id === meetingId
              );
              if (presentationEntry) {
                hasPresentation = true;
              }
            }
            
            if (!hasPresentation) {
              presentedInAll = false;
              break;
            }
          }
          
          if (presentedInAll && quarterMeetings.length > 0) {
            // Extract quarter number from quarterKey (e.g., "2025-Q1" -> "Q1")
            const quarterNumber = quarterKey.split('-')[1]; // Gets "Q1", "Q2", etc.
            const quarterNum = parseInt(quarterNumber.replace('Q', ''));
            quarterResults.push({ quarter: quarterNum, badge: `üéôÔ∏è ${quarterNumber} Speaker` });
          }
        }
        
        // Sort by quarter number and add to badges
        quarterResults.sort((a, b) => a.quarter - b.quarter);
        quarterResults.forEach(result => {
          badges.push(result.badge);
        });
        
        return badges;
      } catch (error) {
        console.error('Error checking quarterly speaker badges:', error);
        return [];
      }
    }

    async function showMemberDetails(memberEmail) {
      try {
        // Get member details from leaderboard data
        const member = LEADERBOARD_DATA.find(m => m.email === memberEmail);
        if (!member) {
          alert('Member not found');
          return;
        }

        // Get detailed points entries
        const response = await fetch('/api/rewards/points');
        const allEntries = await response.json();
        const memberEntries = allEntries.filter(entry => entry.member_email === memberEmail);

        // Generate earned badges only
        const earnedBadgesHTML = await generateEarnedBadges(member);

        // Create modal content
        const modal = document.createElement('div');
        modal.className = 'member-details';
        modal.innerHTML = `
          <div class="member-details-content">
            <div class="member-details-header">
              <h2 class="member-details-title">${member.name}</h2>
              <button class="close-btn" onclick="closeMemberDetails()">‚úï</button>
            </div>
            
            <div class="points-breakdown">
              <h3>Points Breakdown</h3>
              ${Object.entries(member.points_breakdown || {}).map(([category, points]) => `
                <div class="points-category">
                  <span class="points-category-name">${formatCategoryName(category)}</span>
                  <span class="points-category-value">${points} pts</span>
                </div>
              `).join('')}
            </div>

            <div class="badges-section">
              <h3>Badges</h3>
              <div class="badges-grid">
                ${earnedBadgesHTML}
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error showing member details:', error);
        alert('Error loading member details: ' + error.message);
      }
    }

    function closeMemberDetails() {
      const modal = document.querySelector('.member-details');
      if (modal) {
        modal.remove();
      }
    }

    // Member Edit Modal Functions
    let currentEditingMember = null;

    function openMemberEditModal(member) {
      currentEditingMember = member;
      
      // Populate form with current member data
      document.getElementById('editMemberName').value = member.name || '';
      document.getElementById('editMemberEmail').value = member.email || '';
      document.getElementById('editMemberStudio').value = member.studio || 'CC';
      document.getElementById('editMemberStatus').value = member.status || 'active';
      document.getElementById('editMemberClanLead').checked = member.clan_lead || false;
      document.getElementById('editMemberExternal').checked = member.external || false;
      
      // Show modal
      document.getElementById('memberEditModal').style.display = 'block';
    }

    function closeMemberEditModal() {
      document.getElementById('memberEditModal').style.display = 'none';
      currentEditingMember = null;
    }

    // Handle form submission
    document.getElementById('memberEditForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentEditingMember) return;
      
      const formData = {
        name: document.getElementById('editMemberName').value.trim(),
        email: document.getElementById('editMemberEmail').value.trim(),
        studio: document.getElementById('editMemberStudio').value,
        status: document.getElementById('editMemberStatus').value,
        clan_lead: document.getElementById('editMemberClanLead').checked,
        external: document.getElementById('editMemberExternal').checked
      };
      
      if (!formData.name || !formData.email) {
        alert('Please fill in name and email');
        return;
      }
      
      try {
        await apiSend(`/api/members/${currentEditingMember._i}`, 'PUT', formData);
        await loadMembers();
        await loadParticipants(true);
        refreshAgendaOwnerOptions();
        closeMemberEditModal();
      } catch (error) {
        alert('Error editing member: ' + error.message);
      }
    });

    // Close modal when clicking outside
    document.getElementById('memberEditModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMemberEditModal();
      }
    });

    // Badge Management Functions
    async function populateBadgeMemberSelect() {
      try {
        const members = await apiGet('/api/members');
        const select = document.getElementById('badgeMemberSelect');
        select.innerHTML = '<option value="">Select member...</option>';
        
        members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.email;
          option.textContent = `${member.name} (${member.email})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading members for badge selection:', error);
      }
    }

    async function addBadgeToMember() {
      const memberEmail = document.getElementById('badgeMemberSelect').value;
      const badgeName = document.getElementById('badgeSelect').value;
      
      if (!memberEmail || !badgeName) {
        alert('Please select both a member and a badge');
        return;
      }
      
      try {
        // Get badge points from the badge name
        const badgePoints = getBadgePoints(badgeName);
        const reason = `Badge awarded: ${badgeName}`;
        
        await apiSend('/api/rewards/points', 'POST', {
          member_email: memberEmail,
          points: badgePoints,
          reason: reason,
          criteria: 'badge_award'
        });
        
        alert(`‚úÖ Badge "${badgeName}" added to member!`);
        
        // Clear form
        document.getElementById('badgeMemberSelect').value = '';
        document.getElementById('badgeSelect').value = '';
        
        // Refresh leaderboard
        await loadLeaderboard();
      } catch (error) {
        alert('‚ùå Error adding badge: ' + error.message);
      }
    }
    async function removeBadgeFromMember() {
      const memberEmail = document.getElementById('badgeMemberSelect').value;
      const badgeName = document.getElementById('badgeSelect').value;
      
      if (!memberEmail || !badgeName) {
        alert('Please select both a member and a badge');
        return;
      }
      
      if (!confirm(`Are you sure you want to remove the "${badgeName}" badge from this member?`)) {
        return;
      }
      
      try {
        // Get all points entries for this member
        const pointsEntries = await apiGet('/api/rewards/points');
        const memberEntries = pointsEntries.filter(entry => 
          entry.member_email?.toLowerCase() === memberEmail.toLowerCase() &&
          entry.reason === `Badge awarded: ${badgeName}`
        );
        
        if (memberEntries.length === 0) {
          alert('‚ùå No badge entries found for this member and badge combination');
          return;
        }
        
        // Delete all matching entries
        for (const entry of memberEntries) {
          await apiSend(`/api/rewards/points/${entry.id}`, 'DELETE');
        }
        
        alert(`‚úÖ Badge "${badgeName}" removed from member!`);
        
        // Clear form
        document.getElementById('badgeMemberSelect').value = '';
        document.getElementById('badgeSelect').value = '';
        
        // Refresh leaderboard
        await loadLeaderboard();
      } catch (error) {
        alert('‚ùå Error removing badge: ' + error.message);
      }
    }

    function getBadgePoints(badgeName) {
      // Monthly badges with points
      const monthlyBadges = {
        'üìç QA Attendee': 5,
        'üì¢ QA Speaker': 15,
        'üÜï First-Time Speaker': 15,
        'üß† Quiz Addict': 10,
        'üèÜ Quiz Champion': 20,
        'üöÄ QA Initiator': 10,
        '‚úçÔ∏è Knowledge Dropper': 5,
        'üõ†Ô∏è Extra Mile': 5,
        'üí¨ Debate Participation': 5,
        'ü§º‚Äç‚ôÇÔ∏è Debate Winner': 15,
        'üßë‚Äçüè´ QA Mentor': 10
      };
      
      // Quarterly and Top Members badges (no points, just recognition)
      const quarterlyBadges = [
        '‚úÖ Q1 Regular', '‚úÖ Q2 Regular', '‚úÖ Q3 Regular', '‚úÖ Q4 Regular',
        'üéôÔ∏è Q1 Speaker', 'üéôÔ∏è Q2 Speaker', 'üéôÔ∏è Q3 Speaker', 'üéôÔ∏è Q4 Speaker',
        'üß† Quarter Quizzer', 'ü•á Quarter Quiz Champ',
        'üöÄ Quarter Initiator', 'üìö Content Crafter', 'üëë The Complete QA', 'üìò QA Mentor Pillar'
      ];
      
      const topMemberBadges = [
        'üëë QA Legend', 'üíé QA Platinum', 'ü•á QA Gold', 'ü•à QA Silver', 'ü•â QA Bronze',
        'üß≠ QA Consistent', 'üõ°Ô∏è QA Pillar', 'üß† QA Knowledge Hero', 'üéØ QA Completionist'
      ];
      
      if (monthlyBadges[badgeName]) {
        return monthlyBadges[badgeName];
      } else if (quarterlyBadges.includes(badgeName) || topMemberBadges.includes(badgeName)) {
        return 0; // Recognition badges don't give points
      }
      
      return 5; // Default points for unknown badges
    }

    // Custom Badge Management Functions
    async function loadCustomBadges() {
      try {
        const badges = await apiGet('/api/rewards/badges');
        const container = document.getElementById('customBadgesList');
        
        if (badges.length === 0) {
          container.innerHTML = '<div class="muted">No custom badges created yet</div>';
          return;
        }
        
        container.innerHTML = badges.map(badge => `
          <div class="criteria-item">
            <div class="criteria-info">
              <span class="badge-icon">${badge.icon}</span>
              <span class="criteria-name">${badge.name}</span>
              <span class="criteria-points">${badge.points} pts</span>
              <span class="criteria-category">${badge.category}</span>
            </div>
            <div class="criteria-actions">
              <button class="btn danger" onclick="deleteCustomBadge(${badge.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading custom badges:', error);
        document.getElementById('customBadgesList').innerHTML = '<div class="error">Error loading custom badges</div>';
      }
    }

    async function addNewBadge() {
      const icon = document.getElementById('newBadgeIcon').value.trim();
      const name = document.getElementById('newBadgeName').value.trim();
      const points = parseInt(document.getElementById('newBadgePoints').value) || 0;
      const category = document.getElementById('newBadgeCategory').value;
      
      if (!icon || !name) {
        alert('Please fill in icon and name');
        return;
      }
      
      try {
        await apiSend('/api/rewards/badges', 'POST', {
          icon: icon,
          name: name,
          points: points,
          category: category
        });
        
        alert('‚úÖ Custom badge created successfully!');
        
        // Clear form
        document.getElementById('newBadgeIcon').value = '';
        document.getElementById('newBadgeName').value = '';
        document.getElementById('newBadgePoints').value = '0';
        document.getElementById('newBadgeCategory').value = 'monthly';
        
        // Reload badges
        await loadCustomBadges();
        await populateBadgeSelect();
      } catch (error) {
        alert('‚ùå Error creating badge: ' + error.message);
      }
    }

    async function deleteCustomBadge(badgeId) {
      if (!confirm('Are you sure you want to delete this custom badge? This will also remove it from all members who have it.')) {
        return;
      }
      
      try {
        // First get the badge details to know what to clean up
        const customBadges = await apiGet('/api/rewards/badges');
        const badgeToDelete = customBadges.find(b => b.id === badgeId);
        
        if (badgeToDelete) {
          // Delete all point entries for this badge
          const pointsEntries = await apiGet('/api/rewards/points');
          const badgeEntries = pointsEntries.filter(entry => 
            entry.criteria === 'badge_award' && 
            entry.reason.includes(`Badge awarded: ${badgeToDelete.icon} ${badgeToDelete.name}`)
          );
          
          // Delete each point entry
          for (const entry of badgeEntries) {
            await apiSend(`/api/rewards/points/${entry.id}`, 'DELETE');
          }
        }
        
        // Delete the badge itself
        await apiSend(`/api/rewards/badges/${badgeId}`, 'DELETE');
        alert('‚úÖ Custom badge deleted successfully!');
        
        // Reload everything
        await loadCustomBadges();
        await populateBadgeSelect();
        await loadLeaderboard(); // Refresh leaderboard to remove deleted badges
      } catch (error) {
        alert('‚ùå Error deleting badge: ' + error.message);
      }
    }

    async function populateBadgeSelect() {
      try {
        const customBadges = await apiGet('/api/rewards/badges');
        const select = document.getElementById('badgeSelect');
        
        // Clear existing options except the first one
        select.innerHTML = '<option value="">Select badge...</option>';
        
        // Add optgroups for existing badges
        const monthlyGroup = document.createElement('optgroup');
        monthlyGroup.label = 'Monthly Badges';
        monthlyGroup.innerHTML = `
          <option value="üìç QA Attendee">üìç QA Attendee (5p)</option>
          <option value="üì¢ QA Speaker">üì¢ QA Speaker (15p)</option>
          <option value="üÜï First-Time Speaker">üÜï First-Time Speaker (15p)</option>
          <option value="üß† Quiz Addict">üß† Quiz Addict (10p)</option>
          <option value="üèÜ Quiz Champion">üèÜ Quiz Champion (20p)</option>
          <option value="üöÄ QA Initiator">üöÄ QA Initiator (10p)</option>
          <option value="‚úçÔ∏è Knowledge Dropper">‚úçÔ∏è Knowledge Dropper (5p)</option>
          <option value="üõ†Ô∏è Extra Mile">üõ†Ô∏è Extra Mile (5p)</option>
          <option value="üí¨ Debate Participation">üí¨ Debate Participation (5p)</option>
          <option value="ü§º‚Äç‚ôÇÔ∏è Debate Winner">ü§º‚Äç‚ôÇÔ∏è Debate Winner (15p)</option>
          <option value="üßë‚Äçüè´ QA Mentor">üßë‚Äçüè´ QA Mentor (10p)</option>
        `;
        
        // Add custom monthly badges
        customBadges.filter(b => b.category === 'monthly').forEach(badge => {
          const option = document.createElement('option');
          option.value = `${badge.icon} ${badge.name}`;
          option.textContent = `${badge.icon} ${badge.name} (${badge.points}p)`;
          monthlyGroup.appendChild(option);
        });
        
        select.appendChild(monthlyGroup);
        
        // Add other groups...
        const quarterlyGroup = document.createElement('optgroup');
        quarterlyGroup.label = 'Quarterly Badges';
        quarterlyGroup.innerHTML = `
          <option value="‚úÖ Q1 Regular">‚úÖ Q1 Regular</option>
          <option value="‚úÖ Q2 Regular">‚úÖ Q2 Regular</option>
          <option value="‚úÖ Q3 Regular">‚úÖ Q3 Regular</option>
          <option value="‚úÖ Q4 Regular">‚úÖ Q4 Regular</option>
          <option value="üéôÔ∏è Q1 Speaker">üéôÔ∏è Q1 Speaker</option>
          <option value="üéôÔ∏è Q2 Speaker">üéôÔ∏è Q2 Speaker</option>
          <option value="üéôÔ∏è Q3 Speaker">üéôÔ∏è Q3 Speaker</option>
          <option value="üéôÔ∏è Q4 Speaker">üéôÔ∏è Q4 Speaker</option>
          <option value="üß† Quarter Quizzer">üß† Quarter Quizzer</option>
          <option value="ü•á Quarter Quiz Champ">ü•á Quarter Quiz Champ</option>
          <option value="üöÄ Quarter Initiator">üöÄ Quarter Initiator</option>
          <option value="üìö Content Crafter">üìö Content Crafter</option>
          <option value="üëë The Complete QA">üëë The Complete QA</option>
          <option value="üìò QA Mentor Pillar">üìò QA Mentor Pillar</option>
        `;
        
        // Add custom quarterly badges
        customBadges.filter(b => b.category === 'quarterly').forEach(badge => {
          const option = document.createElement('option');
          option.value = `${badge.icon} ${badge.name}`;
          option.textContent = `${badge.icon} ${badge.name}`;
          quarterlyGroup.appendChild(option);
        });
        
        select.appendChild(quarterlyGroup);
        
        const topMemberGroup = document.createElement('optgroup');
        topMemberGroup.label = 'Top Members Badges';
        topMemberGroup.innerHTML = `
          <option value="üëë QA Legend">üëë QA Legend</option>
          <option value="üíé QA Platinum">üíé QA Platinum</option>
          <option value="ü•á QA Gold">ü•á QA Gold</option>
          <option value="ü•à QA Silver">ü•à QA Silver</option>
          <option value="ü•â QA Bronze">ü•â QA Bronze</option>
          <option value="üß≠ QA Consistent">üß≠ QA Consistent</option>
          <option value="üõ°Ô∏è QA Pillar">üõ°Ô∏è QA Pillar</option>
          <option value="üß† QA Knowledge Hero">üß† QA Knowledge Hero</option>
          <option value="üéØ QA Completionist">üéØ QA Completionist</option>
        `;
        
        // Add custom top member badges
        customBadges.filter(b => b.category === 'top-member').forEach(badge => {
          const option = document.createElement('option');
          option.value = `${badge.icon} ${badge.name}`;
          option.textContent = `${badge.icon} ${badge.name}`;
          topMemberGroup.appendChild(option);
        });
        
        select.appendChild(topMemberGroup);
        
      } catch (error) {
        console.error('Error populating badge select:', error);
      }
    }

    // Emoji Picker Functions
    function openEmojiPicker() {
      const emojiGrid = document.getElementById('emojiGrid');
      if (!emojiGrid) {
        console.error('emojiGrid element not found');
        alert('Emoji picker element not found. Please refresh the page.');
        return;
      }
      
      // Force show/hide using inline style
      const isCurrentlyHidden = emojiGrid.style.display === 'none' || 
                                window.getComputedStyle(emojiGrid).display === 'none';
      
      if (isCurrentlyHidden) {
        emojiGrid.style.display = 'block';
        emojiGrid.style.visibility = 'visible';
        emojiGrid.style.opacity = '1';
      } else {
        emojiGrid.style.display = 'none';
      }
    }

    function selectEmoji(emoji) {
      document.getElementById('newBadgeIcon').value = emoji;
      document.getElementById('emojiGrid').style.display = 'none';
    }


    function formatCategoryName(category) {
      const names = {
        'meeting_attendance': 'Meeting Attendance',
        'presentation': 'Presentations',
        'debate_participant': 'Debate Participation',
        'debate_winner': 'Debate Wins',
        'manual': 'Manual Awards'
      };
      return names[category] || category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    async function generateAllBadges(member, entries) {
      // Get top 5 unique point values
      const top5Points = getTop5Ranks();
      
      // Find which rank tier this member belongs to (1-5)
      const rankTier = top5Points.indexOf(member.total_points) + 1;
      
      // Get quarterly attendance badges
      const quarterlyBadges = await getQuarterlyAttendanceBadges(member);
      // Get quarterly speaker badges
      const quarterlySpeakerBadges = await getQuarterlySpeakerBadges(member);
      
      const badges = [
        // Monthly Badges
        { icon: 'üìç', name: 'QA Attendee', description: 'Attended the meeting', earned: member.points_breakdown?.meeting_attendance > 0 },
        { icon: 'üì¢', name: 'QA Speaker', description: 'Gave a presentation', earned: member.points_breakdown?.presentation >= 30 },
        { icon: 'üÜï', name: 'First-Time Speaker', description: 'Gave their first-ever presentation', earned: member.points_breakdown?.presentation >= 15 },
        { icon: 'üß†', name: 'Quiz Addict', description: 'Participated in the quiz', earned: false },
        { icon: 'üèÜ', name: 'Quiz Champion', description: 'Won the quiz', earned: false },
        { icon: 'üöÄ', name: 'QA Initiator', description: 'Launched or proposed an initiative', earned: false },
        { icon: '‚úçÔ∏è', name: 'Knowledge Dropper', description: 'Contributed valuable resources', earned: false },
        { icon: 'üõ†Ô∏è', name: 'Extra Mile', description: 'Other valuable contributions', earned: false },
        { icon: 'üí¨', name: 'Debate Participation', description: 'Participated in debate', earned: member.points_breakdown?.debate_participant > 0 },
        { icon: 'ü§º‚Äç‚ôÇÔ∏è', name: 'Debate Winner', description: 'Won the debate', earned: member.recent_entries?.some(entry => entry.criteria === 'debate_winner') || (member.points_breakdown?.debate_winner !== undefined && member.points_breakdown.debate_winner >= 0) },
        { icon: 'üßë‚Äçüè´', name: 'QA Mentor', description: 'Mentor for other member', earned: false },
        
        // Quarterly Badges
        { icon: '‚úÖ', name: 'Q1 Regular', description: 'Attended all meetings in Q1', earned: quarterlyBadges.some(b => b.includes('Q1 Regular')) },
        { icon: '‚úÖ', name: 'Q2 Regular', description: 'Attended all meetings in Q2', earned: quarterlyBadges.some(b => b.includes('Q2 Regular')) },
        { icon: '‚úÖ', name: 'Q3 Regular', description: 'Attended all meetings in Q3', earned: quarterlyBadges.some(b => b.includes('Q3 Regular')) },
        { icon: '‚úÖ', name: 'Q4 Regular', description: 'Attended all meetings in Q4', earned: quarterlyBadges.some(b => b.includes('Q4 Regular')) },
        { icon: 'üéôÔ∏è', name: 'Q1 Speaker', description: 'Presented in all Q1 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q1 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q2 Speaker', description: 'Presented in all Q2 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q2 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q3 Speaker', description: 'Presented in all Q3 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q3 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q4 Speaker', description: 'Presented in all Q4 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q4 Speaker')) },
        { icon: 'üß†', name: 'Quarter Quizzer', description: 'Participated in all quizzes', earned: false },
        { icon: 'ü•á', name: 'Quarter Quiz Champ', description: 'Won the most quizzes', earned: false },
        { icon: 'üöÄ', name: 'Quarter Initiator', description: 'Proposed at least 1 initiative per month', earned: false },
        { icon: 'üìö', name: 'Content Crafter', description: 'Contributed resources every month', earned: false },
        { icon: 'üëë', name: 'The Complete QA', description: 'Completed all activities every month', earned: false },
        { icon: 'üìò', name: 'QA Mentor Pillar', description: 'Provided mentorship in every meeting', earned: false },
        
        // Top Members Badges - based on rank tier (1-5)
        { icon: 'üëë', name: 'QA Legend', description: 'Top 1 all-time by points', earned: rankTier === 1 },
        { icon: 'üíé', name: 'QA Platinum', description: '2nd place', earned: rankTier === 2 },
        { icon: 'ü•á', name: 'QA Gold', description: '3rd place', earned: rankTier === 3 },
        { icon: 'ü•à', name: 'QA Silver', description: '4th place', earned: rankTier === 4 },
        { icon: 'ü•â', name: 'QA Bronze', description: '5th place', earned: rankTier === 5 },
        { icon: 'üß≠', name: 'QA Consistent', description: 'Participated in all meetings during the year', earned: (() => {
          if (!Array.isArray(quarterlyBadges)) return false;
          const hasQ1 = quarterlyBadges.some(b => b.includes('Q1 Regular'));
          const hasQ2 = quarterlyBadges.some(b => b.includes('Q2 Regular'));
          const hasQ3 = quarterlyBadges.some(b => b.includes('Q3 Regular'));
          const hasQ4 = quarterlyBadges.some(b => b.includes('Q4 Regular'));
          return hasQ1 && hasQ2 && hasQ3 && hasQ4;
        })() },
        { icon: 'üõ°Ô∏è', name: 'QA Pillar', description: 'Active in all quarters during the year', earned: false },
        { icon: 'üß†', name: 'QA Knowledge Hero', description: 'Contributed the most presentations', earned: false },
        { icon: 'üéØ', name: 'QA Completionist', description: 'Earned at least 1 different badge every month', earned: false }
      ];

      return badges.map(badge => `
        <div class="badge-item ${badge.earned ? 'earned' : ''}">
          <div class="badge-icon">${badge.icon}</div>
          <div class="badge-info">
            <div class="badge-name">${badge.name}</div>
            <div class="badge-description">${badge.description}</div>
          </div>
        </div>
      `).join('');
    }

    async function generateEarnedBadges(member) {
      // Get top 5 unique point values
      const top5Points = getTop5Ranks();
      
      // Find which rank tier this member belongs to (1-5)
      const rankTier = top5Points.indexOf(member.total_points) + 1;
      
      // Get quarterly attendance badges
      const quarterlyBadges = await getQuarterlyAttendanceBadges(member);
      // Get quarterly speaker badges
      const quarterlySpeakerBadges = await getQuarterlySpeakerBadges(member);
      
      const badges = [
        // Monthly Badges
        { icon: 'üìç', name: 'QA Attendee', description: 'Attended the meeting', earned: member.points_breakdown?.meeting_attendance > 0 },
        { icon: 'üì¢', name: 'QA Speaker', description: 'Gave a presentation', earned: member.points_breakdown?.presentation >= 30 },
        { icon: 'üÜï', name: 'First-Time Speaker', description: 'Gave their first-ever presentation', earned: member.points_breakdown?.presentation >= 15 },
        { icon: 'üß†', name: 'Quiz Addict', description: 'Participated in the quiz', earned: false },
        { icon: 'üèÜ', name: 'Quiz Champion', description: 'Won the quiz', earned: false },
        { icon: 'üöÄ', name: 'QA Initiator', description: 'Launched or proposed an initiative', earned: false },
        { icon: '‚úçÔ∏è', name: 'Knowledge Dropper', description: 'Contributed valuable resources', earned: false },
        { icon: 'üõ†Ô∏è', name: 'Extra Mile', description: 'Other valuable contributions', earned: false },
        { icon: 'üí¨', name: 'Debate Participation', description: 'Participated in debate', earned: member.points_breakdown?.debate_participant > 0 },
        { icon: 'ü§º‚Äç‚ôÇÔ∏è', name: 'Debate Winner', description: 'Won the debate', earned: member.recent_entries?.some(entry => entry.criteria === 'debate_winner') || (member.points_breakdown?.debate_winner !== undefined && member.points_breakdown.debate_winner >= 0) },
        { icon: 'üßë‚Äçüè´', name: 'QA Mentor', description: 'Mentor for other member', earned: false },
        
        // Quarterly Badges
        { icon: '‚úÖ', name: 'Q1 Regular', description: 'Attended all meetings in Q1', earned: quarterlyBadges.some(b => b.includes('Q1 Regular')) },
        { icon: '‚úÖ', name: 'Q2 Regular', description: 'Attended all meetings in Q2', earned: quarterlyBadges.some(b => b.includes('Q2 Regular')) },
        { icon: '‚úÖ', name: 'Q3 Regular', description: 'Attended all meetings in Q3', earned: quarterlyBadges.some(b => b.includes('Q3 Regular')) },
        { icon: '‚úÖ', name: 'Q4 Regular', description: 'Attended all meetings in Q4', earned: quarterlyBadges.some(b => b.includes('Q4 Regular')) },
        { icon: 'üéôÔ∏è', name: 'Q1 Speaker', description: 'Presented in all Q1 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q1 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q2 Speaker', description: 'Presented in all Q2 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q2 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q3 Speaker', description: 'Presented in all Q3 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q3 Speaker')) },
        { icon: 'üéôÔ∏è', name: 'Q4 Speaker', description: 'Presented in all Q4 meetings', earned: quarterlySpeakerBadges.some(b => b.includes('Q4 Speaker')) },
        { icon: 'üß†', name: 'Quarter Quizzer', description: 'Participated in all quizzes', earned: false },
        { icon: 'ü•á', name: 'Quarter Quiz Champ', description: 'Won the most quizzes', earned: false },
        { icon: 'üöÄ', name: 'Quarter Initiator', description: 'Proposed at least 1 initiative per month', earned: false },
        { icon: 'üìö', name: 'Content Crafter', description: 'Contributed resources every month', earned: false },
        { icon: 'üëë', name: 'The Complete QA', description: 'Completed all activities every month', earned: false },
        { icon: 'üìò', name: 'QA Mentor Pillar', description: 'Provided mentorship in every meeting', earned: false },
        
        // Top Members Badges - based on rank tier (1-5)
        { icon: 'üëë', name: 'QA Legend', description: 'Top 1 all-time by points', earned: rankTier === 1 },
        { icon: 'üíé', name: 'QA Platinum', description: '2nd place', earned: rankTier === 2 },
        { icon: 'ü•á', name: 'QA Gold', description: '3rd place', earned: rankTier === 3 },
        { icon: 'ü•à', name: 'QA Silver', description: '4th place', earned: rankTier === 4 },
        { icon: 'ü•â', name: 'QA Bronze', description: '5th place', earned: rankTier === 5 },
        { icon: 'üß≠', name: 'QA Consistent', description: 'Participated in all meetings during the year', earned: (() => {
          if (!Array.isArray(quarterlyBadges)) return false;
          const hasQ1 = quarterlyBadges.some(b => b.includes('Q1 Regular'));
          const hasQ2 = quarterlyBadges.some(b => b.includes('Q2 Regular'));
          const hasQ3 = quarterlyBadges.some(b => b.includes('Q3 Regular'));
          const hasQ4 = quarterlyBadges.some(b => b.includes('Q4 Regular'));
          return hasQ1 && hasQ2 && hasQ3 && hasQ4;
        })() },
        { icon: 'üõ°Ô∏è', name: 'QA Pillar', description: 'Active in all quarters during the year', earned: false },
        { icon: 'üß†', name: 'QA Knowledge Hero', description: 'Contributed the most presentations', earned: false },
        { icon: 'üéØ', name: 'QA Completionist', description: 'Earned at least 1 different badge every month', earned: false }
      ];

      // Filter only earned badges
      const earnedBadges = badges.filter(badge => badge.earned);

      // Also get manual badges
      const manualBadges = await getManualBadges(member);
      manualBadges.forEach(badgeName => {
        // Extract icon and name from badge string (format: "icon Name")
        const parts = badgeName.trim().split(/\s+/);
        const icon = parts[0];
        const name = parts.slice(1).join(' ');
        earnedBadges.push({ icon, name, description: 'Custom badge', earned: true });
      });

      return earnedBadges.map(badge => `
        <div class="badge-item earned">
          <div class="badge-icon">${badge.icon}</div>
          <div class="badge-info">
            <div class="badge-name">${badge.name}</div>
            <div class="badge-description">${badge.description}</div>
          </div>
        </div>
      `).join('');
    }

  </script>
</body>
</html>